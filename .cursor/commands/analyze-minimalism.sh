#!/bin/bash
# –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–Ω—Ü–∏–ø–∞ –º–∏–Ω–∏–º–∞–ª–∏–∑–º–∞ –≤ –∫–æ–¥–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π rpi-image-gen
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Cursor Tasks –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

set -euo pipefail

echo "=== –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–Ω—Ü–∏–ø–∞ –º–∏–Ω–∏–º–∞–ª–∏–∑–º–∞ ==="

# 1. –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
echo "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞:"
total_lines=$(find layer/ -name '*.yaml' -exec wc -l {} \; | awk '{sum += $1} END {print sum}')
echo "$total_lines —Å—Ç—Ä–æ–∫"

# 2. –ü–æ–∏—Å–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ apt-get install)
echo -e "\n–ü–æ–∏—Å–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞:"
duplicates=$(find layer/ -name '*.yaml' -exec grep -h 'apt-get install' {} \; | sort | uniq -c | awk '$1 > 1 {print "‚ö†Ô∏è  " $2 ": " $1 " —Ä–∞–∑"}')
if [[ -n "$duplicates" ]; then
    echo "$duplicates"
else
    echo "–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi

# 3. –ê–Ω–∞–ª–∏–∑ —Ñ—É–Ω–∫—Ü–∏–π –≤ bash —Å–∫—Ä–∏–ø—Ç–∞—Ö
echo -e "\n–ê–Ω–∞–ª–∏–∑ —Ñ—É–Ω–∫—Ü–∏–π –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö:"
if [[ -d "layer-hooks/" ]; then
    for script in layer-hooks/*.sh; do
        if [[ -f "$script" ]; then
            echo "–§–∞–π–ª: $(basename "$script")"
            # –ê–Ω–∞–ª–∏–∑ –¥–ª–∏–Ω—ã —Ñ—É–Ω–∫—Ü–∏–π
            awk '
            /^function / {
                func=substr($2, 1, index($2, "(")-1)
                if (func) {
                    start=NR
                    getline
                    while ($0 !~ /^}/ && NR-start < 50) {
                        getline
                    }
                    lines=NR-start
                    if (lines > 30) {
                        print "‚ö†Ô∏è  " func ": " lines " —Å—Ç—Ä–æ–∫"
                    }
                }
            }
            ' "$script" 2>/dev/null || true
        fi
    done
else
    echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è layer-hooks/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
echo -e "\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:"
complex_functions=$(find layer/ -name '*.yaml' -exec grep -l 'customize-hooks' {} \; | wc -l)
echo "–°–ª–æ–µ–≤ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Ö—É–∫–∞–º–∏: $complex_functions"

# –í—ã–≤–æ–¥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
echo -e "\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "- –§—É–Ω–∫—Ü–∏–∏ –¥–ª–∏–Ω–Ω–µ–µ 30 —Å—Ç—Ä–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–∑–±–∏—Ç—å"
echo "- –ò–∑–±–µ–≥–∞–π—Ç–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤"
echo "- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–Ω–∞—á–µ–Ω–∏–π"
echo "- –ö–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∑–∞–¥–∞—á—É"

exit 0
