---
alwaysApply: ${cursor.file.path.includes("layer/") || cursor.file.path.includes("hooks/")}
---

# ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ 01-4: ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð¸ Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼Ñ‹ Ñ…ÑƒÐºÐ¾Ð²

## ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°
ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ñ…ÑƒÐºÐ°Ð¼Ð¸ Ð¸ Ñ‚Ð¾Ñ‡ÐºÐ°Ð¼Ð¸ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸ rpi-image-gen.

## ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ ðŸ”´ ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð•

## ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ñ…ÑƒÐºÐ¾Ð²

### Ð¢Ð¸Ð¿Ñ‹ Ñ…ÑƒÐºÐ¾Ð² Ð² rpi-image-gen

#### 1. **mmdebstrap customize-hooks**
ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¤Ð¡:

```yaml
mmdebstrap:
  customize-hooks:
    - |
      # Shell ÑÐºÑ€Ð¸Ð¿Ñ‚, Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‰Ð¸Ð¹ÑÑ Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ customize
      set -euo pipefail
      echo "Customizing system..."

      # Ð’Ð°ÑˆÐ° Ð»Ð¾Ð³Ð¸ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
      configure_service
```

#### 2. **Layer-specific hooks**
Ð¥ÑƒÐºÐ¸, Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ðµ Ð² Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð°Ñ… ÑÐ»Ð¾Ñ:

```
layer/
â”œâ”€â”€ my-layer.yaml          # ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ„Ð°Ð¹Ð» ÑÐ»Ð¾Ñ
â””â”€â”€ hooks/
    â”œâ”€â”€ setup.sh          # Ð¥ÑƒÐº Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
    â”œâ”€â”€ customize.sh      # Ð¥ÑƒÐº ÐºÐ°ÑÑ‚Ð¾Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸
    â””â”€â”€ cleanup.sh        # Ð¥ÑƒÐº Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸
```

#### 3. **Image-specific hooks**
Ð¥ÑƒÐºÐ¸ Ð´Ð»Ñ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ñ‚Ð¸Ð¿Ð¾Ð² Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²:

```yaml
image/
â”œâ”€â”€ mbr/
â”‚   â””â”€â”€ hybrid-raid-luks/
â”‚       â””â”€â”€ device/
â”‚           â””â”€â”€ rootfs-overlay/
â”‚               â””â”€â”€ etc/
â”‚                   â””â”€â”€ systemd/
â”‚                       â””â”€â”€ system/
â”‚                           â””â”€â”€ disk-expansion.service
```

### Ð­Ñ‚Ð°Ð¿Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ…ÑƒÐºÐ¾Ð²

#### ÐŸÐ¾Ñ€ÑÐ´Ð¾Ðº Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð² mmdebstrap
1. **setup-hooks** - Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ Ð´Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
2. **essential-hooks** - ÐŸÐ¾ÑÐ»Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ essential Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
3. **customize-hooks** - ÐŸÐ¾ÑÐ»Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð²ÑÐµÑ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² (Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÑ‚Ð°Ð¿)
4. **cleanup-hooks** - Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ°

#### ÐŸÑ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº Ð² rpi-image-gen
```
1. Parameter Assembly     (ÑÐ±Ð¾Ñ€ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²)
2. Layer Processing       (Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ»Ð¾ÐµÐ²)
3. Build Preparation      (Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°)
4. â”œâ”€â”€ mmdebstrap setup
5. â”œâ”€â”€ Install essential packages
6. â”œâ”€â”€ mmdebstrap customize-hooks â† ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ Ð­Ð¢ÐÐŸ
7. â”œâ”€â”€ rootfs-overlay application
8. â”œâ”€â”€ Additional layer processing
9. Image Generation       (ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð·Ð°)
```

### Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° customize-hooks

#### Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ ÑˆÐ°Ð±Ð»Ð¾Ð½ Ñ…ÑƒÐºÐ°
```bash
#!/bin/bash
# rpi-image-gen customize hook for my-layer
set -euo pipefail

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
error_handler() {
  echo "ERROR: Hook failed in my-layer" >&2
  exit 1
}
trap error_handler ERR

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ°
main() {
  echo "ðŸ”§ Configuring my-layer..."

  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
  validate_environment

  # Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  backup_existing_config

  # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
  apply_configuration

  # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ
  validate_configuration

  echo "âœ… my-layer configured successfully"
}

# Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
validate_environment() {
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹
  if [[ ! -d /etc ]]; then
    echo "ERROR: /etc directory not found" >&2
    exit 1
  fi
}

backup_existing_config() {
  # Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  local config_file="/etc/my-service.conf"
  if [[ -f "$config_file" ]] && [[ ! -f "${config_file}.backup" ]]; then
    cp "$config_file" "${config_file}.backup"
    echo "ðŸ“‹ Backed up existing configuration"
  fi
}

apply_configuration() {
  # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
  cat > /etc/my-service.conf << EOF
# Generated by my-layer v${IGconf_my_layer_version:-1.0.0}
setting1=${IGconf_my_layer_setting1:-default}
setting2=${IGconf_my_layer_setting2:-default}
EOF
}

validate_configuration() {
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
  if [[ ! -f /etc/my-service.conf ]]; then
    echo "ERROR: Configuration file not created" >&2
    exit 1
  fi
}

# Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ
main "$@"
```

### Rootfs-overlay Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼

#### Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° overlay
```yaml
mmdebstrap:
  rootfs-overlay:
    # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    etc/my-service/config.conf: |
      # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ°
      key1=value1
      key2=value2

    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹
    usr/local/bin/my-status: |
      #!/bin/bash
      echo "Service status"
      systemctl status my-service

    # Systemd ÑÐµÑ€Ð²Ð¸ÑÑ‹
    etc/systemd/system/my-service.service: |
      [Unit]
      Description=My Service
      After=network.target

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/my-service
      Restart=always

      [Install]
      WantedBy=multi-user.target

    # Profile ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ (Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°)
    etc/profile.d/my-status.sh: |
      # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¸ Ð»Ð¾Ð³Ð¸Ð½Ðµ
      if [[ -x /usr/local/bin/my-status ]]; then
        echo "Service Status:"
        /usr/local/bin/my-status | head -5
        echo
      fi
```

#### ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ overlay
- **ÐŸÑƒÑ‚Ð¸**: ÐžÑ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¾Ñ‚ ÐºÐ¾Ñ€Ð½Ñ Ð¤Ð¡ (`/` = ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ñ†ÐµÐ»ÐµÐ²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹)
- **ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°**: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ ÐºÐ°Ðº ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ `install` Ð¸Ð»Ð¸ `chmod` Ð² Ñ…ÑƒÐºÐ°Ñ…)
- **ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑŒ**: ÐÐ¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ
- **Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹**: ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°ÑŽÑ‚ÑÑ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸

### Ð˜Ð´ÐµÐ¼Ð¿Ð¾Ñ‚ÐµÐ½Ñ‚Ð½Ð¾ÑÑ‚ÑŒ Ñ…ÑƒÐºÐ¾Ð²

#### ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ð¸Ð´ÐµÐ¼Ð¿Ð¾Ñ‚ÐµÐ½Ñ‚Ð½Ð¾ÑÑ‚Ð¸
```bash
# âŒ ÐÐ•Ð˜Ð”Ð•ÐœÐŸÐžÐ¢Ð•ÐÐ¢ÐÐž - Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹
echo "nameserver 8.8.8.8" >> /etc/resolv.conf

# âœ… Ð˜Ð”Ð•ÐœÐŸÐžÐ¢Ð•ÐÐ¢ÐÐž - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€ÐµÐ´ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼
add_nameserver() {
  local nameserver="8.8.8.8"
  if ! grep -q "^nameserver $nameserver$" /etc/resolv.conf; then
    echo "nameserver $nameserver" >> /etc/resolv.conf
    echo "âœ… Added nameserver $nameserver"
  else
    echo "âšª Nameserver $nameserver already configured"
  fi
}
```

#### Ð¨Ð°Ð±Ð»Ð¾Ð½Ñ‹ Ð¸Ð´ÐµÐ¼Ð¿Ð¾Ñ‚ÐµÐ½Ñ‚Ð½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
```bash
# Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð² Ñ„Ð°Ð¹Ð» (Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹)
add_to_file() {
  local file="$1"
  local content="$2"
  local marker="$3"

  if ! grep -q "$marker" "$file" 2>/dev/null; then
    echo "$content" >> "$file"
    echo "âœ… Added to $file"
  else
    echo "âšª Already in $file"
  fi
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° (Ñ Ð±ÑÐºÐ°Ð¿Ð¾Ð¼)
create_config_file() {
  local file="$1"
  local content="$2"

  # Ð‘ÑÐºÐ°Ð¿ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ñ„Ð°Ð¹Ð»Ð°
  if [[ -f "$file" ]] && [[ ! -f "${file}.backup" ]]; then
    cp "$file" "${file}.backup"
  fi

  # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ/Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑŒ
  cat > "$file" << EOF
$content
EOF
  echo "âœ… Created $file"
}

# Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ systemd
manage_systemd_service() {
  local service="$1"
  local action="$2"  # enable/disable

  case "$action" in
    enable)
      if ! systemctl is-enabled "$service" 2>/dev/null; then
        systemctl enable "$service"
        echo "âœ… Enabled $service"
      fi
      ;;
    disable)
      if systemctl is-enabled "$service" 2>/dev/null; then
        systemctl disable "$service"
        echo "âœ… Disabled $service"
      fi
      ;;
  esac
}
```

### ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº

#### Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹
```bash
#!/bin/bash
set -euo pipefail  # ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾!

# Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
error_handler() {
  local exit_code=$?
  echo "ERROR: Hook failed with exit code $exit_code" >&2
  echo "ERROR: Failed command: $BASH_COMMAND" >&2
  echo "ERROR: Line: $LINENO" >&2
  exit $exit_code
}
trap error_handler ERR

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
cleanup_on_error() {
  echo "ðŸ§¹ Cleaning up after error..."
  # Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· Ð±ÑÐºÐ°Ð¿Ð°
  if [[ -f /etc/my-service.conf.backup ]]; then
    mv /etc/my-service.conf.backup /etc/my-service.conf
    echo "âœ… Restored backup configuration"
  fi
}
trap cleanup_on_error EXIT

# Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
validate_inputs() {
  if [[ -z "${IGconf_my_setting:-}" ]]; then
    echo "ERROR: IGconf_my_setting is required" >&2
    exit 1
  fi

  case "${IGconf_my_mode:-default}" in
    default|advanced|minimal)
      ;;
    *)
      echo "ERROR: Invalid mode: ${IGconf_my_mode}" >&2
      exit 1
  esac
}
```

### ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¸ ÑÐ»ÑƒÐ¶Ð±Ð° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ

#### Systemd Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
```ini
# etc/systemd/system/my-service.service
[Unit]
Description=My Service
After=network.target
Requires=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/my-service
Restart=always          # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº
RestartSec=10          # Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¿ÐµÑ€ÐµÐ´ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
StartLimitInterval=0   # Ð‘ÐµÐ· Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ Ð½Ð° Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ¸

[Install]
WantedBy=multi-user.target
```

#### Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
```bash
#!/bin/bash
# /usr/local/bin/my-status
echo "=== My Service Status ==="
echo

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°
if systemctl is-active --quiet my-service 2>/dev/null; then
  echo "âœ… Service: running"
else
  echo "âŒ Service: not running"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
if [[ -f /etc/my-service.conf ]]; then
  echo "âœ… Configuration: present"
  echo "   Modified: $(stat -c '%y' /etc/my-service.conf)"
else
  echo "âŒ Configuration: missing"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²
if [[ -f /var/log/my-service.log ]]; then
  echo "âœ… Logs: present"
  echo "   Last entries:"
  tail -3 /var/log/my-service.log | sed 's/^/   /'
else
  echo "âš ï¸  Logs: not found"
fi
```

### Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ

#### Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ IGconf_* Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
```bash
#!/bin/bash
set -euo pipefail

# Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ñ fallback
SERVICE_PORT="${IGconf_my_service_port:-8080}"
SERVICE_MODE="${IGconf_my_service_mode:-production}"
DEBUG_ENABLED="${IGconf_my_service_debug:-false}"

# Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹
case "$SERVICE_MODE" in
  development|staging|production)
    ;;
  *)
    echo "ERROR: Invalid service mode: $SERVICE_MODE" >&2
    exit 1
    ;;
esac

# ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
cat > /etc/my-service.conf << EOF
port=$SERVICE_PORT
mode=$SERVICE_MODE
debug=$DEBUG_ENABLED
EOF
```

