---
alwaysApply: ${cursor.file.isNew || cursor.file.path.includes("layer/") || cursor.file.path.includes("config/")}
---


# ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ 01: Ð’Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð¸ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ð¹

## ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°
ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ Ñ„ÑƒÐ½Ð´Ð°Ð¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ð¸ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ðº Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ rpi-image-gen.

## ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ

### Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ ðŸ”´ ÐžÐ’Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð•
```yaml
# METABEGIN
# X-Env-Layer-Name: {unique-name}
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,{dependencies}
# X-Env-VarPrefix: {prefix}
#
# X-Env-Var-{variable}: {default}
# X-Env-Var-{variable}-Description: ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹
# X-Env-Var-{variable}-Required: true|false
# X-Env-Var-{variable}-Valid: {validation_rules}
# METAEND
---
mmdebstrap:
  packages:
    - {required-packages}
  setup-hooks:
    - {setup-commands}
  customize-hooks:
    - {customization-commands}
```

### ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ð¹ ðŸ”´ ÐžÐ’Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð•
- `extension` - Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ
- `device` - ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²
- `image` - ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
- `suite` - ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ñ‹Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ

### ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ñ ðŸ”´ ÐžÐ’Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð•
- ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ñ ÑÐ»Ð¾ÐµÐ²: `kebab-case` (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: `web-kiosk`, `iot-sensor`)
- ÐŸÑ€ÐµÑ„Ð¸ÐºÑÑ‹ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…: `{layer_name}_` (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: `IGconf_kiosk_url`)
- Ð¤Ð°Ð¹Ð»Ñ‹: `{category}-{name}.yaml`

## Ð—Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¸
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¾Ð¿Ð¸ÑÐ°Ð½Ð½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
- Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ð±ÐµÐ· fallback
- ÐÐ°Ñ€ÑƒÑˆÐµÐ½Ð¸Ðµ Ð¸Ð·Ð¾Ð»ÑÑ†Ð¸Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸ÑÐ¼Ð¸
- Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº

## ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸

### ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ð’ÐµÐ±-ÐºÐ¸Ð¾ÑÐº
```yaml
# METABEGIN
# X-Env-Layer-Name: web-kiosk
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° ÐºÐ°Ðº Ð²ÐµÐ±-ÐºÐ¸Ð¾ÑÐºÐ°
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,x11-misc
# X-Env-VarPrefix: kiosk
#
# X-Env-Var-url: https://example.com
# X-Env-Var-url-Description: URL Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð² ÐºÐ¸Ð¾ÑÐºÐµ
# X-Env-Var-url-Required: true
# X-Env-Var-autostart: true
# X-Env-Var-autostart-Description: ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ¸Ð¾ÑÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
# X-Env-Var-autostart-Required: false
# X-Env-Var-autostart-Valid: true,false
# METAEND
---
mmdebstrap:
  packages:
    - chromium-browser
    - unclutter
    - x11-xserver-utils
  customize-hooks:
    - |
      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸ÐµÐ¹
      [[ -n "${IGconf_kiosk_url}" ]] || { echo "ÐžÑˆÐ¸Ð±ÐºÐ°: IGconf_kiosk_url Ð½Ðµ Ð·Ð°Ð´Ð°Ð½"; exit 1; }

      cat > /usr/local/bin/start-kiosk.sh << 'EOF'
      #!/bin/bash
      set -euo pipefail

      xset s off
      xset s noblank
      xset -dpms
      unclutter -idle 0.5 -root &

      # Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° URL
      KIOSK_URL="${IGconf_kiosk_url}"
      sed -i 's/"exited_cleanly":false/"exited_cleanly":true/' ~/.config/chromium/Default/Preferences
      chromium-browser --noerrdialogs --disable-infobars --kiosk "${KIOSK_URL}"
      EOF
      chmod +x /usr/local/bin/start-kiosk.sh

    - |
      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°Ð¼Ð¸
      if [[ "${IGconf_kiosk_autostart}" = "true" ]]; then
        USER_HOME="/home/${IGconf_device_user}"
        AUTOSTART_DIR="${USER_HOME}/.config/autostart"

        mkdir -p "${AUTOSTART_DIR}"
        cat > "${AUTOSTART_DIR}/kiosk.desktop" << EOF
        [Desktop Entry]
        Type=Application
        Name=Web Kiosk
        Exec=/usr/local/bin/start-kiosk.sh
        EOF
        chown -R "${IGconf_device_user}:${IGconf_device_user}" "${USER_HOME}/.config"
      fi
```

## ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ
- [ ] Ð’ÑÐµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ñ‹ Ð² METABEGIN Ð±Ð»Ð¾ÐºÐµ
- [ ] Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ñ‹Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
- [ ] Ð¡Ð¾Ð±Ð»ÑŽÐ´ÐµÐ½Ñ‹ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ñ
- [ ] ÐŸÑ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
- [ ] Ð•ÑÑ‚ÑŒ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…