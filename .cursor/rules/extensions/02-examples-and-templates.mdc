---
alwaysApply: ${cursor.file.path.includes("examples/") || cursor.file.path.includes("templates/")}
---


# –ü—Ä–∞–≤–∏–ª–æ 02: –ü—Ä–∏–º–µ—Ä—ã –∏ —à–∞–±–ª–æ–Ω—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π.

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –®–∞–±–ª–æ–Ω: –í–µ–±-–∫–∏–æ—Å–∫ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï
```yaml
# METABEGIN
# X-Env-Layer-Name: web-kiosk
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫–∞–∫ –≤–µ–±-–∫–∏–æ—Å–∫–∞
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,x11-misc
# X-Env-VarPrefix: kiosk
#
# X-Env-Var-url: https://example.com
# X-Env-Var-url-Description: URL –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–∏–æ—Å–∫–µ
# X-Env-Var-url-Required: true
# X-Env-Var-autostart: true
# X-Env-Var-autostart-Description: –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∫–∏–æ—Å–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
# X-Env-Var-autostart-Required: false
# X-Env-Var-autostart-Valid: true,false
# METAEND
---
mmdebstrap:
  packages:
    - chromium-browser
    - unclutter
    - x11-xserver-utils
  setup-hooks:
    - echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-–∫–∏–æ—Å–∫–∞"
  customize-hooks:
    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
      cat > /usr/local/bin/start-kiosk.sh << 'EOF'
      #!/bin/bash
      xset s off
      xset s noblank
      xset -dpms
      unclutter -idle 0.5 -root &
      sed -i 's/"exited_cleanly":false/"exited_cleanly":true/' ~/.config/chromium/Default/Preferences
      chromium-browser --noerrdialogs --disable-infobars --kiosk ${IGconf_kiosk_url}
      EOF
      chmod +x /usr/local/bin/start-kiosk.sh
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
      if [ "${IGconf_kiosk_autostart}" = "true" ]; then
        mkdir -p /home/${IGconf_device_user}/.config/autostart
        cat > /home/${IGconf_device_user}/.config/autostart/kiosk.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=Web Kiosk
        Exec=/usr/local/bin/start-kiosk.sh
        EOF
        chown -R ${IGconf_device_user}:${IGconf_device_user} /home/${IGconf_device_user}/.config
      fi
```

### –®–∞–±–ª–æ–Ω: IoT –î–∞—Ç—á–∏–∫ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï
```yaml
# METABEGIN
# X-Env-Layer-Name: iot-sensor
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: –°–±–æ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,net-misc
# X-Env-VarPrefix: sensor
#
# X-Env-Var-server_url: https://api.example.com/data
# X-Env-Var-server_url-Description: URL —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
# X-Env-Var-server_url-Required: true
# X-Env-Var-interval: 60
# X-Env-Var-interval-Description: –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (—Å–µ–∫—É–Ω–¥—ã)
# X-Env-Var-interval-Required: false
# X-Env-Var-interval-Valid: int:10-3600
# X-Env-Var-enable_tls: true
# X-Env-Var-enable_tls-Description: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TLS –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
# X-Env-Var-enable_tls-Required: false
# X-Env-Var-enable_tls-Valid: true,false
# METAEND
---
mmdebstrap:
  packages:
    - python3
    - python3-pip
    - python3-rpi.gpio
    - curl
    - ca-certificates
  setup-hooks:
    - pip3 install requests adafruit-circuitpython-dht paho-mqtt
  customize-hooks:
    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π TLS
      cat > /usr/local/bin/sensor-collector.py << 'EOF'
      #!/usr/bin/env python3
      import time
      import json
      import ssl
      import requests
      import paho.mqtt.client as mqtt
      import adafruit_dht
      import board

      SENSOR_PIN = board.D4
      SERVER_URL = "${IGconf_sensor_server_url}"
      INTERVAL = ${IGconf_sensor_interval}

      def collect_data():
          try:
              dht_device = adafruit_dht.DHT22(SENSOR_PIN)
              temperature = dht_device.temperature
              humidity = dht_device.humidity

              data = {
                  "temperature": temperature,
                  "humidity": humidity,
                  "timestamp": time.time()
              }

              response = requests.post(SERVER_URL, json=data)
              print(f"–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã: {response.status_code}")
          except Exception as e:
              print(f"–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {e}")

      while True:
          collect_data()
          time.sleep(INTERVAL)
      EOF
      chmod +x /usr/local/bin/sensor-collector.py
    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞
      cat > /etc/systemd/system/sensor-collector.service << EOF
      [Unit]
      Description=IoT Sensor Data Collector
      After=network.target

      [Service]
      ExecStart=/usr/local/bin/sensor-collector.py
      Restart=always
      User=${IGconf_device_user}

      [Install]
      WantedBy=multi-user.target
      EOF
      systemctl enable sensor-collector.service
```

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —à–∞–±–ª–æ–Ω—ã ‚ö†Ô∏è –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï

### –®–∞–±–ª–æ–Ω: –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```yaml
# METABEGIN
# X-Env-Layer-Name: monitoring-system
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å Grafana –∏ Prometheus
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,net-misc
# X-Env-VarPrefix: monitoring
#
# X-Env-Var-retention_days: 30
# X-Env-Var-retention_days-Description: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫
# X-Env-Var-retention_days-Required: false
# X-Env-Var-retention_days-Valid: int:1-365
# X-Env-Var-grafana_port: 3000
# X-Env-Var-grafana_port-Description: –ü–æ—Ä—Ç Grafana –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
# X-Env-Var-grafana_port-Required: false
# X-Env-Var-grafana_port-Valid: int:1024-65535
# METAEND
---
mmdebstrap:
  packages:
    - prometheus
    - grafana
    - node-exporter
    - prometheus-node-exporter
    - curl
    - wget
  setup-hooks:
    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
      useradd --system --shell /bin/false prometheus
      useradd --system --shell /bin/false grafana
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Prometheus
      mkdir -p /etc/prometheus /var/lib/prometheus
      chown prometheus:prometheus /etc/prometheus /var/lib/prometheus

      cat > /etc/prometheus/prometheus.yml << EOF
      global:
        scrape_interval: 15s
        evaluation_interval: 15s

      rule_files:
        # - "first_rules.yml"
        # - "second_rules.yml"

      scrape_configs:
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']

        - job_name: 'node'
          static_configs:
            - targets: ['localhost:9100']

        - job_name: 'rpi-image-gen'
          static_configs:
            - targets: ['localhost:9091']
      EOF
      chown prometheus:prometheus /etc/prometheus/prometheus.yml

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana
      mkdir -p /etc/grafana /var/lib/grafana
      chown grafana:grafana /etc/grafana /var/lib/grafana

      cat > /etc/grafana/grafana.ini << EOF
      [server]
      http_port = ${IGconf_monitoring_grafana_port}

      [database]
      type = sqlite3

      [session]
      provider = file

      [analytics]
      check_for_updates = false
      EOF
      chown grafana:grafana /etc/grafana/grafana.ini

    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–æ–≤
      cat > /etc/systemd/system/prometheus.service << EOF
      [Unit]
      Description=Prometheus
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      ExecStart=/usr/bin/prometheus \
          --config.file /etc/prometheus/prometheus.yml \
          --storage.tsdb.path /var/lib/prometheus/ \
          --web.console.templates=/etc/prometheus/consoles \
          --web.console.libraries=/etc/prometheus/console_libraries \
          --storage.tsdb.retention.time=${IGconf_monitoring_retention_days}d \
          --web.listen-address="0.0.0.0:9090"

      [Install]
      WantedBy=multi-user.target
      EOF

      cat > /etc/systemd/system/grafana-server.service << EOF
      [Unit]
      Description=Grafana Server
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=grafana
      Group=grafana
      Type=simple
      ExecStart=/usr/sbin/grafana-server \
          --config=/etc/grafana/grafana.ini \
          --homepath=/usr/share/grafana \
          --packaging=deb \
          cfg:default.paths.logs=/var/log/grafana \
          cfg:default.paths.data=/var/lib/grafana \
          cfg:default.paths.plugins=/var/lib/grafana/plugins

      [Install]
      WantedBy=multi-user.target
      EOF

      systemctl daemon-reload
      systemctl enable prometheus grafana-server node-exporter
```

### –®–∞–±–ª–æ–Ω: –î–æ–º–∞—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
```yaml
# METABEGIN
# X-Env-Layer-Name: home-server
# X-Env-Layer-Category: suite
# X-Env-Layer-Description: –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –¥–æ–º–∞—à–Ω–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,net-misc
# X-Env-VarPrefix: homeserver
#
# X-Env-Var-media_path: /media/storage
# X-Env-Var-media_path-Description: –ü—É—Ç—å –∫ –º–µ–¥–∏–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â—É
# X-Env-Var-media_path-Required: false
# X-Env-Var-backup_schedule: daily
# X-Env-Var-backup_schedule-Description: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
# X-Env-Var-backup_schedule-Required: false
# X-Env-Var-backup_schedule-Valid: hourly,daily,weekly,monthly
# METAEND
---
mmdebstrap:
  packages:
    - samba
    - nfs-kernel-server
    - minidlna
    - transmission-daemon
    - rsnapshot
    - nginx
    - php-fpm
    - sqlite3
    - curl
    - wget
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Samba –¥–ª—è –æ–±—â–∏—Ö –ø–∞–ø–æ–∫
      mkdir -p ${IGconf_homeserver_media_path}
      chmod 755 ${IGconf_homeserver_media_path}

      cat > /etc/samba/smb.conf << EOF
      [global]
      workgroup = WORKGROUP
      server string = %h server
      dns proxy = no
      log file = /var/log/samba/log.%m
      max log size = 1000
      syslog = 0
      panic action = /usr/share/samba/panic-action %d

      [media]
      path = ${IGconf_homeserver_media_path}
      browseable = yes
      writable = yes
      guest ok = no
      valid users = ${IGconf_device_user}
      EOF

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nextcloud-like –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      mkdir -p /var/www/html /var/nextcloud/data
      chown -R www-data:www-data /var/www/html /var/nextcloud

      # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞–º–∏
      cat > /var/www/html/index.php << 'EOF'
      <?php
      $media_path = getenv('IGconf_homeserver_media_path') ?: '/media/storage';
      $current_dir = $_GET['dir'] ?? '';
      $path = $media_path . '/' . $current_dir;

      if (isset($_GET['download'])) {
          $file = $media_path . '/' . $_GET['download'];
          if (file_exists($file)) {
              header('Content-Type: application/octet-stream');
              header('Content-Disposition: attachment; filename="' . basename($file) . '"');
              readfile($file);
              exit;
          }
      }
      ?>
      <!DOCTYPE html>
      <html>
      <head>
          <title>–î–æ–º–∞—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä - –§–∞–π–ª—ã</title>
          <meta charset="UTF-8">
          <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .file { margin: 5px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; }
              .folder { font-weight: bold; color: #0066cc; }
              .file-size { float: right; color: #666; }
          </style>
      </head>
      <body>
          <h1>–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</h1>
          <div>–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: <?= htmlspecialchars($current_dir ?: '/') ?></div>

          <?php if ($current_dir): ?>
              <div class="file folder">
                  <a href="?dir=<?= urlencode(dirname($current_dir)) ?>">üìÅ ..</a>
              </div>
          <?php endif; ?>

          <?php
          if (is_dir($path) && $handle = opendir($path)) {
              while (false !== ($entry = readdir($handle))) {
                  if ($entry != "." && $entry != "..") {
                      $entry_path = $path . '/' . $entry;
                      $is_dir = is_dir($entry_path);
                      $size = $is_dir ? '' : ' (' . formatFileSize(filesize($entry_path)) . ')';

                      echo '<div class="file ' . ($is_dir ? 'folder' : 'file') . '">';
                      if ($is_dir) {
                          echo '<a href="?dir=' . urlencode($current_dir . '/' . $entry) . '">üìÅ ' . htmlspecialchars($entry) . '</a>';
                      } else {
                          echo '<a href="?download=' . urlencode($current_dir . '/' . $entry) . '">üìÑ ' . htmlspecialchars($entry) . '</a>';
                          echo '<span class="file-size">' . $size . '</span>';
                      }
                      echo '</div>';
                  }
              }
              closedir($handle);
          }

          function formatFileSize($bytes) {
              $units = ['B', 'KB', 'MB', 'GB', 'TB'];
              $i = 0;
              while ($bytes >= 1024 && $i < 4) {
                  $bytes /= 1024;
                  $i++;
              }
              return round($bytes, 2) . ' ' . $units[$i];
          }
          ?>
      </body>
      </html>
      EOF

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      mkdir -p /var/backups /etc/cron.${IGconf_homeserver_backup_schedule}

      cat > /usr/local/bin/backup-script.sh << 'EOF'
      #!/bin/bash
      BACKUP_DIR="/var/backups"
      MEDIA_PATH="${IGconf_homeserver_media_path}"
      DATE=$(date +%Y%m%d_%H%M%S)

      # –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞
      if [ -d "$MEDIA_PATH" ]; then
          echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤..."
          rsnapshot -c /etc/rsnapshot.conf ${IGconf_homeserver_backup_schedule}
      fi

      # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
      find "$BACKUP_DIR" -type f -mtime +30 -delete

      echo "–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: $(date)"
      EOF
      chmod +x /usr/local/bin/backup-script.sh

      # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ cron
      echo "0 2 * * * root /usr/local/bin/backup-script.sh" >> /etc/crontab

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
      systemctl enable smbd nmbd minidlna transmission-daemon nginx php8.2-fpm
      systemctl start smbd nmbd minidlna transmission-daemon nginx php8.2-fpm

  cleanup-hooks:
    - rm -f /etc/samba/smb.conf.bak /etc/grafana/grafana.ini.bak
```

### –®–∞–±–ª–æ–Ω: Debian Trixie Development Environment üÜï –ù–û–í–û–ï
```yaml
# METABEGIN
# X-Env-Layer-Name: debian-trixie-dev
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: –°—Ä–µ–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –±–∞–∑–µ Debian Trixie
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential
# X-Env-VarPrefix: trixie_dev
#
# X-Env-Var-enable_rust: true
# X-Env-Var-enable_rust-Description: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Rust toolchain
# X-Env-Var-enable_rust-Required: false
# X-Env-Var-enable_rust-Valid: true,false
# X-Env-Var-enable_go: false
# X-Env-Var-enable_go-Description: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Go toolchain
# X-Env-Var-enable_go-Required: false
# X-Env-Var-enable_go-Valid: true,false
# METAEND
---
mmdebstrap:
  suite: trixie
  packages:
    - build-essential
    - git
    - vim
    - curl
    - wget
    - python3-dev
    - nodejs
    - npm
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ä–µ–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è Debian Trixie
      setup_dev_environment() {
        local enable_rust="${IGconf_trixie_dev_enable_rust:-true}"
        local enable_go="${IGconf_trixie_dev_enable_go:-false}"

        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Rust –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
        if [[ "$enable_rust" = "true" ]]; then
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup component add rustfmt clippy
        fi

        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
        if [[ "$enable_go" = "true" ]]; then
          wget -O go.tar.gz "https://golang.org/dl/go1.21.0.linux-arm64.tar.gz"
          tar -C /usr/local -xzf go.tar.gz
          echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile
        fi

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python virtualenv wrapper
        pip3 install virtualenvwrapper --break-system-packages
        echo "export WORKON_HOME=/opt/virtualenvs" >> /etc/profile
        echo "source /usr/local/bin/virtualenvwrapper.sh" >> /etc/profile
      }

      setup_dev_environment
```

### –®–∞–±–ª–æ–Ω: A/B Boot System üÜï –ù–û–í–û–ï
```yaml
# METABEGIN
# X-Env-Layer-Name: ab-boot-system
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: –°–∏—Å—Ç–µ–º–∞ A/B –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å tryboot
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,rpi-bootloader
# X-Env-VarPrefix: ab_boot
#
# X-Env-Var-tryboot_timeout: 10
# X-Env-Var-tryboot_timeout-Description: –¢–∞–π–º–∞—É—Ç –¥–ª—è tryboot (—Å–µ–∫—É–Ω–¥—ã)
# X-Env-Var-tryboot_timeout-Required: false
# X-Env-Var-tryboot_timeout-Valid: int:5-60
# X-Env-Var-enable_fallback: true
# X-Env-Var-enable_fallback-Description: –í–∫–ª—é—á–∏—Ç—å fallback –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–æ—Ç
# X-Env-Var-enable_fallback-Required: false
# X-Env-Var-enable_fallback-Valid: true,false
# METAEND
---
mmdebstrap:
  packages:
    - raspberrypi-bootloader
    - rpi-eeprom
    - u-boot-tools
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ A/B boot —Å–∏—Å—Ç–µ–º—ã
      setup_ab_boot() {
        local tryboot_timeout="${IGconf_ab_boot_tryboot_timeout:-10}"
        local enable_fallback="${IGconf_ab_boot_enable_fallback:-true}"

        # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ tryboot
        cat > /boot/tryboot.txt << EOF
[all]
boot_delay=0
dtoverlay=vc4-fkms-v3d
kernel=kernel8.img
initramfs initrd.img followkernel
EOF

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ EEPROM –¥–ª—è A/B
        rpi-eeprom-config --edit << EOF
BOOT_ORDER=0xf21
TFTP_PREFIX=tryboot
BOOT_DELAY=0
TFTP_ENABLED=1
EOF

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        cat > /etc/systemd/system/rpi-ab-update.service << EOF
[Unit]
Description=Raspberry Pi A/B Update Service
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/rpi-ab-update.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

        chmod +x /etc/systemd/system/rpi-ab-update.service
        systemctl enable rpi-ab-update
      }

      setup_ab_boot
    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      cat > /usr/local/bin/rpi-ab-update.sh << 'EOF'
#!/bin/bash
set -euo pipefail

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∏ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–ª–æ—Ç–∞
CURRENT_SLOT=$(rpi-eeprom-config | grep -o "BOOT_ORDER=.*" | cut -d= -f2)
TARGET_SLOT=""

if [[ "$CURRENT_SLOT" == "0xf21" ]]; then
    TARGET_SLOT="0xf12"
else
    TARGET_SLOT="0xf21"
fi

echo "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ—Ç: $TARGET_SLOT"

# –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤
rpi-eeprom-config --edit "BOOT_ORDER=$TARGET_SLOT"

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
shutdown -r now
EOF
      chmod +x /usr/local/bin/rpi-ab-update.sh
```

### –®–∞–±–ª–æ–Ω: Modern IoT Gateway üÜï –ù–û–í–û–ï
```yaml
# METABEGIN
# X-Env-Layer-Name: iot-gateway-modern
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π IoT —à–ª—é–∑ —Å MQTT –∏ TLS
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,net-misc
# X-Env-VarPrefix: iot_gw
#
# X-Env-Var-mqtt_broker: mqtt.example.com
# X-Env-Var-mqtt_broker-Description: MQTT –±—Ä–æ–∫–µ—Ä –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
# X-Env-Var-mqtt_broker-Required: true
# X-Env-Var-mqtt_port: 8883
# X-Env-Var-mqtt_port-Description: –ü–æ—Ä—Ç MQTT –±—Ä–æ–∫–µ—Ä–∞
# X-Env-Var-mqtt_port-Required: false
# X-Env-Var-mqtt_port-Valid: int:1883,8883
# X-Env-Var-enable_tls: true
# X-Env-Var-enable_tls-Description: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TLS –¥–ª—è MQTT
# X-Env-Var-enable_tls-Required: false
# X-Env-Var-enable_tls-Valid: true,false
# METAEND
---
mmdebstrap:
  packages:
    - mosquitto-clients
    - python3-paho-mqtt
    - python3-cryptography
    - ca-certificates
    - curl
    - jq
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ IoT —à–ª—é–∑–∞
      setup_iot_gateway() {
        local mqtt_broker="${IGconf_iot_gw_mqtt_broker}"
        local mqtt_port="${IGconf_iot_gw_mqtt_port:-8883}"
        local enable_tls="${IGconf_iot_gw_enable_tls:-true}"

        # –°–æ–∑–¥–∞–Ω–∏–µ MQTT –∫–ª–∏–µ–Ω—Ç–∞ —Å TLS
        cat > /usr/local/bin/iot-gateway.py << EOF
#!/usr/bin/env python3
import paho.mqtt.client as mqtt
import ssl
import json
import time
import subprocess

def on_connect(client, userdata, flags, rc):
    print(f"Connected to MQTT broker with result code {rc}")
    client.subscribe("iot/devices/+/status")

def on_message(client, userdata, msg):
    print(f"Received message: {msg.topic} {msg.payload}")
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤

def main():
    client = mqtt.Client()
    client.on_connect = on_connect
    client.on_message = on_message

    if "${enable_tls}" == "true":
        client.tls_set(ca_certs=None, certfile=None, keyfile=None,
                      cert_reqs=ssl.CERT_REQUIRED,
                      tls_version=ssl.PROTOCOL_TLS, ciphers=None)
        client.tls_insecure_set(False)

    client.connect("${mqtt_broker}", ${mqtt_port}, 60)
    client.loop_forever()

if __name__ == "__main__":
    main()
EOF

        chmod +x /usr/local/bin/iot-gateway.py

        # –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞
        cat > /etc/systemd/system/iot-gateway.service << EOF
[Unit]
Description=IoT Gateway Service
After=network.target

[Service]
ExecStart=/usr/local/bin/iot-gateway.py
Restart=always
User=iot-gateway

[Install]
WantedBy=multi-user.target
EOF

        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞
        useradd --system --shell /bin/false --home /var/lib/iot-gateway iot-gateway
        systemctl enable iot-gateway
      }

      setup_iot_gateway
```

## –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–æ–≤ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –ê–¥–∞–ø—Ç–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤
1. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö**: –û–±–Ω–æ–≤–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, –≤–µ—Ä—Å–∏—é
2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö**: –î–æ–±–∞–≤—å—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–ª—É—á–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏

### –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –∏–∑ METABEGIN –±–ª–æ–∫–∞
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º
- –ù–∞—Ä—É—à–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã mmdebstrap —Å–µ–∫—Ü–∏–∏

## –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —à–∞–±–ª–æ–Ω–æ–≤
- [ ] –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ edge cases
- [ ] –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- [ ] –ù–∞–ª–∏—á–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è