---
alwaysApply: ${cursor.file.path.includes("layer/device/") ? "device" : cursor.file.path.includes("layer/image/") ? "image" : "general"}
---


# –ü—Ä–∞–≤–∏–ª–æ 05: –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è —Ç–∏–ø–æ–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π rpi-image-gen.

## –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (Device Extensions) üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
1. **–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –¥—Ä–∞–π–≤–µ—Ä–æ–≤** - –≤–∫–ª—é—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ —è–¥—Ä–∞
2. **–í–µ—Ä—Å–∏–æ–Ω–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ hardware** - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ü–µ–ª–µ–≤—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
```
device/{device_name}/
‚îú‚îÄ‚îÄ device.yaml                    # –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
‚îú‚îÄ‚îÄ device.adoc                    # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
‚îú‚îÄ‚îÄ bdebstrap/                     # –•—É–∫–∏ —ç—Ç–∞–ø–æ–≤ —Å–±–æ—Ä–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ setup*                    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ customize*                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
‚îÇ   ‚îî‚îÄ‚îÄ cleanup*                  # –û—á–∏—Å—Ç–∫–∞
‚îú‚îÄ‚îÄ initramfs-tools/              # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ initramfs
‚îî‚îÄ‚îÄ rootfs-overlay/               # –û–≤–µ—Ä–ª–µ–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
```

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è Raspberry Pi 5
```yaml
# METABEGIN
# X-Env-Layer-Name: rpi5
# X-Env-Layer-Category: device
# X-Env-Layer-Description: –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Raspberry Pi 5
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,rpi-base
# X-Env-VarPrefix: rpi5
#
# X-Env-Var-firmware_version: latest
# X-Env-Var-firmware_version-Description: –í–µ—Ä—Å–∏—è firmware –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
# X-Env-Var-firmware_version-Required: false
# X-Env-Var-firmware_version-Valid: latest,stable,beta
# METAEND
---
mmdebstrap:
  packages:
    - raspberrypi-bootloader
    - raspberrypi-kernel
    - linux-firmware-raspi
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è Pi 5 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Raspberry Pi 5"

      # –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —è–¥—Ä–∞
      cat >> /etc/modules << 'EOF'
      bcm2712_wdt
      bcm2712_thermal
      EOF

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firmware
      if [[ "${IGconf_rpi5_firmware_version}" = "latest" ]]; then
        rpi-eeprom-update -a
      fi

      # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      cat > /etc/sysctl.d/99-rpi5-performance.conf << 'EOF'
      # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è Raspberry Pi 5
      vm.swappiness=10
      vm.vfs_cache_pressure=50
      net.core.rmem_max=262144
      net.core.wmem_max=262144
      EOF
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ü–µ–ª–µ–≤–æ–º hardware
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ –û–°
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤

## –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (Application Extensions) üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
1. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã** - –≤—ã–Ω–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤ –∏ —É—Ä–æ–≤–Ω–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```
application/{app_name}/
‚îú‚îÄ‚îÄ app.yaml                       # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ docker/                        # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îî‚îÄ‚îÄ .env.template
‚îú‚îÄ‚îÄ config/                        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ logs/                          # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îî‚îÄ‚îÄ scripts/                       # –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```yaml
# METABEGIN
# X-Env-Layer-Name: web-application
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,net-misc,docker
# X-Env-VarPrefix: webapp
#
# X-Env-Var-app_port: 8080
# X-Env-Var-app_port-Description: –ü–æ—Ä—Ç –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# X-Env-Var-app_port-Required: false
# X-Env-Var-app_port-Valid: int:1024-65535
#
# X-Env-Var-db_type: sqlite
# X-Env-Var-db_type-Description: –¢–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# X-Env-Var-db_type-Required: false
# X-Env-Var-db_type-Valid: sqlite,postgresql,mysql
# METAEND
---
mmdebstrap:
  packages:
    - docker.io
    - docker-compose
    - nginx
    - certbot
  setup-hooks:
    - systemctl enable docker
  customize-hooks:
    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      mkdir -p /opt/webapp /var/log/webapp /var/lib/webapp/data

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Compose
      cat > /opt/webapp/docker-compose.yml << EOF
      version: '3.8'
      services:
        webapp:
          build: .
          ports:
            - "${IGconf_webapp_app_port}:8080"
          environment:
            - DB_TYPE=${IGconf_webapp_db_type}
          volumes:
            - /var/lib/webapp/data:/app/data
          restart: unless-stopped
      EOF

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx –∫–∞–∫ reverse proxy
      cat > /etc/nginx/sites-available/webapp << EOF
      server {
          listen 80;
          server_name localhost;

          location / {
              proxy_pass http://localhost:${IGconf_webapp_app_port};
              proxy_set_header Host \$host;
              proxy_set_header X-Real-IP \$remote_addr;
          }
      }
      EOF
      ln -sf /etc/nginx/sites-available/webapp /etc/nginx/sites-enabled/

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
      cat > /etc/logrotate.d/webapp << EOF
      /var/log/webapp/*.log {
          daily
          missingok
          rotate 7
          compress
          notifempty
          create 0644 www-data www-data
          postrotate
              systemctl reload nginx
          endscript
      }
      EOF

    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
      cat > /etc/systemd/system/webapp.service << EOF
      [Unit]
      Description=Web Application Service
      After=docker.service
      Requires=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/webapp
      ExecStart=/usr/bin/docker-compose up -d
      ExecStop=/usr/bin/docker-compose down
      ExecReload=/usr/bin/docker-compose restart

      [Install]
      WantedBy=multi-user.target
      EOF

      systemctl enable webapp
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º
- [ ] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
- [ ] –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (Infrastructure Extensions) üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
1. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - —Å–∫—Ä–∏–ø—Ç—ã –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫
2. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Prometheus, Grafana)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
```
infrastructure/{infra_name}/
‚îú‚îÄ‚îÄ infra.yaml                     # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
‚îú‚îÄ‚îÄ monitoring/                    # –°–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ prometheus/
‚îÇ   ‚îú‚îÄ‚îÄ grafana/
‚îÇ   ‚îî‚îÄ‚îÄ exporters/
‚îú‚îÄ‚îÄ networking/                    # –°–µ—Ç–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ security/                      # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
‚îî‚îÄ‚îÄ backup/                        # –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
```

### –ü—Ä–∏–º–µ—Ä –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
```yaml
# METABEGIN
# X-Env-Layer-Name: production-infrastructure
# X-Env-Layer-Category: suite
# X-Env-Layer-Description: –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
# X-Env-Layer-Version: 2.0.0
# X-Env-Layer-Requires: essential,net-misc,monitoring
# X-Env-VarPrefix: infra
#
# X-Env-Var-monitoring_retention: 30d
# X-Env-Var-monitoring_retention-Description: –ü–µ—Ä–∏–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫
# X-Env-Var-monitoring_retention-Required: false
# X-Env-Var-monitoring_retention-Valid: regex:^\d+[dhm]$
#
# X-Env-Var-backup_schedule: daily
# X-Env-Var-backup_schedule-Description: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
# X-Env-Var-backup_schedule-Required: false
# X-Env-Var-backup_schedule-Valid: hourly,daily,weekly
# METAEND
---
mmdebstrap:
  packages:
    - prometheus
    - prometheus-node-exporter
    - grafana
    - rsnapshot
    - fail2ban
    - unattended-upgrades
    - logrotate
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Prometheus (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è)
      mkdir -p /etc/prometheus /var/lib/prometheus
      chown prometheus:prometheus /etc/prometheus /var/lib/prometheus

      # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if [[ ! -f /etc/prometheus/prometheus.yml ]]; then
        cat > /etc/prometheus/prometheus.yml << EOF
        global:
          scrape_interval: 15s
          evaluation_interval: 15s

        scrape_configs:
          - job_name: 'node'
            static_configs:
              - targets: ['localhost:9100']
        EOF
        chown prometheus:prometheus /etc/prometheus/prometheus.yml
      fi

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana
      mkdir -p /etc/grafana /var/lib/grafana
      chown grafana:grafana /etc/grafana /var/lib/grafana

      # –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
      if [[ ! -f /etc/grafana/grafana.ini ]]; then
        cat > /etc/grafana/grafana.ini << EOF
        [server]
        http_port = 3000
        [database]
        type = sqlite3
        [analytics]
        check_for_updates = false
        EOF
        chown grafana:grafana /etc/grafana/grafana.ini
      fi

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      mkdir -p /var/backups

      cat > /usr/local/bin/infrastructure-backup.sh << 'EOF'
      #!/bin/bash
      set -eu

      BACKUP_DIR="/var/backups"
      DATE=$(date +%Y%m%d_%H%M%S)

      # –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
      tar -czf "${BACKUP_DIR}/system-config-${DATE}.tar.gz" \
        /etc/prometheus \
        /etc/grafana \
        /etc/fail2ban \
        /etc/logrotate.d

      # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
      find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete

      echo "Infrastructure backup completed: $DATE"
      EOF
      chmod +x /usr/local/bin/infrastructure-backup.sh

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      case "${IGconf_infra_backup_schedule}" in
        hourly)
          cron_schedule="0 * * * *"
          ;;
        daily)
          cron_schedule="0 2 * * *"
          ;;
        weekly)
          cron_schedule="0 2 * * 0"
          ;;
        *)
          cron_schedule="0 2 * * *"
          ;;
      esac

      echo "$cron_schedule root /usr/local/bin/infrastructure-backup.sh" > /etc/cron.d/infrastructure-backup

    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º
      cat > /etc/systemd/system/infrastructure-monitor.service << EOF
      [Unit]
      Description=Infrastructure Monitoring Service
      After=network.target

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/infrastructure-monitor.sh
      Restart=always
      RestartSec=10
      StartLimitInterval=300
      StartLimitBurst=3

      [Install]
      WantedBy=multi-user.target
      EOF

      # –°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
      cat > /usr/local/bin/infrastructure-monitor.sh << 'EOF'
      #!/bin/bash
      while true; do
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
        for service in prometheus grafana fail2ban; do
          if ! systemctl is-active --quiet "$service"; then
            echo "$(date): Service $service is down, restarting..."
            systemctl restart "$service"
          fi
        done

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
        disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
        if [[ $disk_usage -gt 90 ]]; then
          echo "$(date): Disk usage critical: ${disk_usage}%, cleaning up..."
          journalctl --vacuum-time=7d
          apt-get autoremove -y
          apt-get autoclean -y
        fi

        sleep 300
      done
      EOF
      chmod +x /usr/local/bin/infrastructure-monitor.sh

      systemctl daemon-reload
      systemctl enable prometheus grafana prometheus-node-exporter infrastructure-monitor
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ
- [ ] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
- [ ] –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –†–µ–≥—É–ª—è—Ä–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã

## –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤ (Image Extensions) üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
1. **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã** - —Å–ª–µ–¥–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —à–∞–±–ª–æ–Ω–∞–º
2. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –§–°** - ext4, btrfs, f2fs
3. **–ì–∏–±–∫–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** - –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ —Ç–∏–ø–æ–≤

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –æ–±—Ä–∞–∑–∞
```
image/{partition_scheme}/{image_name}/
‚îú‚îÄ‚îÄ image.yaml                    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–æ—è
‚îú‚îÄ‚îÄ genimage.cfg.in.ext4         # –®–∞–±–ª–æ–Ω –¥–ª—è ext4
‚îú‚îÄ‚îÄ genimage.cfg.in.btrfs        # –®–∞–±–ª–æ–Ω –¥–ª—è btrfs
‚îú‚îÄ‚îÄ pre-image.sh                 # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–±—Ä–∞–∑–∞
‚îú‚îÄ‚îÄ setup.sh                     # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–¥–µ–ª–æ–≤
‚îú‚îÄ‚îÄ mke2fs.conf                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ext4
‚îî‚îÄ‚îÄ device/                      # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ‚îú‚îÄ‚îÄ provisionmap-*.json      # –ö–∞—Ä—Ç—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    ‚îî‚îÄ‚îÄ *.rules                  # –ü—Ä–∞–≤–∏–ª–∞ udev
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–±—Ä–∞–∑–∞–º
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∏–ø–æ–≤ —Ä–∞–∑–¥–µ–ª–æ–≤ (MBR/GPT)
- [ ] –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ —Ä–∞–∑–¥–µ–ª–æ–≤
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## –û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
- [ ] –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ (shellcheck, pylint)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ edge cases

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [ ] –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
- [ ] –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–±–æ—Ä–∫–∏
- [ ] –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- [ ] –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–π
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å
- [ ] –ß–µ—Ç–∫–∞—è –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [ ] –ò—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ü—Ä–æ—Å—Ç–æ—Ç–∞ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ç–∏–ø–æ–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π

### –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤: Hardware Abstraction
```bash
# –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è hardware-specific –æ–ø–µ—Ä–∞—Ü–∏–π
device_specific_operation() {
    local device_type="$1"
    local operation="$2"

    case "$device_type" in
        rpi4)
            rpi4_"$operation"
            ;;
        rpi5)
            rpi5_"$operation"
            ;;
        *)
            generic_"$operation"
            ;;
    esac
}

rpi5_configure_firmware() {
    # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –¥–ª—è Pi 5 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    rpi-eeprom-update -a
    configure_pcie_device_tree
}

rpi4_configure_firmware() {
    # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –¥–ª—è Pi 4 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    rpi-eeprom-update -d /lib/firmware/raspberrypi/bootloader/stable
}
```

### –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π: Configuration Management
```bash
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
manage_app_config() {
    local app_name="$1"
    local config_template="$2"
    local config_output="$3"

    # –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    load_environment_variables "$app_name"

    # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
    envsubst < "$config_template" > "$config_output"

    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    validate_config "$config_output"
}

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
manage_app_config "webapp" "config.template" "/etc/webapp/config.yml"
```

### –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã: Service Orchestration
```bash
# –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
orchestrate_infrastructure() {
    local services=("$@")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    check_service_dependencies "${services[@]}"

    # –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
    for service in "${services[@]}"; do
        start_service_with_retry "$service"
        wait_for_service_health "$service"
    done

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    verify_infrastructure_integrity
}

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
orchestrate_infrastructure prometheus grafana node-exporter
```

## –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
- [ ] –°–æ–±–ª—é–¥–µ–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ —Ç–∏–ø–∞
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
- [ ] –ù–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ü–µ–ª–µ–≤—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π

### –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
- [ ] –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤
- [ ] –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- [ ] –í—ã—Å–æ–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞
- [ ] –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å