---
alwaysApply: ${cursor.file.path.includes("test/") || cursor.file.path.includes("spec/")}
---


# –ü—Ä–∞–≤–∏–ª–æ 03: –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π rpi-image-gen.

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### 1. –ú–æ–¥—É–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï
```bash
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ—è
rpi-image-gen layer --describe your-layer-name

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
rpi-image-gen layer --list --depends your-layer-name

# –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
rpi-image-gen metadata --lint layer/your-layer.yaml

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤
bash -n hook-script.sh

# –í–∞–ª–∏–¥–∞—Ü–∏—è YAML —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
python3 -c "import yaml; yaml.safe_load(open('layer.yaml'))"
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- [ ] –°–∏–Ω—Ç–∞–∫—Å–∏—Å –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏
- [ ] –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å YAML –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å–ª–æ–µ–≤
- [ ] –ù–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- [ ] –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø—É—Ç–µ–π –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï
```bash
# –¢–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
rpi-image-gen build --dry-run -c test-config.yaml

# –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
rpi-image-gen build -c test-config.yaml \
  -- IGconf_extension_test_mode=true \
  -- IGconf_extension_debug=true

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
rpi-image-gen build -c config-variants.yaml --variant minimal
rpi-image-gen build -c config-variants.yaml --variant full
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
- [ ] –°–±–æ—Ä–∫–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- [ ] –°–±–æ—Ä–∫–∞ —Å –ø–æ–ª–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- [ ] –°–±–æ—Ä–∫–∞ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫)
- [ ] –°–±–æ—Ä–∫–∞ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É —Å–ª–æ—è–º–∏

### 3. –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚ö†Ô∏è –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï
```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤–æ –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏
time rpi-image-gen build -c config.yaml

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞
du -h work/image-*/image-*.img

# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
rpi-image-gen build -c config.yaml --perf-report

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
/usr/bin/time -v rpi-image-gen build -c config.yaml
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- [ ] –í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ (–Ω–µ –±–æ–ª–µ–µ 30 –º–∏–Ω—É—Ç –¥–ª—è —Ç–∏–ø–∏—á–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
- [ ] –†–∞–∑–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–µ–≥–æ –æ–±—Ä–∞–∑–∞
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU –∏ –ø–∞–º—è—Ç–∏
- [ ] –£—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏ (100%)
- [ ] –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

```
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ test_device_layers.py        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚îÇ   ‚îî‚îÄ‚îÄ test_security_layers.py      # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ test_full_build.py           # –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îî‚îÄ‚îÄ fixtures/
    ‚îî‚îÄ‚îÄ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã)
```

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –†–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
```python
#!/usr/bin/env python3
"""
Integration tests for rpi-image-gen security layers
Tests full build scenarios and image boot validation
"""

import subprocess
import sys
import os
import tempfile
import shutil
import time
from pathlib import Path


class IntegrationTestSuite:
    """Integration test suite for security layers"""

    def __init__(self, repo_path):
        self.repo_path = Path(repo_path)
        self.test_results = []

    def run_test(self, test_name, test_func):
        """Run individual integration test"""
        print(f"Running integration test: {test_name}")
        try:
            result = test_func()
            self.test_results.append((test_name, result, None))
            print(f"‚úì {test_name}: {'PASSED' if result else 'FAILED'}")
            return result
        except Exception as e:
            self.test_results.append((test_name, False, str(e)))
            print(f"‚úó {test_name}: ERROR - {e}")
            return False

    def test_minimal_security_config(self):
        """Test building with minimal security configuration"""
        config_content = """
device:
  layer: rpi5
image:
  layer: mbr/simple
layer:
  base: bookworm-minbase
  security: apparmor-core
"""

        with tempfile.NamedTemporaryFile(mode='w', suffix='.yaml', delete=False) as f:
            f.write(config_content)
            config_file = f.name

        try:
            cmd = [
                str(self.repo_path / 'rpi-image-gen'), 'build',
                '-c', config_file,
                '--dry-run'
            ]

            result = subprocess.run(cmd, capture_output=True, text=True, cwd=self.repo_path)

            if result.returncode != 0:
                print(f"Build failed: {result.stderr}")
                return False

            # Check that expected layers are included
            if 'apparmor-core' not in result.stdout:
                print("apparmor-core layer not found in build output")
                return False

            return True

        finally:
            os.unlink(config_file)

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
# test_suite = IntegrationTestSuite("/path/to/rpi-image-gen")
# test_suite.run_test("minimal security config", test_suite.test_minimal_security_config)
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI/CD üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### GitHub Actions Workflow
```yaml
name: Build and Test Extension
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static binfmt-support

    - name: Lint extension
      run: |
        rpi-image-gen metadata --lint layer/*.yaml
        rpi-image-gen layer --lint layer/*.yaml

    - name: Run unit tests
      run: |
        python3 -m pytest tests/unit/ -v

    - name: Build test image
      run: |
        rpi-image-gen build -c tests/test-config.yaml --dry-run

    - name: Generate SBOM
      run: |
        rpi-image-gen build -c config.yaml --sbom
```

### GitLab CI Pipeline
```yaml
stages:
  - validate
  - test
  - build
  - deploy

validate_extension:
  stage: validate
  script:
    - rpi-image-gen metadata --lint layer/*.yaml
    - rpi-image-gen layer --describe $CI_EXTENSION_LAYER

test_extension:
  stage: test
  script:
    - python3 -m pytest tests/ --junitxml=report.xml
  artifacts:
    reports:
      junit: report.xml

build_image:
  stage: build
  script:
    - rpi-image-gen build -c config.yaml
  artifacts:
    paths:
      - work/image-*/image-*.img
    expire_in: 1 week

security_scan:
  stage: build
  script:
    - rpi-image-gen build -c config.yaml --sbom --cve-check
  allow_failure: true
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- [ ] –í—Å–µ –º–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (100% —É—Å–ø–µ—Ö)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- [ ] –°–±–æ—Ä–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –†–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞ –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö
- [ ] –í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ –ø—Ä–∏–µ–º–ª–µ–º–æ–µ

### –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- [ ] –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ —Ç–µ—Å—Ç–∞–º–∏ > 80%
- [ ] –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- [ ] –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
- [ ] –ù–∞–ª–∏—á–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- [ ] –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
- [ ] –¢–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ CI/CD
- [ ] –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞ –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫

## –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ ‚ùå –ó–ê–ü–†–ï–©–ï–ù–´

### –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ "—Å—á–∞—Å—Ç–ª–∏–≤–æ–≥–æ –ø—É—Ç–∏"
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ edge cases
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—à–∏–±–æ–∫
- –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

### –ù–∞—Ä—É—à–µ–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
- –ü—Ä–æ–ø—É—Å–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤
- –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –ø—Ä–æ–µ–∫—Ç–∞

## –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞
- [ ] –ù–∞–ª–∏—á–∏–µ –ø–æ–ª–Ω–æ–π —Ç–µ—Å—Ç–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- [ ] –†–µ–≥—É–ª—è—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI/CD —Å–∏—Å—Ç–µ–º–∞–º–∏
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞