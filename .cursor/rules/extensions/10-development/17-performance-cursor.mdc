---
alwaysApply: ${cursor.file.path.includes("layer/") || cursor.file.path.includes("config/")}
---

# Правило 17-3: Автоматическая проверка оптимизации в Cursor

## Назначение правила
Определяет стандарты автоматической проверки и оптимизации производительности в среде разработки Cursor IDE.

## Автоматическая проверка оптимизации в Cursor

### Правила линтинга производительности
- [ ] Предупреждение о множественных обновлениях initramfs
- [ ] Предупреждение об избыточных проверках пакетов
- [ ] Проверка идемпотентности операций
- [ ] Предупреждение о небезопасных перезаписях файлов
- [ ] Проверка на использование кэширования
- [ ] Анализ размера результирующего образа

### Code Actions для оптимизации
```bash
# Автоматические предложения оптимизации
# "Объединить множественные update-initramfs в один"
# "Убрать избыточную проверку пакета"
# "Сделать операцию идемпотентной: добавить проверку существования"
# "Использовать условное создание файла вместо перезаписи"
# "Использовать parallel для установки пакетов"
# "Добавить кэширование apt"
```

### Исключения: явно новые файлы 🔴 ОБЯЗАТЕЛЬНЫЕ

#### Когда можно перезаписывать файлы
```bash
# ✅ РАЗРЕШЕНО - создание явно новых файлов для расширения
mmdebstrap:
  customize-hooks:
    - |
      #!/bin/bash
      set -euo pipefail

      # Создание новых конфигурационных файлов расширения
      # Эти файлы создаются расширением и должны быть его собственностью
      cat > /etc/my-extension/config.yaml << 'EOF'
      # Новый конфигурационный файл расширения
      setting1: value1
      setting2: value2
      EOF

      # Создание новых скриптов расширения
      cat > /usr/local/bin/my-extension-script.sh << 'EOF'
      #!/bin/bash
      echo "Extension script"
      EOF
      chmod +x /usr/local/bin/my-extension-script.sh

      # Создание новых systemd unit файлов
      cat > /etc/systemd/system/my-extension.service << 'EOF'
      [Unit]
      Description=My Extension Service

      [Service]
      ExecStart=/usr/local/bin/my-extension-script.sh
      Restart=always

      [Install]
      WantedBy=multi-user.target
      EOF

# ❌ ЗАПРЕЩЕНО - перезапись системных файлов без проверки
customize-hooks:
  - |
    # Перезапись системного файла без необходимости
    cat > /etc/fstab << 'EOF'  # Уничтожает существующую конфигурацию!
    # Перезаписан расширением - потеряны системные mount точки
    EOF
```

#### Правила для новых файлов
1. **Новые файлы расширения** - можно создавать и перезаписывать
2. **Системные файлы** - только модифицировать идемпотентно
3. **Пользовательские файлы** - проверять существование и создавать backups
4. **Конфигурационные файлы** - использовать append или условную замену

