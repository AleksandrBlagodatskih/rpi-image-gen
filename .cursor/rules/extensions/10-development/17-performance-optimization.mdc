---
alwaysApply: ${cursor.file.path.includes("layer/") || cursor.file.path.includes("config/")}
---

# –ü—Ä–∞–≤–∏–ª–æ 17: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π rpi-image-gen, –≤–∫–ª—é—á–∞—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–∞–∫–µ—Ç–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è initramfs.

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–∞–∫–µ—Ç–æ–≤

### –ü—Ä–∏–Ω—Ü–∏–ø: –ü–∞–∫–µ—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

#### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ - –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫
```yaml
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ –ø–∞–∫–µ—Ç—ã —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
mmdebstrap:
  packages:
    - nginx
    - curl
    - wget
  customize-hooks:
    - |
      #!/bin/bash
      set -euo pipefail

      # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
      if ! command -v nginx >/dev/null 2>&1; then
        die "nginx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞"
      fi

      # –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
      # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ curl –∏ wget —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ packages
```

#### –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ - –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
```yaml
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–º–µ–¥–ª—è—é—Ç —Å–±–æ—Ä–∫—É
mmdebstrap:
  packages:
    - nginx
    - curl
    - wget
  customize-hooks:
    - |
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø–∞–∫–µ—Ç - –∑–∞–º–µ–¥–ª—è–µ—Ç —Å–±–æ—Ä–∫—É
      for pkg in nginx curl wget jq netcat-openbsd; do
        if ! command -v "$pkg" >/dev/null 2>&1; then
          echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ $pkg..."
          apt-get update && apt-get install -y "$pkg"
        fi
      done

      # –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
      [[ -x "$(command -v nginx)" ]] || die "nginx failed"
      [[ -x "$(command -v curl)" ]] || die "curl failed"
```

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

#### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ - –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
```yaml
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
mmdebstrap:
  packages:
    - nginx
    - curl
  customize-hooks:
    - |
      #!/bin/bash
      set -euo pipefail

      # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
      if [[ ! -f /etc/nginx/sites-available/default ]]; then
        cat > /etc/nginx/sites-available/default << 'EOF'
        server {
            listen 80 default_server;
            root /var/www/html;
            index index.html;
        }
        EOF
      fi

      # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
      if ! grep -q "client_max_body_size" /etc/nginx/nginx.conf; then
        sed -i '/http {/a \    client_max_body_size 100M;' /etc/nginx/nginx.conf
      fi

      # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
      [[ -d /var/log/nginx ]] || mkdir -p /var/log/nginx
      [[ -d /var/cache/nginx ]] || mkdir -p /var/cache/nginx

      # –í–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω
      if ! systemctl is-enabled nginx >/dev/null 2>&1; then
        systemctl enable nginx
      fi

      # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      if [[ -f /etc/nginx/nginx.conf ]]; then
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ checksum –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
        local current_checksum=$(md5sum /etc/nginx/nginx.conf | cut -d' ' -f1)
        sed -i '/worker_processes/auto/a worker_rlimit_nofile 1024;' /etc/nginx/nginx.conf
        local new_checksum=$(md5sum /etc/nginx/nginx.conf | cut -d' ' -f1)

        if [[ "$current_checksum" != "$new_checksum" ]]; then
          echo "Nginx config updated, reload needed"
          # –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
          touch /tmp/nginx-reload-needed
        fi
      fi
```

#### –®–∞–±–ª–æ–Ω—ã –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

##### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
```bash
# –®–∞–±–ª–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
create_config_file() {
  local file_path="$1"
  local content="$2"
  local backup="${3:-true}"

  # –°–æ–∑–¥–∞–Ω–∏–µ backup –µ—Å–ª–∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if [[ -f "$file_path" && "$backup" == "true" ]]; then
    cp "$file_path" "${file_path}.backup.$(date +%Y%m%d_%H%M%S)"
  fi

  # –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–æ–π
  if [[ ! -f "$file_path" || ! -s "$file_path" ]]; then
    echo "$content" > "$file_path"
    echo "Created: $file_path"
  else
    echo "Skipped (exists): $file_path"
  fi
}

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
create_config_file "/etc/myapp/config.conf" "setting=value"
```

##### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
```bash
# –®–∞–±–ª–æ–Ω –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
add_config_line() {
  local file_path="$1"
  local line="$2"
  local marker="${3:-}"

  if [[ -n "$marker" ]]; then
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å –º–∞—Ä–∫–µ—Ä–æ–º –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    if ! grep -q "$marker" "$file_path" 2>/dev/null; then
      echo "$line #$marker" >> "$file_path"
      echo "Added to $file_path: $line"
    fi
  else
    # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
    if ! grep -q "^$(escape_sed "$line")$" "$file_path" 2>/dev/null; then
      echo "$line" >> "$file_path"
      echo "Added to $file_path: $line"
    fi
  fi
}

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
add_config_line "/etc/fstab" "UUID=123 /mnt/data ext4 defaults 0 2" "data-mount"
```

##### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞–º–∏
```bash
# –®–∞–±–ª–æ–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏
manage_service() {
  local service_name="$1"
  local action="$2"  # enable|disable|start|stop|restart
  local condition="${3:-}"  # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ

  case "$action" in
    "enable")
      if [[ -z "$condition" ]] || eval "$condition"; then
        if ! systemctl is-enabled "$service_name" >/dev/null 2>&1; then
          systemctl enable "$service_name"
          echo "Enabled service: $service_name"
        fi
      fi
      ;;
    "start")
      if ! systemctl is-active "$service_name" >/dev/null 2>&1; then
        systemctl start "$service_name"
        echo "Started service: $service_name"
      fi
      ;;
    "restart")
      if systemctl is-active "$service_name" >/dev/null 2>&1; then
        systemctl restart "$service_name"
        echo "Restarted service: $service_name"
      fi
      ;;
  esac
}

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
manage_service "nginx" "enable"
manage_service "nginx" "start"
```

##### –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≥—Ä—É–ø–ø
```bash
# –®–∞–±–ª–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
create_user_idempotent() {
  local username="$1"
  local uid="${2:-}"
  local home_dir="${3:-/home/$username}"
  local shell="${4:-/bin/bash}"

  if ! id -u "$username" >/dev/null 2>&1; then
    if [[ -n "$uid" ]]; then
      useradd -u "$uid" -m -d "$home_dir" -s "$shell" "$username"
    else
      useradd -m -d "$home_dir" -s "$shell" "$username"
    fi
    echo "Created user: $username"
  else
    echo "User exists: $username"
  fi
}

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
create_user_idempotent "appuser" "1001" "/var/lib/appuser" "/bin/false"
```

##### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞–º–∏
```bash
# –®–∞–±–ª–æ–Ω –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
install_package_if_missing() {
  local package="$1"

  if ! dpkg -l "$package" >/dev/null 2>&1; then
    echo "Installing package: $package"
    apt-get update && apt-get install -y "$package"
  else
    echo "Package already installed: $package"
  fi
}

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
install_package_if_missing "curl"
install_package_if_missing "jq"
```

#### –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ - –Ω–µ–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
```yaml
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –Ω–µ–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
mmdebstrap:
  packages:
    - nginx
  customize-hooks:
    - |
      # –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
      cat > /etc/nginx/sites-available/default << 'EOF'  # –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç!
      server {
          listen 80 default_server;
          root /var/www/html;
          index index.html;
      }
      EOF

      # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
      echo "client_max_body_size 100M;" >> /etc/nginx/nginx.conf  # –ú–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å!

      # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
      mkdir /var/log/nginx    # –û—à–∏–±–∫–∞ –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      mkdir /var/cache/nginx  # –û—à–∏–±–∫–∞ –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

      # –í–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
      systemctl enable nginx  # –û—à–∏–±–∫–∞ –µ—Å–ª–∏ —É–∂–µ –≤–∫–ª—é—á–µ–Ω
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è initramfs üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

#### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ rootfs
```yaml
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ initramfs —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Ü–µ
mmdebstrap:
  packages:
    - linux-image-arm64
    - initramfs-tools
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —è–¥—Ä–∞ –∏ –º–æ–¥—É–ª–µ–π (–±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è initramfs)
      echo "options i2c_arm on" > /etc/modprobe.d/i2c.conf
      echo "i2c-dev" >> /etc/modules
      echo "dtoverlay=vc4-fkms-v3d" >> /boot/config.txt

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ initrd (–±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
      cat > /etc/initramfs-tools/modules << 'EOF'
      # Kernel modules for initramfs
      ext4
      mmc_block
      EOF

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ initramfs —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –≤ –∫–æ–Ω—Ü–µ —Å–±–æ—Ä–∫–∏
finalize-hooks:
  - |
    # –ï–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ initramfs –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
    update-initramfs -u -k all
```

#### –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```yaml
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è initramfs
mmdebstrap:
  packages:
    - linux-image-arm64
  customize-hooks:
    - |
      # –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - –∑–∞–º–µ–¥–ª—è–µ—Ç —Å–±–æ—Ä–∫—É
      echo "dtoverlay=vc4-fkms-v3d" >> /boot/config.txt
      update-initramfs -u

    - |
      # –í—Ç–æ—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - –µ—â–µ –±–æ–ª—å—à–µ –∑–∞–º–µ–¥–ª—è–µ—Ç
      echo "i2c-dev" >> /etc/modules
      update-initramfs -u

    - |
      # –¢—Ä–µ—Ç—å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - –∫—Ä–∏—Ç–∏—á–Ω–æ –∑–∞–º–µ–¥–ª—è–µ—Ç
      cat > /etc/initramfs-tools/hooks/custom >> /dev/null
      update-initramfs -u
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

#### –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–±–æ—Ä–∫–∏
```bash
# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
MAX_BUILD_TIME_MINIMAL="10 minutes"      # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
MAX_BUILD_TIME_STANDARD="30 minutes"     # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
MAX_BUILD_TIME_COMPLEX="60 minutes"      # –°–ª–æ–∂–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ

# –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–±–æ—Ä–∫–∏
measure_build_time() {
    local start_time=$(date +%s)
    rpi-image-gen build -c config.yaml "$@"
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))

    echo "–í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏: $duration —Å–µ–∫—É–Ω–¥"

    if [[ $duration -gt 1800 ]]; then  # 30 –º–∏–Ω—É—Ç
        echo "–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –°–±–æ—Ä–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏"
        return 1
    fi

    return 0
}
```

#### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞
```yaml
# –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞
mmdebstrap:
  variant: minbase  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –±–∞–∑—É
  packages:
    - essential    # –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã
    - --no-install-recommends  # –ë–µ–∑ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤

  customize-hooks:
    - |
      # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–∞–∫–µ—Ç–æ–≤
      apt-get clean
      rm -rf /var/lib/apt/lists/*

      # –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
      rm -rf /usr/share/doc/*
      rm -rf /usr/share/man/*
      rm -rf /usr/share/locale/*  # –ï—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω—ã –ª–æ–∫–∞–ª–∏
```

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏

#### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ apt –ø–∞–∫–µ—Ç–æ–≤
```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ apt-cacher
setup_apt_cache() {
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ apt-cacher-ng –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
    apt-get install -y apt-cacher-ng

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
    echo 'Acquire::http::Proxy "http://localhost:3142";' > /etc/apt/apt.conf.d/01proxy

    # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
    systemctl enable apt-cacher-ng
    systemctl start apt-cacher-ng
}
```

#### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Docker –æ–±—Ä–∞–∑–æ–≤
```yaml
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–∑–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤
mmdebstrap:
  variant: docker  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker-like —Å–ª–æ–∏
  packages:
    - base-files
    - base-passwd

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–±–æ—Ä–æ–∫
build-cache:
  enable: true
  layers:
    - base-system
    - development-tools
    - runtime-dependencies
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –∏ CPU
```bash
# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è —Å–±–æ—Ä–∫–∏
build_with_limits() {
    local mem_limit="2G"
    local cpu_limit="2"

    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ systemd-run –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
    systemd-run --scope \
        --property=MemoryLimit="$mem_limit" \
        --property=CPUQuota="$((cpu_limit * 100))%" \
        rpi-image-gen build -c config.yaml
}
```

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
```bash
# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
parallel_package_install() {
    local packages=("nginx" "php" "mysql-server" "redis-server")

    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å –ø–æ–º–æ—â—å—é xargs
    printf '%s\n' "${packages[@]}" | \
        xargs -n 1 -P 4 apt-get install -y --no-install-recommends
}
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–±–æ—Ä–∫–∏

profile_build() {
    local config_file="$1"
    local profile_log="/tmp/build-profile-$(date +%s).log"

    echo "–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏: $config_file" > "$profile_log"

    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
    {
        echo "Timestamp,CPU%,Memory%,Disk_IO,Build_Step"
        local step="init"

        while ps aux | grep -q "rpi-image-gen.*build"; do
            local timestamp=$(date +%s)
            local cpu=$(top -bn1 | grep -E "(rpi-image-gen|mmdebstrap)" | awk '{sum += $9} END {print sum}' || echo "0")
            local mem=$(free | awk 'NR==2{printf "%.2f", $3*100/$2}' || echo "0")
            local disk_io=$(iostat -x 1 1 2>/dev/null | awk 'NR==4{print $4 + $5}' || echo "0")

            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞ —Å–±–æ—Ä–∫–∏
            if ps aux | grep -q "mmdebstrap.*packages"; then
                step="packages"
            elif ps aux | grep -q "customize.*hook"; then
                step="customize"
            elif ps aux | grep -q "update-initramfs"; then
                step="initramfs"
            fi

            echo "${timestamp},${cpu},${mem},${disk_io},${step}"
            sleep 5
        done
    } >> "$profile_log"

    echo "–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω: $profile_log"
}
```

### –ú–µ—Ç—Ä–∏–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```yaml
# –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
performance_metrics:
  build_time:
    target: "< 30 min"
    current: "25 min"
    status: "‚úÖ OK"

  image_size:
    target: "< 2GB"
    current: "1.8GB"
    status: "‚úÖ OK"

  package_checks:
    target: "0 redundant checks"
    current: "0"
    status: "‚úÖ OK"

  initramfs_updates:
    target: "1 update per build"
    current: "1"
    status: "‚úÖ OK"
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
1. **–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞—Ä–∞–Ω–µ–µ
2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤
3. **–ë–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
4. **–ú–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω–∞—è —Å–±–æ—Ä–∫–∞** - —Ä–∞–∑–¥–µ–ª–∏—Ç—å —Å–±–æ—Ä–∫—É –Ω–∞ —ç—Ç–∞–ø—ã –¥–ª—è –ª—É—á—à–µ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```yaml
# –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±–æ—Ä–∫–∏
device:
  layer: pi5
  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

image:
  layer: image-rpios
  boot_part_size: 256M  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
  root_part_size: 4G    # –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞

layer:
  base: bookworm-minbase  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –±–∞–∑–∞
  # –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–ª–æ–∏
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ª—É—á—à–µ–Ω–∏–µ
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
analyze_performance() {
    local build_log="$1"

    echo "–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏..."

    # –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ —ç—Ç–∞–ø–∞–º
    grep "duration\|time" "$build_log" | while read -r line; do
        echo "–≠—Ç–∞–ø: $line"
    done

    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    if grep -q "update-initramfs" "$build_log"; then
        local initramfs_count=$(grep -c "update-initramfs" "$build_log")
        if [[ $initramfs_count -gt 1 ]]; then
            echo "–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è initramfs ($initramfs_count)"
            echo "–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –û–±–Ω–æ–≤–ª—è–π—Ç–µ initramfs —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤ –∫–æ–Ω—Ü–µ"
        fi
    fi
}
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤ Cursor

### –ü—Ä–∞–≤–∏–ª–∞ –ª–∏–Ω—Ç–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö initramfs
- [ ] –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–± –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö –ø–∞–∫–µ—Ç–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–ø–∏—Å—è—Ö —Ñ–∞–π–ª–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–µ–≥–æ –æ–±—Ä–∞–∑–∞

### Code Actions –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
# "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ update-initramfs –≤ –æ–¥–∏–Ω"
# "–£–±—Ä–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–∞–∫–µ—Ç–∞"
# "–°–¥–µ–ª–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è"
# "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏"
# "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å parallel –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤"
# "–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ apt"
```

### –ò—Å–∫–ª—é—á–µ–Ω–∏—è: —è–≤–Ω–æ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

#### –ö–æ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ñ–∞–π–ª—ã
```bash
# ‚úÖ –†–ê–ó–†–ï–®–ï–ù–û - —Å–æ–∑–¥–∞–Ω–∏–µ —è–≤–Ω–æ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
mmdebstrap:
  customize-hooks:
    - |
      #!/bin/bash
      set -euo pipefail

      # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
      # –≠—Ç–∏ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é
      cat > /etc/my-extension/config.yaml << 'EOF'
      # –ù–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
      setting1: value1
      setting2: value2
      EOF

      # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
      cat > /usr/local/bin/my-extension-script.sh << 'EOF'
      #!/bin/bash
      echo "Extension script"
      EOF
      chmod +x /usr/local/bin/my-extension-script.sh

      # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö systemd unit —Ñ–∞–π–ª–æ–≤
      cat > /etc/systemd/system/my-extension.service << 'EOF'
      [Unit]
      Description=My Extension Service

      [Service]
      ExecStart=/usr/local/bin/my-extension-script.sh
      Restart=always

      [Install]
      WantedBy=multi-user.target
      EOF

# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
customize-hooks:
  - |
    # –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    cat > /etc/fstab << 'EOF'  # –£–Ω–∏—á—Ç–æ–∂–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é!
    # –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º - –ø–æ—Ç–µ—Ä—è–Ω—ã —Å–∏—Å—Ç–µ–º–Ω—ã–µ mount —Ç–æ—á–∫–∏
    EOF
```

#### –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
1. **–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è** - –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å
2. **–°–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã** - —Ç–æ–ª—å–∫–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ–∞–π–ª—ã** - –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å backups
4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å append –∏–ª–∏ —É—Å–ª–æ–≤–Ω—É—é –∑–∞–º–µ–Ω—É

## –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã ‚ùå –ó–ê–ü–†–ï–©–ï–ù–´

### –ù–µ–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
```bash
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –Ω–µ–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
cat > /etc/nginx/sites-available/default << 'EOF'  # –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç!
server { ... }
EOF

# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –Ω–µ–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
echo "setting=value" >> /etc/config.conf  # –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã

# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –Ω–µ–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
mkdir /var/log/app  # –û—à–∏–±–∫–∞ –µ—Å–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –Ω–µ–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏
systemctl enable myservice  # –û—à–∏–±–∫–∞ –µ—Å–ª–∏ —É–∂–µ –≤–∫–ª—é—á–µ–Ω
```

### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
```bash
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
if ! command -v package1; then apt-get install package1; fi
if ! command -v package2; then apt-get install package2; fi
if ! command -v package1; then echo "package1 check again"; fi  # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```

### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è initramfs
```bash
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
update-initramfs -u  # –ü–µ—Ä–≤–æ–µ
# ... –¥—Ä—É–≥–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ...
update-initramfs -u  # –í—Ç–æ—Ä–æ–µ
# ... –µ—â–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ...
update-initramfs -u  # –¢—Ä–µ—Ç—å–µ - –∑–∞–º–µ–¥–ª—è–µ—Ç —Å–±–æ—Ä–∫—É –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ
```

### –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
```bash
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
apt-get update  # –ö–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–Ω–æ–≤–æ
apt-get install package  # –ë–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞
```

### –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
```bash
# ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û - –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
cat > /etc/fstab << 'EOF'  # –£–Ω–∏—á—Ç–æ–∂–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
# –ü–æ—Ç–µ—Ä—è–Ω—ã –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ mount —Ç–æ—á–∫–∏
EOF

cat > /etc/passwd << 'EOF'  # –£–Ω–∏—á—Ç–æ–∂–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ–π
EOF
```

---

## –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
- [ ] –ü—Ä–∞–≤–∏–ª–æ –∏–∑—É—á–µ–Ω–æ –∏ –ø–æ–Ω—è—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- [ ] –°–æ–±–ª—é–¥–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –≤ CI/CD
- [ ] –ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –º–µ—Ä–¥–∂–∞
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞
- [ ] –†–µ–≥—É–ª—è—Ä–Ω—ã–π –∞—É–¥–∏—Ç —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞

### –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
- [ ] 100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ –Ω–æ–≤–æ–º –∫–æ–¥–µ
- [ ] –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–µ—Ç–∫–∞—Ö
- [ ] –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã (–º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏—è
- [ ] –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –∫–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- [ ] –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ –ø—Ä–∞–≤–∏–ª–∞

### –ú–µ—Ç—Ä–∏–∫–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- [ ] –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –§–∞–π–ª—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º/–∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
- [ ] –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
- [ ] –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏

### –ò—Å—Ç–æ—á–Ω–∏–∫
–°–æ–∑–¥–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏ rpi-image-gen —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π