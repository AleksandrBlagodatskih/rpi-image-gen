---
alwaysApply: ${cursor.file.path.includes("layer/") || cursor.file.path.includes("config/")}
---


# –ü—Ä–∞–≤–∏–ª–æ 12: –ü—Ä–∞–≤–∏–ª–∞ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ–¥–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π rpi-image-gen.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

```
rpi-image-gen/
‚îú‚îÄ‚îÄ bin/                    # –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã –∏ —É—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ config/                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–±–æ—Ä–∫–∏
‚îú‚îÄ‚îÄ device/                 # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚îú‚îÄ‚îÄ docs/                   # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ examples/               # –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ image/                  # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–∑–æ–≤
‚îú‚îÄ‚îÄ layer/                  # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–ª–æ–µ–≤ —Å–∏—Å—Ç–µ–º—ã
‚îú‚îÄ‚îÄ layer-hooks/           # –•—É–∫–∏ –¥–ª—è —Å–ª–æ–µ–≤
‚îú‚îÄ‚îÄ lib/                    # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
‚îú‚îÄ‚îÄ scripts/               # –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤ —Å–±–æ—Ä–∫–∏
‚îú‚îÄ‚îÄ site/                  # Python –º–æ–¥—É–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ templates/             # –®–∞–±–ª–æ–Ω—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ test/                  # –¢–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
‚îî‚îÄ‚îÄ work/                  # –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–±–æ—Ä–∫–∏
```

## bin/ - –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã –∏ —É—Ç–∏–ª–∏—Ç—ã üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ö–∞—Ç–∞–ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å rpi-image-gen.

### –ü—Ä–∞–≤–∏–ª–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
- **–ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã**: `*.sh` (bash —Å–∫—Ä–∏–ø—Ç—ã)
- **–ë–∏–Ω–∞—Ä–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã**: –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏–ª–∏ `.py` –¥–ª—è Python —Å–∫—Ä–∏–ø—Ç–æ–≤
- **–£—Ç–∏–ª–∏—Ç—ã**: `*-helper`, `*-tool`, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è

### –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
```bash
#!/bin/bash
# shellcheck disable=SC2154,SC2086

set -euo pipefail

# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
readonly SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}")"
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log_info() { echo "[$SCRIPT_NAME] INFO: $*"; }
log_warn() { echo "[$SCRIPT_NAME] WARN: $*" >&2; }
log_error() { echo "[$SCRIPT_NAME] ERROR: $*" >&2; }

# –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å –æ—à–∏–±–∫–æ–π
die() {
    log_error "$*"
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check_dependencies() {
    local deps=("tool1" "tool2" "tool3")
    for dep in "${deps[@]}"; do
        command -v "$dep" >/dev/null 2>&1 || die "–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: $dep"
    done
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    check_dependencies

    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
    log_info "–ó–∞–ø—É—Å–∫ –æ–ø–µ—Ä–∞—Ü–∏–∏"

    # –í–æ–∑–≤—Ä–∞—Ç –∫–æ–¥–∞ —É—Å–ø–µ—Ö–∞
    return 0
}

# –ó–∞–ø—É—Å–∫ –≥–ª–∞–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main "$@"
```

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **–£—Ç–∏–ª–∏—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏** –¥–æ–ª–∂–Ω—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å `--help` –∏ `--version`
- **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã** –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `$INTERACTIVE`
- **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `set -euo pipefail`

### –ü—Ä–∏–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤
- `runner` - –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å —Ö—É–∫–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
- `uchroot` - –±–µ–∑–æ–ø–∞—Å–Ω—ã–π chroot –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
- `ig` - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ—è–º–∏

## config/ - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–±–æ—Ä–∫–∏ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤ –≤ YAML —Ñ–æ—Ä–º–∞—Ç–µ.

### –ü—Ä–∞–≤–∏–ª–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
- **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**: `{distro}-{variant}.yaml` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `bookworm-minbase.yaml`)
- **–°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**: `{feature}-{distro}.yaml`
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**: `{project}-{config}.yaml`

### –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
```yaml
# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞)
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Debian Bookworm
# –í–µ—Ä—Å–∏—è: 1.0.0
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: –î–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–µ—Ä–≤–æ–π –≤ —Ü–µ–ø–æ—á–∫–µ —Å–±–æ—Ä–∫–∏

# –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ–∫—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
device:
  layer: pi5                    # –°–ª–æ–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
  hostname: rpi-${HOST_SUFFIX}  # –®–∞–±–ª–æ–Ω –∏–º–µ–Ω–∏ —Ö–æ—Å—Ç–∞
  user: pi                     # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã

image:
  layer: image-rpios           # –°–ª–æ–π –æ–±—Ä–∞–∑–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
  boot_part_size: 200%         # –†–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
  root_part_size: 300%         # –†–∞–∑–º–µ—Ä –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
  name: deb12-arm64-min        # –ò–º—è —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–µ–≥–æ –æ–±—Ä–∞–∑–∞

layer:
  base: bookworm-minbase       # –ë–∞–∑–æ–≤—ã–π —Å–ª–æ–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–∏ –ø–µ—Ä–µ—á–∏—Å–ª—è—é—Ç—Å—è –∑–¥–µ—Å—å
  security: security-minimal
  network: net-misc
```

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **–ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ —Å–µ–∫—Ü–∏—è–º–∏
- **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** –≤ —Ñ–æ—Ä–º–∞—Ç–µ `${VAR_NAME}`
- **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏** –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–∂–¥–æ–π —Å–µ–∫—Ü–∏–∏

## device/ - –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ ‚ö†Ô∏è –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π Raspberry Pi.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
```
device/
‚îú‚îÄ‚îÄ {device_name}/           # –ù–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (pi5, cm4, zero2w)
‚îÇ   ‚îú‚îÄ‚îÄ device.yaml         # –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
‚îÇ   ‚îú‚îÄ‚îÄ device.adoc         # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
‚îÇ   ‚îú‚îÄ‚îÄ bdebstrap/          # –•—É–∫–∏ –¥–ª—è —ç—Ç–∞–ø–æ–≤ bdebstrap
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ setup*         # –•—É–∫–∏ —ç—Ç–∞–ø–∞ setup
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ essential*     # –•—É–∫–∏ —ç—Ç–∞–ø–∞ essential
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ customize*     # –•—É–∫–∏ —ç—Ç–∞–ø–∞ customize
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cleanup*       # –•—É–∫–∏ —ç—Ç–∞–ø–∞ cleanup
‚îÇ   ‚îú‚îÄ‚îÄ initramfs-tools/   # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ initramfs
‚îÇ   ‚îî‚îÄ‚îÄ rootfs-overlay/    # –û–≤–µ—Ä–ª–µ–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
```

### –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è device.yaml
```yaml
# METABEGIN
# X-Env-Layer-Name: pi5
# X-Env-Layer-Category: device
# X-Env-Layer-Description: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Raspberry Pi 5
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,rpi-base
# X-Env-VarPrefix: rpi5
#
# X-Env-Var-firmware_version: latest
# X-Env-Var-firmware_version-Description: –í–µ—Ä—Å–∏—è firmware –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
# X-Env-Var-firmware_version-Required: false
# X-Env-Var-firmware_version-Valid: latest,stable,beta
# METAEND
---
mmdebstrap:
  packages:
    - raspberrypi-bootloader
    - raspberrypi-kernel
    - linux-firmware-raspi
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${IGconf_device_hostname}"
```

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ö—É–∫–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
```bash
#!/bin/bash
# device/{device_name}/bdebstrap/customize-device-setup

set -euo pipefail

# –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
configure_device_specifics() {
    local device_type="$1"

    case "$device_type" in
        "pi5")
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è Raspberry Pi 5
            configure_pi5_specifics
            ;;
        "cm4")
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è Compute Module 4
            configure_cm4_specifics
            ;;
        *)
            warn "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: $device_type"
            ;;
    esac
}

configure_pi5_specifics() {
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è Pi 5
    apt-get install -y raspberrypi-bootloader-pi5

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —è–¥—Ä–∞
    cat >> /etc/modules << 'EOF'
bcm2712_wdt
bcm2712_thermal
EOF
}

# –í—ã–∑–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
configure_device_specifics "${IGconf_device_type:-pi5}"
```

## docs/ - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
```
docs/
‚îú‚îÄ‚îÄ api/                    # API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ guides/                 # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ architecture/           # –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ deployment/             # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ troubleshooting/        # –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π
‚îî‚îÄ‚îÄ examples/               # –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

### –§–æ—Ä–º–∞—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- **README.md** - –æ—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
- **CHANGELOG.md** - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **CONTRIBUTING.md** - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–æ–≤
- **API.md** - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

### –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```markdown
# –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞

[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Version](https://img.shields.io/badge/Version-1.0.0-green.svg)](https://github.com/user/project/releases)

## –û–ø–∏—Å–∞–Ω–∏–µ

–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–†–∞–∑–¥–µ–ª 1](#—Ä–∞–∑–¥–µ–ª-1)
- [–†–∞–∑–¥–µ–ª 2](#—Ä–∞–∑–¥–µ–ª-2)

## –†–∞–∑–¥–µ–ª 1

### –ü–æ–¥—Ä–∞–∑–¥–µ–ª

–ö–æ–¥ –ø—Ä–∏–º–µ—Ä–∞:

```bash
# –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞
echo "Hello World"
```

### –¢–∞–±–ª–∏—Ü–∞

| –°—Ç–æ–ª–±–µ—Ü 1 | –°—Ç–æ–ª–±–µ—Ü 2 | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|-----------|----------|
| –ó–Ω–∞—á–µ–Ω–∏–µ 1 | –ó–Ω–∞—á–µ–Ω–∏–µ 2 | –û–ø–∏—Å–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è |

## –°—Å—ã–ª–∫–∏

- [–°—Å—ã–ª–∫–∞ 1](url1)
- [–°—Å—ã–ª–∫–∞ 2](url2)
```

## examples/ - –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ‚ö†Ô∏è –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–†–∞–±–æ—á–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
```
examples/
‚îú‚îÄ‚îÄ basic/                  # –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
‚îú‚îÄ‚îÄ advanced/               # –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø—Ä–∏–º–µ—Ä—ã
‚îú‚îÄ‚îÄ device-specific/        # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚îú‚îÄ‚îÄ industry/               # –û—Ç—Ä–∞—Å–ª–µ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
‚îî‚îÄ‚îÄ tutorials/              # –ü–æ—à–∞–≥–æ–≤—ã–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
```

### –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤
```yaml
# examples/basic/web-kiosk-config.yaml
---
# –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–µ–±-–∫–∏–æ—Å–∫–∞
# –≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–∑–æ–≤—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫–∞–∫ –≤–µ–±-–∫–∏–æ—Å–∫–∞

device:
  layer: pi4
  hostname: kiosk-001
  user: kiosk

image:
  layer: image-rpios
  boot_part_size: 200M
  root_part_size: 100%
  name: kiosk-image

layer:
  base: bookworm-minbase
  extension: web-kiosk

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
extension:
  layer: web-kiosk
  url: https://example.com
  autostart: true
```

## image/ - –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–∑–æ–≤ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–±—Ä–∞–∑–æ–≤ –¥–∏—Å–∫–æ–≤.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
```
image/{partition_scheme}/{image_name}/
‚îú‚îÄ‚îÄ image.yaml                    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–æ—è
‚îú‚îÄ‚îÄ genimage.cfg.in.ext4         # –®–∞–±–ª–æ–Ω –¥–ª—è ext4
‚îú‚îÄ‚îÄ genimage.cfg.in.btrfs        # –®–∞–±–ª–æ–Ω –¥–ª—è btrfs
‚îú‚îÄ‚îÄ pre-image.sh                 # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–±—Ä–∞–∑–∞
‚îú‚îÄ‚îÄ setup.sh                     # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–¥–µ–ª–æ–≤
‚îú‚îÄ‚îÄ mke2fs.conf                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ext4
‚îî‚îÄ‚îÄ device/                      # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ‚îú‚îÄ‚îÄ provisionmap-*.json      # –ö–∞—Ä—Ç—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    ‚îî‚îÄ‚îÄ *.rules                  # –ü—Ä–∞–≤–∏–ª–∞ udev
```

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **image.yaml** - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–æ—è
- **genimage.cfg.in.* ** - —à–∞–±–ª–æ–Ω—ã genimage
- **pre-image.sh** - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–±—Ä–∞–∑–∞
- **setup.sh** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–¥–µ–ª–æ–≤

## layer/ - –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–ª–æ–µ–≤ —Å–∏—Å—Ç–µ–º—ã üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–û—Å–Ω–æ–≤–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–ª–æ–µ–≤ —Å–∏—Å—Ç–µ–º—ã rpi-image-gen.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–ª–æ–µ–≤
```
layer/
‚îú‚îÄ‚îÄ essential/               # –ë–∞–∑–æ–≤—ã–µ —Å–ª–æ–∏
‚îú‚îÄ‚îÄ device/                  # –°–ª–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚îú‚îÄ‚îÄ image/                   # –°–ª–æ–∏ –æ–±—Ä–∞–∑–æ–≤
‚îú‚îÄ‚îÄ extension/               # –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
‚îú‚îÄ‚îÄ suite/                   # –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
‚îî‚îÄ‚îÄ *-base/                  # –ë–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

### –§–æ—Ä–º–∞—Ç —Å–ª–æ—è
```yaml
# METABEGIN
# X-Env-Layer-Name: {unique-name}
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,{dependencies}
# X-Env-VarPrefix: {prefix}
#
# X-Env-Var-{variable}: {default}
# X-Env-Var-{variable}-Description: –û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
# X-Env-Var-{variable}-Required: true|false
# X-Env-Var-{variable}-Valid: {validation_rules}
# METAEND
---
mmdebstrap:
  packages:
    - {required-packages}
  setup-hooks:
    - {setup-commands}
  customize-hooks:
    - {customization-commands}
```

## lib/ - –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã ‚ö†Ô∏è –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–û–±—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
```
lib/
‚îú‚îÄ‚îÄ common.sh               # –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ bash
‚îú‚îÄ‚îÄ validation.sh           # –§—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ logging.sh              # –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ network.sh              # –°–µ—Ç–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îú‚îÄ‚îÄ security.sh             # –§—É–Ω–∫—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ utils.sh                # –†–∞–∑–ª–∏—á–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
```

### –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫
```bash
#!/bin/bash
# lib/common.sh
# –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–¥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º
if ! declare -f log_info >/dev/null 2>&1; then

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
readonly LIB_VERSION="1.0.0"
readonly LIB_NAME="common"

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log_info() {
    echo "[$LIB_NAME] INFO: $*"
}

log_warn() {
    echo "[$LIB_NAME] WARN: $*" >&2
}

log_error() {
    echo "[$LIB_NAME] ERROR: $*" >&2
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å –æ—à–∏–±–∫–æ–π
die() {
    log_error "$*"
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check_command() {
    local cmd="$1"
    command -v "$cmd" >/dev/null 2>&1
}

fi # –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π
```

## scripts/ - –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤ —Å–±–æ—Ä–∫–∏ ‚ö†Ô∏è –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤ —Å–±–æ—Ä–∫–∏.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
```
scripts/
‚îú‚îÄ‚îÄ build/                  # –°–∫—Ä–∏–ø—Ç—ã —Å–±–æ—Ä–∫–∏
‚îú‚îÄ‚îÄ test/                   # –°–∫—Ä–∏–ø—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ deploy/                 # –°–∫—Ä–∏–ø—Ç—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ ci/                     # CI/CD —Å–∫—Ä–∏–ø—Ç—ã
‚îî‚îÄ‚îÄ maintenance/            # –°–∫—Ä–∏–ø—Ç—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
```

### –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤
```bash
#!/bin/bash
# scripts/build/prepare-environment.sh
# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ä–µ–¥—ã —Å–±–æ—Ä–∫–∏

set -euo pipefail

SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
source "${SCRIPT_DIR}/../lib/common.sh"

main() {
    log_info "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ä–µ–¥—ã —Å–±–æ—Ä–∫–∏"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
    check_system_requirements

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    setup_environment_variables

    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    create_build_directories

    log_info "–°—Ä–µ–¥–∞ —Å–±–æ—Ä–∫–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞"
}

check_system_requirements() {
    local required_commands=("git" "docker" "qemu-user-static")

    for cmd in "${required_commands[@]}"; do
        if ! check_command "$cmd"; then
            die "–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: $cmd"
        fi
    done
}

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main "$@"
```

## test/ - –¢–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
```
test/
‚îú‚îÄ‚îÄ unit/                   # –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ integration/            # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ e2e/                    # End-to-end —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ fixtures/               # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îî‚îÄ‚îÄ utils/                  # –¢–µ—Å—Ç–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã
```

### –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```bash
#!/bin/bash
# test/unit/test_validation.sh
# –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
source "${SCRIPT_DIR}/../../lib/validation.sh"

# –°—á–µ—Ç—á–∏–∫–∏ —Ç–µ—Å—Ç–æ–≤
TESTS_RUN=0
TESTS_PASSED=0
TESTS_FAILED=0

# –§—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
run_test() {
    local test_name="$1"
    local test_function="$2"

    ((TESTS_RUN++))
    echo -n "–¢–µ—Å—Ç: $test_name ... "

    if $test_function; then
        echo "–ü–†–û–ô–î–ï–ù"
        ((TESTS_PASSED++))
    else
        echo "–ü–†–û–í–ê–õ–ï–ù"
        ((TESTS_FAILED++))
    fi
}

# –¢–µ—Å—Ç—ã
test_validate_email() {
    validate_email "test@example.com" && \
    ! validate_email "invalid-email"
}

test_validate_ip() {
    validate_ip "192.168.1.1" && \
    ! validate_ip "256.1.1.1"
}

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
main() {
    echo "–ó–∞–ø—É—Å–∫ –º–æ–¥—É–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"

    run_test "validate_email" test_validate_email
    run_test "validate_ip" test_validate_ip

    echo ""
    echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: $TESTS_PASSED/$TESTS_RUN —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ"

    if [[ $TESTS_FAILED -gt 0 ]]; then
        echo "–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: $TESTS_FAILED"
        exit 1
    fi
}

main "$@"
```

## work/ - –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–±–æ—Ä–∫–∏ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤ (–Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ git).

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
```
work/
‚îú‚îÄ‚îÄ image-{timestamp}/       # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–±–æ—Ä–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ rootfs/             # –ö–æ—Ä–Ω–µ–≤–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
‚îÇ   ‚îú‚îÄ‚îÄ boot/               # –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª
‚îÇ   ‚îú‚îÄ‚îÄ data/               # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îÇ   ‚îú‚îÄ‚îÄ image.img           # –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑
‚îÇ   ‚îî‚îÄ‚îÄ logs/               # –õ–æ–≥–∏ —Å–±–æ—Ä–∫–∏
‚îî‚îÄ‚îÄ cache/                   # –ö—ç—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
    ‚îú‚îÄ‚îÄ apt/                # –ö—ç—à –ø–∞–∫–µ—Ç–æ–≤ apt
    ‚îú‚îÄ‚îÄ docker/             # –ö—ç—à Docker
    ‚îî‚îÄ‚îÄ pip/                # –ö—ç—à Python –ø–∞–∫–µ—Ç–æ–≤
```

### –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ `.gitignore`
- –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Å–±–æ—Ä–æ–∫

## templates/ - –®–∞–±–ª–æ–Ω—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ‚ö†Ô∏è –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–®–∞–±–ª–æ–Ω—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
```
templates/
‚îú‚îÄ‚îÄ docs/                   # –®–∞–±–ª–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ config/                 # –®–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ scripts/                # –®–∞–±–ª–æ–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–≤
‚îî‚îÄ‚îÄ ci/                     # –®–∞–±–ª–æ–Ω—ã CI/CD
```

### –ü—Ä–∏–º–µ—Ä —à–∞–±–ª–æ–Ω–∞
```jinja2
# templates/docs/layer-readme.md.j2
# –®–∞–±–ª–æ–Ω README –¥–ª—è —Å–ª–æ—è

# {{ layer_name }}

{{ layer_description }}

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
rpi-image-gen layer install {{ layer_name }}
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

{% for var in variables %}
### {{ var.name }}
- **–û–ø–∏—Å–∞–Ω–∏–µ**: {{ var.description }}
- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é**: {{ var.default }}
- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**: {{ var.required }}
{% if var.validation %}
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: {{ var.validation }}
{% endif %}
{% endfor %}

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```yaml
layer:
  {{ category }}: {{ layer_name }}
  {% for var in variables %}
  {{ var.name }}: {{ var.default }}
  {% endfor %}
```
```

## –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ üî¥ –û–í–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- [ ] –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- [ ] –§–∞–π–ª—ã —Ä–∞–∑–º–µ—â–µ–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–∞—Ö
- [ ] –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –ø—Ä–æ–µ–∫—Ç–∞
- [ ] –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ –ø–æ –∫–∞—Ç–∞–ª–æ–≥–∞–º
- [ ] bin/ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
- [ ] config/ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç YAML
- [ ] layer/ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–æ–µ–≤
- [ ] test/ –∏–º–µ–µ—Ç –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
- [ ] docs/ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

### –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
- [ ] –°—Ç–∏–ª–∏ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –µ–¥–∏–Ω—ã –≤–æ –≤—Å–µ—Ö –∫–∞—Ç–∞–ª–æ–≥–∞—Ö
- [ ] –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Å–æ–±–ª—é–¥–∞—é—Ç—Å—è
- [ ] –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å –∫–æ–¥–æ–º