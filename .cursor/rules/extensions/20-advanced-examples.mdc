---
alwaysApply: ${cursor.file.path.includes("examples/") && cursor.file.path.includes("advanced")}
---


# –ü—Ä–∞–≤–∏–ª–æ 20: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π rpi-image-gen.

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

## –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π

### –ü—Ä–∏–º–µ—Ä 3: –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Monitoring System)

```yaml
# METABEGIN
# X-Env-Layer-Name: monitoring-system
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å Grafana –∏ Prometheus
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,net-misc
# X-Env-VarPrefix: monitoring
#
# X-Env-Var-retention_days: 30
# X-Env-Var-retention_days-Description: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫
# X-Env-Var-retention_days-Required: false
# X-Env-Var-retention_days-Valid: int:1-365
# X-Env-Var-grafana_port: 3000
# X-Env-Var-grafana_port-Description: –ü–æ—Ä—Ç Grafana –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
# X-Env-Var-grafana_port-Required: false
# X-Env-Var-grafana_port-Valid: int:1024-65535
# METAEND
---
mmdebstrap:
  packages:
    - prometheus
    - grafana
    - node-exporter
    - prometheus-node-exporter
    - curl
    - wget
  setup-hooks:
    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
      useradd --system --shell /bin/false prometheus
      useradd --system --shell /bin/false grafana
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Prometheus
      mkdir -p /etc/prometheus /var/lib/prometheus
      chown prometheus:prometheus /etc/prometheus /var/lib/prometheus

      cat > /etc/prometheus/prometheus.yml << EOF
      global:
        scrape_interval: 15s
        evaluation_interval: 15s

      rule_files:
        # - "first_rules.yml"
        # - "second_rules.yml"

      scrape_configs:
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']

        - job_name: 'node'
          static_configs:
            - targets: ['localhost:9100']

        - job_name: 'rpi-image-gen'
          static_configs:
            - targets: ['localhost:9091']
      EOF
      chown prometheus:prometheus /etc/prometheus/prometheus.yml

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana
      mkdir -p /etc/grafana /var/lib/grafana
      chown grafana:grafana /etc/grafana /var/lib/grafana

      cat > /etc/grafana/grafana.ini << EOF
      [server]
      http_port = ${IGconf_monitoring_grafana_port}

      [database]
      type = sqlite3

      [session]
      provider = file

      [analytics]
      check_for_updates = false
      EOF
      chown grafana:grafana /etc/grafana/grafana.ini

    - |
      # –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–æ–≤
      cat > /etc/systemd/system/prometheus.service << EOF
      [Unit]
      Description=Prometheus
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      ExecStart=/usr/bin/prometheus \
          --config.file /etc/prometheus/prometheus.yml \
          --storage.tsdb.path /var/lib/prometheus/ \
          --web.console.templates=/etc/prometheus/consoles \
          --web.console.libraries=/etc/prometheus/console_libraries \
          --storage.tsdb.retention.time=${IGconf_monitoring_retention_days}d \
          --web.listen-address="0.0.0.0:9090"

      [Install]
      WantedBy=multi-user.target
      EOF

      cat > /etc/systemd/system/grafana-server.service << EOF
      [Unit]
      Description=Grafana Server
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=grafana
      Group=grafana
      Type=simple
      ExecStart=/usr/sbin/grafana-server \
          --config=/etc/grafana/grafana.ini \
          --homepath=/usr/share/grafana \
          --packaging=deb \
          cfg:default.paths.logs=/var/log/grafana \
          cfg:default.paths.data=/var/lib/grafana \
          cfg:default.paths.plugins=/var/lib/grafana/plugins

      [Install]
      WantedBy=multi-user.target
      EOF

      systemctl daemon-reload
      systemctl enable prometheus grafana-server node-exporter
```

### –ü—Ä–∏–º–µ—Ä 4: –î–æ–º–∞—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä (Home Server)

```yaml
# METABEGIN
# X-Env-Layer-Name: home-server
# X-Env-Layer-Category: suite
# X-Env-Layer-Description: –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –¥–æ–º–∞—à–Ω–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,net-misc
# X-Env-VarPrefix: homeserver
#
# X-Env-Var-media_path: /media/storage
# X-Env-Var-media_path-Description: –ü—É—Ç—å –∫ –º–µ–¥–∏–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â—É
# X-Env-Var-media_path-Required: false
# X-Env-Var-backup_schedule: daily
# X-Env-Var-backup_schedule-Description: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
# X-Env-Var-backup_schedule-Required: false
# X-Env-Var-backup_schedule-Valid: hourly,daily,weekly,monthly
# METAEND
---
mmdebstrap:
  packages:
    - samba
    - nfs-kernel-server
    - minidlna
    - transmission-daemon
    - rsnapshot
    - nginx
    - php-fpm
    - sqlite3
    - curl
    - wget
  customize-hooks:
    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Samba –¥–ª—è –æ–±—â–∏—Ö –ø–∞–ø–æ–∫
      mkdir -p ${IGconf_homeserver_media_path}
      chmod 755 ${IGconf_homeserver_media_path}

      cat > /etc/samba/smb.conf << EOF
      [global]
      workgroup = WORKGROUP
      server string = %h server
      dns proxy = no
      log file = /var/log/samba/log.%m
      max log size = 1000
      syslog = 0
      panic action = /usr/share/samba/panic-action %d

      [media]
      path = ${IGconf_homeserver_media_path}
      browseable = yes
      writable = yes
      guest ok = no
      valid users = ${IGconf_device_user}
      EOF

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nextcloud-like –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      mkdir -p /var/www/html /var/nextcloud/data
      chown -R www-data:www-data /var/www/html /var/nextcloud

      # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞–º–∏
      cat > /var/www/html/index.php << 'EOF'
      <?php
      $media_path = getenv('IGconf_homeserver_media_path') ?: '/media/storage';
      $current_dir = $_GET['dir'] ?? '';
      $path = $media_path . '/' . $current_dir;

      if (isset($_GET['download'])) {
          $file = $media_path . '/' . $_GET['download'];
          if (file_exists($file)) {
              header('Content-Type: application/octet-stream');
              header('Content-Disposition: attachment; filename="' . basename($file) . '"');
              readfile($file);
              exit;
          }
      }
      ?>
      <!DOCTYPE html>
      <html>
      <head>
          <title>–î–æ–º–∞—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä - –§–∞–π–ª—ã</title>
          <meta charset="UTF-8">
          <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .file { margin: 5px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; }
              .folder { font-weight: bold; color: #0066cc; }
              .file-size { float: right; color: #666; }
          </style>
      </head>
      <body>
          <h1>–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</h1>
          <div>–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: <?= htmlspecialchars($current_dir ?: '/') ?></div>

          <?php if ($current_dir): ?>
              <div class="file folder">
                  <a href="?dir=<?= urlencode(dirname($current_dir)) ?>">üìÅ ..</a>
              </div>
          <?php endif; ?>

          <?php
          if (is_dir($path) && $handle = opendir($path)) {
              while (false !== ($entry = readdir($handle))) {
                  if ($entry != "." && $entry != "..") {
                      $entry_path = $path . '/' . $entry;
                      $is_dir = is_dir($entry_path);
                      $size = $is_dir ? '' : ' (' . formatFileSize(filesize($entry_path)) . ')';

                      echo '<div class="file ' . ($is_dir ? 'folder' : 'file') . '">';
                      if ($is_dir) {
                          echo '<a href="?dir=' . urlencode($current_dir . '/' . $entry) . '">üìÅ ' . htmlspecialchars($entry) . '</a>';
                      } else {
                          echo '<a href="?download=' . urlencode($current_dir . '/' . $entry) . '">üìÑ ' . htmlspecialchars($entry) . '</a>';
                          echo '<span class="file-size">' . $size . '</span>';
                      }
                      echo '</div>';
                  }
              }
              closedir($handle);
          }

          function formatFileSize($bytes) {
              $units = ['B', 'KB', 'MB', 'GB', 'TB'];
              $i = 0;
              while ($bytes >= 1024 && $i < 4) {
                  $bytes /= 1024;
                  $i++;
              }
              return round($bytes, 2) . ' ' . $units[$i];
          }
          ?>
      </body>
      </html>
      EOF

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      mkdir -p /var/backups /etc/cron.${IGconf_homeserver_backup_schedule}

      cat > /usr/local/bin/backup-script.sh << 'EOF'
      #!/bin/bash
      BACKUP_DIR="/var/backups"
      MEDIA_PATH="${IGconf_homeserver_media_path}"
      DATE=$(date +%Y%m%d_%H%M%S)

      # –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞
      if [ -d "$MEDIA_PATH" ]; then
          echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤..."
          rsnapshot -c /etc/rsnapshot.conf ${IGconf_homeserver_backup_schedule}
      fi

      # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
      find "$BACKUP_DIR" -type f -mtime +30 -delete

      echo "–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: $(date)"
      EOF
      chmod +x /usr/local/bin/backup-script.sh

      # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ cron
      echo "0 2 * * * root /usr/local/bin/backup-script.sh" >> /etc/crontab

    - |
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
      systemctl enable smbd nmbd minidlna transmission-daemon nginx php8.2-fpm
      systemctl start smbd nmbd minidlna transmission-daemon nginx php8.2-fpm

  cleanup-hooks:
    - rm -f /etc/samba/smb.conf.bak /etc/grafana/grafana.ini.bak
```

---

## –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
- [ ] –ü—Ä–∞–≤–∏–ª–æ –∏–∑—É—á–µ–Ω–æ –∏ –ø–æ–Ω—è—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- [ ] –°–æ–±–ª—é–¥–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –≤ CI/CD
- [ ] –ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –º–µ—Ä–¥–∂–∞
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞
- [ ] –†–µ–≥—É–ª—è—Ä–Ω—ã–π –∞—É–¥–∏—Ç —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞

### –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
- [ ] 100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ –Ω–æ–≤–æ–º –∫–æ–¥–µ
- [ ] –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–µ—Ç–∫–∞—Ö
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏—è
- [ ] –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –∫–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- [ ] –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ –ø—Ä–∞–≤–∏–ª–∞

### –ò—Å—Ç–æ—á–Ω–∏–∫
–°–æ–∑–¥–∞–Ω–æ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: `21_—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ_–ø—Ä–∏–º–µ—Ä—ã_—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π.mdc`
