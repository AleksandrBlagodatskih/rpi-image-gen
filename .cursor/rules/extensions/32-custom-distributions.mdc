---
alwaysApply: ${cursor.file.path.includes("distro") || cursor.file.content.includes("distribution")}
---


# Правило 32: Кастомные дистрибутивы

## Назначение правила
Определяет стандарты и требования для кастомные дистрибутивы в разработке расширений rpi-image-gen.

## Обязательные требования 🔴 ОБЯЗАТЕЛЬНЫЕ

## Кастомные дистрибутивы

### Создание специализированных ОС

#### Шаблон кастомного дистрибутива:

```yaml
# METABEGIN
# X-Env-Layer-Name: custom-distro
# X-Env-Layer-Category: suite
# X-Env-Layer-Description: Кастомный дистрибутив для специфических нужд
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential
# X-Env-VarPrefix: distro
#
# X-Env-Var-base_suite: bookworm
# X-Env-Var-base_suite-Description: Базовый Debian suite
# X-Env-Var-base_suite-Required: false
# X-Env-Var-base_suite-Valid: bullseye,buster,bookworm,trixie
# X-Env-Var-custom_repos: ""
# X-Env-Var-custom_repos-Description: Дополнительные репозитории
# X-Env-Var-custom_repos-Required: false
# METAEND
---
mmdebstrap:
  suite: ${IGconf_distro_base_suite}
  target: rootfs.tar.xz
  variant: minbase
  packages:
    - systemd
    - udev
    - dbus
    - ${IGconf_distro_custom_packages:-}
  sources:
    - uri: http://deb.debian.org/debian
      suite: ${IGconf_distro_base_suite}
      components: main contrib non-free
    - ${IGconf_distro_custom_repos:+uri: ${IGconf_distro_custom_repos}}
  setup-hooks:
    - |
      # Кастомизация дистрибутива
      echo "Настройка кастомного дистрибутива"

      # Создание кастомных пользователей
      if [ -n "${IGconf_distro_custom_users:-}" ]; then
        for user_spec in ${IGconf_distro_custom_users}; do
          username=$(echo "$user_spec" | cut -d: -f1)
          password=$(echo "$user_spec" | cut -d: -f2)
          echo "$username:$password" | chpasswd
        done
      fi

      # Настройка кастомных сервисов
      systemctl enable ${IGconf_distro_custom_services:-}

      # Кастомизация приветственного сообщения
      cat > /etc/motd << EOF
      Добро пожаловать в кастомный дистрибутив!
      Версия: ${IGconf_distro_version:-1.0.0}
      Сборка: $(date)
      EOF

  customize-hooks:
    - |
      # Установка кастомных пакетов
      if [ -n "${IGconf_distro_custom_packages:-}" ]; then
        apt-get update && apt-get install -y ${IGconf_distro_custom_packages}
      fi

    - |
      # Финальная настройка
      # Очистка кэша пакетов
      apt-get clean && rm -rf /var/lib/apt/lists/*

      # Создание флагов завершения настройки
      touch /etc/distro-configured
      echo "Настройка дистрибутива завершена"
```

---

## Метрики соблюдения правила 🔴 ОБЯЗАТЕЛЬНЫЕ

### Обязательные элементы
- [ ] Правило изучено и понято командой разработки
- [ ] Соблюдение требования отслеживается в CI/CD
- [ ] Нарушения правила приводят к блокировке мерджа
- [ ] Документация правила актуальна и доступна
- [ ] Регулярный аудит соблюдения правила

### Качественные показатели
- [ ] 100% соблюдение правила в новом коде
- [ ] Отсутствие нарушений в основных ветках
- [ ] Автоматизированная проверка соблюдения
- [ ] Обратная связь от команды разработки
- [ ] Непрерывное улучшение формулировок правила

### Источник
Создано из раздела документации: `33_кастомные_дистрибутивы.mdc`
