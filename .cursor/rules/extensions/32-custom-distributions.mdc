---
alwaysApply: ${cursor.file.path.includes("distro") || cursor.file.content.includes("distribution")}
---


# ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ 32: ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ Ð´Ð¸ÑÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸Ð²Ñ‹

## ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°
ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ñ‹ Ð¸ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð»Ñ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ Ð´Ð¸ÑÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸Ð²Ñ‹ Ð² Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ð¹ rpi-image-gen.

## ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ ðŸ”´ ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð•

## ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ Ð´Ð¸ÑÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸Ð²Ñ‹

### Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… ÐžÐ¡

#### Ð¨Ð°Ð±Ð»Ð¾Ð½ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ð¾Ð³Ð¾ Ð´Ð¸ÑÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸Ð²Ð°:

```yaml
# METABEGIN
# X-Env-Layer-Name: custom-distro
# X-Env-Layer-Category: suite
# X-Env-Layer-Description: ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¹ Ð´Ð¸ÑÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸Ð² Ð´Ð»Ñ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð½ÑƒÐ¶Ð´
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential
# X-Env-VarPrefix: distro
#
# X-Env-Var-base_suite: bookworm
# X-Env-Var-base_suite-Description: Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Debian suite
# X-Env-Var-base_suite-Required: false
# X-Env-Var-base_suite-Valid: bullseye,buster,bookworm,trixie
# X-Env-Var-custom_repos: ""
# X-Env-Var-custom_repos-Description: Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸
# X-Env-Var-custom_repos-Required: false
# METAEND
---
mmdebstrap:
  suite: ${IGconf_distro_base_suite}
  target: rootfs.tar.xz
  variant: minbase
  packages:
    - systemd
    - udev
    - dbus
    - ${IGconf_distro_custom_packages:-}
  sources:
    - uri: http://deb.debian.org/debian
      suite: ${IGconf_distro_base_suite}
      components: main contrib non-free
    - ${IGconf_distro_custom_repos:+uri: ${IGconf_distro_custom_repos}}
  setup-hooks:
    - |
      # ÐšÐ°ÑÑ‚Ð¾Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð´Ð¸ÑÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸Ð²Ð°
      echo "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ð¾Ð³Ð¾ Ð´Ð¸ÑÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸Ð²Ð°"

      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
      if [ -n "${IGconf_distro_custom_users:-}" ]; then
        for user_spec in ${IGconf_distro_custom_users}; do
          username=$(echo "$user_spec" | cut -d: -f1)
          password=$(echo "$user_spec" | cut -d: -f2)
          echo "$username:$password" | chpasswd
        done
      fi

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
      systemctl enable ${IGconf_distro_custom_services:-}

      # ÐšÐ°ÑÑ‚Ð¾Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
      cat > /etc/motd << EOF
      Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¹ Ð´Ð¸ÑÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸Ð²!
      Ð’ÐµÑ€ÑÐ¸Ñ: ${IGconf_distro_version:-1.0.0}
      Ð¡Ð±Ð¾Ñ€ÐºÐ°: $(date)
      EOF

  customize-hooks:
    - |
      # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
      if [ -n "${IGconf_distro_custom_packages:-}" ]; then
        apt-get update && apt-get install -y ${IGconf_distro_custom_packages}
      fi

    - |
      # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°
      # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
      apt-get clean && rm -rf /var/lib/apt/lists/*

      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð»Ð°Ð³Ð¾Ð² Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
      touch /etc/distro-configured
      echo "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð´Ð¸ÑÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸Ð²Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
```

---

## ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° ðŸ”´ ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð•

### ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹
- [ ] ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ Ð¸Ð·ÑƒÑ‡ÐµÐ½Ð¾ Ð¸ Ð¿Ð¾Ð½ÑÑ‚Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
- [ ] Ð¡Ð¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð² CI/CD
- [ ] ÐÐ°Ñ€ÑƒÑˆÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð¿Ñ€Ð¸Ð²Ð¾Ð´ÑÑ‚ Ðº Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ Ð¼ÐµÑ€Ð´Ð¶Ð°
- [ ] Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð° Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
- [ ] Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ð¹ Ð°ÑƒÐ´Ð¸Ñ‚ ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°

### ÐšÐ°Ñ‡ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸
- [ ] 100% ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð² Ð½Ð¾Ð²Ð¾Ð¼ ÐºÐ¾Ð´Ðµ
- [ ] ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ð¹ Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ð²ÐµÑ‚ÐºÐ°Ñ…
- [ ] ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ
- [ ] ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ²ÑÐ·ÑŒ Ð¾Ñ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
- [ ] ÐÐµÐ¿Ñ€ÐµÑ€Ñ‹Ð²Ð½Ð¾Ðµ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ðµ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°

### Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº
Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Ð¸Ð· Ñ€Ð°Ð·Ð´ÐµÐ»Ð° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸: `33_ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ_Ð´Ð¸ÑÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸Ð²Ñ‹.mdc`
