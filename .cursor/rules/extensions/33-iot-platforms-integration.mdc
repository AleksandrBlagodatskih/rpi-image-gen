---
alwaysApply: ${cursor.file.path.includes("iot") || cursor.file.content.includes("mqtt")}
---


# ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ 33: Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ IoT Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ð¼Ð¸

## ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°
ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ñ‹ Ð¸ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð»Ñ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ iot Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ð¼Ð¸ Ð² Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ð¹ rpi-image-gen.

## ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ ðŸ”´ ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð•

## Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ IoT Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ð¼Ð¸

### ÐŸÐ¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ IoT Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹

#### Home Assistant Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ:

```yaml
# METABEGIN
# X-Env-Layer-Name: home-assistant
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ Home Assistant
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,net-misc
# X-Env-VarPrefix: hass
#
# X-Env-Var-api_url: http://homeassistant.local:8123
# X-Env-Var-api_url-Description: URL API Home Assistant
# X-Env-Var-api_url-Required: true
# X-Env-Var-sensor_types: temperature,humidity,motion
# X-Env-Var-sensor_types-Description: Ð¢Ð¸Ð¿Ñ‹ Ð´Ð°Ñ‚Ñ‡Ð¸ÐºÐ¾Ð² Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
# X-Env-Var-sensor_types-Required: false
# METAEND
---
mmdebstrap:
  packages:
    - python3
    - python3-pip
    - python3-rpi.gpio
    - curl
  setup-hooks:
    - pip3 install requests paho-mqtt adafruit-circuitpython-dht
  customize-hooks:
    - |
      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ Home Assistant
      cat > /usr/local/bin/hass-sensor-integration.py << 'EOF'
      #!/usr/bin/env python3
      import time
      import json
      import requests
      import adafruit_dht
      import board
      import paho.mqtt.client as mqtt

      # ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
      HASS_URL = "${IGconf_hass_api_url}"
      SENSOR_PIN = board.D4
      SENSOR_TYPES = "${IGconf_hass_sensor_types}".split(',')

      def publish_discovery():
          """ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ MQTT discovery ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹"""
          client = mqtt.Client()
          client.connect("localhost", 1883, 60)

          for sensor_type in SENSOR_TYPES:
              discovery_topic = f"homeassistant/sensor/rpi_{sensor_type}/config"
              discovery_payload = {
                  "name": f"Raspberry Pi {sensor_type.title()}",
                  "state_topic": f"homeassistant/sensor/rpi_{sensor_type}/state",
                  "unit_of_measurement": get_unit(sensor_type),
                  "device_class": sensor_type,
                  "unique_id": f"rpi_sensor_{sensor_type}"
              }

              client.publish(discovery_topic, json.dumps(discovery_payload))

          client.disconnect()

      def get_unit(sensor_type):
          """ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÐµÐ´Ð¸Ð½Ð¸Ñ† Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ"""
          units = {
              "temperature": "Â°C",
              "humidity": "%",
              "motion": None,
              "pressure": "hPa"
          }
          return units.get(sensor_type)

      def send_to_homeassistant(data):
          """ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Home Assistant"""
          try:
              response = requests.post(
                  f"{HASS_URL}/api/states/sensor.rpi_temperature",
                  headers={
                      "Authorization": f"Bearer {os.getenv('HASS_TOKEN', '')}",
                      "Content-Type": "application/json"
                  },
                  json={"state": data["temperature"]}
              )
              print(f"Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹: {response.status_code}")
          except Exception as e:
              print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…: {e}")

      # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ
      dht_device = adafruit_dht.DHT22(SENSOR_PIN)
      publish_discovery()

      while True:
          try:
              temperature = dht_device.temperature
              humidity = dht_device.humidity

              if temperature is not None and humidity is not None:
                  data = {
                      "temperature": temperature,
                      "humidity": humidity,
                      "timestamp": time.time()
                  }
                  send_to_homeassistant(data)

          except RuntimeError as e:
              print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð´Ð°Ñ‚Ñ‡Ð¸ÐºÐ°: {e}")

          time.sleep(60)
      EOF
      chmod +x /usr/local/bin/hass-sensor-integration.py

    - |
      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°
      cat > /etc/systemd/system/hass-integration.service << EOF
      [Unit]
      Description=Home Assistant Sensor Integration
      After=network.target mosquitto.service

      [Service]
      ExecStart=/usr/local/bin/hass-sensor-integration.py
      Restart=always
      User=${IGconf_device_user}

      [Install]
      WantedBy=multi-user.target
      EOF

      systemctl enable hass-integration.service
```

---

## ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° ðŸ”´ ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð•

### ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹
- [ ] ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ Ð¸Ð·ÑƒÑ‡ÐµÐ½Ð¾ Ð¸ Ð¿Ð¾Ð½ÑÑ‚Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
- [ ] Ð¡Ð¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð² CI/CD
- [ ] ÐÐ°Ñ€ÑƒÑˆÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð¿Ñ€Ð¸Ð²Ð¾Ð´ÑÑ‚ Ðº Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐµ Ð¼ÐµÑ€Ð´Ð¶Ð°
- [ ] Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð° Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
- [ ] Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ð¹ Ð°ÑƒÐ´Ð¸Ñ‚ ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°

### ÐšÐ°Ñ‡ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸
- [ ] 100% ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð² Ð½Ð¾Ð²Ð¾Ð¼ ÐºÐ¾Ð´Ðµ
- [ ] ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð½Ð°Ñ€ÑƒÑˆÐµÐ½Ð¸Ð¹ Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ð²ÐµÑ‚ÐºÐ°Ñ…
- [ ] ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ
- [ ] ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ²ÑÐ·ÑŒ Ð¾Ñ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
- [ ] ÐÐµÐ¿Ñ€ÐµÑ€Ñ‹Ð²Ð½Ð¾Ðµ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ðµ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°

### Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº
Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Ð¸Ð· Ñ€Ð°Ð·Ð´ÐµÐ»Ð° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸: `34_Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ_Ñ_iot_Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ð¼Ð¸.mdc`
