---
alwaysApply: ${cursor.file.path.includes("image/") || cursor.file.content.includes("genimage")}
---


# –ü—Ä–∞–≤–∏–ª–æ 51: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å genimage

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è genimage –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤ –¥–∏—Å–∫–æ–≤ –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è—Ö rpi-image-gen, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ä–∞–∑–¥–µ–ª–æ–≤, —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –ø—Ä–æ–µ–∫—Ç–∞.

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å genimage –≤ rpi-image-gen

### –û–±–∑–æ—Ä genimage –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ rpi-image-gen

**genimage** - —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –∏ –æ–±—Ä–∞–∑–æ–≤ –¥–∏—Å–∫–æ–≤ –∏–∑ –¥–µ—Ä–µ–≤–∞ –∫–æ—Ä–Ω–µ–≤–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã. –í rpi-image-gen genimage –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –¥–∏—Å–∫–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:

- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ (boot, root, data)
- –†–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º (ext4, vfat, btrfs, f2fs)
- –¢–∞–±–ª–∏—Ü —Ä–∞–∑–¥–µ–ª–æ–≤ (MBR, GPT)
- Sparse –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ genimage

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:

```bash
# genimage.cfg.in - —à–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ genimage
image <IMAGE_NAME>.<IMAGE_SUFFIX> {
    hdimage {
        align = 8M
        partition-table-type = "mbr"  # –∏–ª–∏ "gpt"
        fill = true
    }

    partition boot {
        partition-type = 0xC
        bootable = true
        image = "boot.vfat"
        size = 200M
    }

    partition root {
        partition-type = 0x83
        image = "root.ext4"
    }
}

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ —Ä–∞–∑–¥–µ–ª–æ–≤
image boot.vfat {
    vfat {
        label = "BOOT"
        extraargs = "-S 512 -i <BOOT_LABEL>"
    }
    size = <BOOT_SIZE>
    mountpoint = "/boot/firmware"
}

image root.ext4 {
    ext4 {
        label = "ROOT"
        use-mke2fs = true
        mke2fs-conf = <MKE2FS_CONFIG>
        extraargs = "-U <ROOT_UUID>"
    }
    size = <ROOT_SIZE>
    mountpoint = "/"
}
```

#### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤:

```bash
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ pre-image.sh
<IMAGE_NAME>     # –ò–º—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞
<IMAGE_SUFFIX>   # –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ (.img)
<BOOT_SIZE>      # –†–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
<ROOT_SIZE>      # –†–∞–∑–º–µ—Ä –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
<BOOT_LABEL>     # –ú–µ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
<ROOT_UUID>      # UUID –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
<MKE2FS_CONFIG>  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è mke2fs (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

### –¢–∏–ø—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤

#### 1. –§–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã (Filesystem Images):
```bash
# EXT4 –¥–ª—è –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
image root.ext4 {
    ext4 {
        label = "ROOT"
        features = "extent,huge_file,flex_bg,uninit_bg,dir_nlink,extra_isize"
        extraargs = "-U random"
    }
    size = 100%
    mountpoint = "/"
}

# VFAT –¥–ª—è –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
image boot.vfat {
    vfat {
        label = "BOOT"
        fat-size = 32
    }
    size = 200M
    mountpoint = "/boot/firmware"
}

# BTRFS –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
image root.btrfs {
    btrfs {
        label = "ROOT"
    }
    size = 100%
    mountpoint = "/"
}
```

#### 2. –î–∏—Å–∫–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã (Disk Images):
```bash
# –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–∑ —Å sparse –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
image <IMAGE_NAME>.<IMAGE_SUFFIX>.sparse {
    android-sparse {
        image = <IMAGE_NAME>.<IMAGE_SUFFIX>
    }
}

# –û–±—Ä–∞–∑ —Å —Ç–∞–±–ª–∏—Ü–µ–π —Ä–∞–∑–¥–µ–ª–æ–≤
image <IMAGE_NAME>.<IMAGE_SUFFIX> {
    hdimage {
        align = 8M
        partition-table-type = "gpt"
        fill = true
    }

    partition esp {
        partition-type-uuid = "esp"
        image = "esp.vfat"
        size = 512M
    }

    partition root {
        partition-type-uuid = "linux"
        image = "root.ext4"
    }
}
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤

#### –û–ø—Ü–∏–∏ —Ä–∞–∑–¥–µ–ª–æ–≤:
```bash
partition boot {
    partition-type = 0xC          # MBR —Ç–∏–ø —Ä–∞–∑–¥–µ–ª–∞
    partition-type-uuid = "esp"   # GPT —Ç–∏–ø —Ä–∞–∑–¥–µ–ª–∞
    bootable = true               # –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ñ–ª–∞–≥
    image = "boot.vfat"          # –û–±—Ä–∞–∑ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
    size = 200M                  # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
    align = 8M                   # –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
    offset = 8M                  # –°–º–µ—â–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    sparse = true                # Sparse –ø–æ–¥–¥–µ—Ä–∂–∫–∞
    fill = false                 # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
    autoresize = false           # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
}
```

#### –¢–∏–ø—ã —Ç–∞–±–ª–∏—Ü —Ä–∞–∑–¥–µ–ª–æ–≤:

**MBR (Master Boot Record):**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ 4 –ø–µ—Ä–≤–∏—á–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –¥–∏—Å–∫–∞ 2TB
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å legacy —Å–∏—Å—Ç–µ–º–∞–º–∏

**GPT (GUID Partition Table):**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ 128 —Ä–∞–∑–¥–µ–ª–æ–≤
- –†–∞–∑–º–µ—Ä—ã –¥–∏—Å–∫–æ–≤ > 2TB
- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è UEFI

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è genimage

#### –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
```bash
OUTPUTPATH  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤—ã–≤–æ–¥–∞ –æ–±—Ä–∞–∑–æ–≤
INPUTPATH   # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
ROOTPATH    # –ö–æ—Ä–µ–Ω—å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
TMPPATH     # –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
```

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑–∞:
```bash
IMAGE         # –ò–º—è —Ñ–∞–π–ª–∞ –æ–±—Ä–∞–∑–∞
IMAGEOUTFILE  # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –æ–±—Ä–∞–∑—É
IMAGENAME     # –ò–º—è –æ–±—Ä–∞–∑–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
IMAGESIZE     # –†–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞
IMAGEMOUNTPOINT  # –¢–æ—á–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
IMAGEMOUNTPATH   # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å rpi-image-gen

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤:
```
image/{partition_scheme}/{image_name}/
‚îú‚îÄ‚îÄ image.yaml                    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–æ—è
‚îú‚îÄ‚îÄ genimage.cfg.in.ext4         # –®–∞–±–ª–æ–Ω –¥–ª—è ext4
‚îú‚îÄ‚îÄ genimage.cfg.in.btrfs        # –®–∞–±–ª–æ–Ω –¥–ª—è btrfs
‚îú‚îÄ‚îÄ pre-image.sh                 # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (UUID, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
‚îú‚îÄ‚îÄ setup.sh                     # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–¥–µ–ª–æ–≤
‚îú‚îÄ‚îÄ mke2fs.conf                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ext4 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
‚îî‚îÄ‚îÄ device/
    ‚îú‚îÄ‚îÄ provisionmap-clear.json  # –ö–∞—Ä—Ç–∞ —Ä–∞–∑–º–µ—Ç–∫–∏
    ‚îî‚îÄ‚îÄ *.rules                  # Udev –ø—Ä–∞–≤–∏–ª–∞
```

#### –°–∫—Ä–∏–ø—Ç pre-image.sh (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π):
```bash
#!/bin/bash
set -euo pipefail

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UUID –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤
BOOT_LABEL=$(uuidgen | sed 's/-.*//' | tr 'a-f' 'A-F')
BOOT_UUID=$(echo "$BOOT_LABEL" | sed 's/^\(....\)\(....\)$/\1-\2/')
ROOT_UUID=$(uuidgen)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–∞—Ö
echo "BOOT_LABEL=$BOOT_LABEL" > "${IGconf_image_outputdir}/img_uuids"
echo "BOOT_UUID=$BOOT_UUID" >> "${IGconf_image_outputdir}/img_uuids"
echo "ROOT_UUID=$ROOT_UUID" >> "${IGconf_image_outputdir}/img_uuids"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞
sed -e "s|<IMAGE_NAME>|$IGconf_image_name|g" \
    -e "s|<BOOT_SIZE>|$IGconf_image_boot_part_size|g" \
    -e "s|<ROOT_SIZE>|$IGconf_image_root_part_size|g" \
    -e "s|<BOOT_LABEL>|$BOOT_LABEL|g" \
    -e "s|<ROOT_UUID>|$ROOT_UUID|g" \
    "genimage.cfg.in.${IGconf_image_rootfs_type}" > "${genimg_in}/genimage.cfg"
```

#### –°–∫—Ä–∏–ø—Ç setup.sh (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π):
```bash
#!/bin/bash
set -euo pipefail

LABEL="$1"
BOOTUUID="$2"
ROOTUUID="$3"

case $LABEL in
    BOOT)
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
        sed -i "s|root=\([^ ]*\)|root=UUID=${ROOTUUID}|" "$IMAGEMOUNTPATH/cmdline.txt"
        ;;
    ROOT)
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
        case $IGconf_image_rootfs_type in
            ext4)
                cat > "$IMAGEMOUNTPATH/etc/fstab" << EOF
UUID=${ROOTUUID} /               ext4 rw,relatime,errors=remount-ro,commit=30 0 1
EOF
                ;;
            btrfs)
                cat > "$IMAGEMOUNTPATH/etc/fstab" << EOF
UUID=${ROOTUUID} /               btrfs defaults 0 0
EOF
                ;;
        esac

        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
        cat >> "$IMAGEMOUNTPATH/etc/fstab" << EOF
UUID=${BOOTUUID} /boot/firmware  vfat defaults,rw,noatime,errors=remount-ro 0 2
EOF
        ;;
esac
```

### Best practices –¥–ª—è genimage

#### 1. –í—ã–±–æ—Ä —Ç–∏–ø–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:
```bash
# EXT4 - —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤
ext4 {
    features = "extent,huge_file,flex_bg,uninit_bg,dir_nlink,extra_isize"
    extraargs = "-U random -E lazy_itable_init=0,lazy_journal_init=0"
}

# BTRFS - –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å snapshots
btrfs {
    label = "ROOT"
    extraargs = "--mixed"
}

# F2FS - –¥–ª—è —Ñ–ª–µ—à-–Ω–∞–∫–æ–ø–∏—Ç–µ–ª–µ–π
f2fs {
    label = "ROOT"
    extraargs = "-O encrypt -O compress"
}
```

#### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–æ–≤:
```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ sparse –æ–±—Ä–∞–∑–æ–≤
image sparse.img {
    android-sparse {
        image = "full.img"
    }
}

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
partition root {
    image = "root.ext4"
    autoresize = true  # –ó–∞–ø–æ–ª–Ω—è–µ—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ
}
```

#### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å:
```bash
# –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
if [ ! -f "${genimg_in}/genimage.cfg" ]; then
    die "genimage config not found"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
command -v genimage >/dev/null 2>&1 || die "genimage not found"

# –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
rm -f "${genimg_in}/genimage.cfg"
```

### –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫ genimage

#### –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

**–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ**
```bash
# –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ sparse –æ–±—Ä–∞–∑–æ–≤
image sparse.img {
    android-sparse {
        image = "full.img"
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã UUID**
```bash
# –†–µ—à–µ–Ω–∏–µ: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö UUID
ROOT_UUID=$(uuidgen)
BOOT_UUID=$(uuidgen)
```

**–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤**
```bash
# –†–µ—à–µ–Ω–∏–µ: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ align
hdimage {
    align = 8M  # –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ 8MB
}
```

**–ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã**
```bash
# –†–µ—à–µ–Ω–∏–µ: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
case $IGconf_image_rootfs_type in
    ext4|btrfs|f2fs) ;;
    *) die "Unsupported filesystem: $IGconf_image_rootfs_type" ;;
esac
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å provisionmap

#### Provisioning maps –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:
```json
[
    {
        "attributes": {
            "PMAPversion": "1.0.0",
            "system_type": "flat"
        }
    },
    {
        "partitions": [
            {"image": "boot"},
            {"image": "root"}
        ]
    }
]
```

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è provisionmap –≤ pre-image.sh:
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã —Ä–∞–∑–º–µ—Ç–∫–∏
cat > "${IGconf_image_outputdir}/provisionmap.json" << EOF
{
    "clear": {
        "partitions": [
            {"image": "boot", "type": "vfat", "label": "BOOT"},
            {"image": "root", "type": "ext4", "label": "ROOT"}
        ]
    }
}
EOF

# –ó–∞–º–µ–Ω–∞ UUID –≤ provisionmap
sed -i "s|<ROOT_UUID>|$ROOT_UUID|g" "${IGconf_image_outputdir}/provisionmap.json"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π genimage

#### –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
```bash
#!/bin/bash
# validate-genimage-config.sh

CONFIG_FILE="$1"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
genimage --dry-run --config "$CONFIG_FILE" || die "Invalid genimage config"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤
grep -q "image.*boot" "$CONFIG_FILE" || die "Boot partition not defined"
grep -q "image.*root" "$CONFIG_FILE" || die "Root partition not defined"

echo "genimage config is valid"
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤:
```bash
#!/bin/bash
# test-disk-image.sh

IMAGE_FILE="$1"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–∞–∑–¥–µ–ª–æ–≤
parted -s "$IMAGE_FILE" print || die "Invalid partition table"

# –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
BOOT_MOUNT=$(mktemp -d)
ROOT_MOUNT=$(mktemp -d)

mount -o ro "${IMAGE_FILE}p1" "$BOOT_MOUNT"
mount -o ro "${IMAGE_FILE}p2" "$ROOT_MOUNT"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
[ -f "$BOOT_MOUNT/config.txt" ] || die "config.txt not found in boot partition"
[ -d "$ROOT_MOUNT/etc" ] || die "etc directory not found in root partition"

# –û—á–∏—Å—Ç–∫–∞
umount "$BOOT_MOUNT" "$ROOT_MOUNT"
rmdir "$BOOT_MOUNT" "$ROOT_MOUNT"

echo "Disk image structure is valid"
```

---

## –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
- [ ] –ü—Ä–∞–≤–∏–ª–æ –∏–∑—É—á–µ–Ω–æ –∏ –ø–æ–Ω—è—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- [ ] –°–æ–±–ª—é–¥–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –≤ CI/CD
- [ ] –ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –º–µ—Ä–¥–∂–∞
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞
- [ ] –†–µ–≥—É–ª—è—Ä–Ω—ã–π –∞—É–¥–∏—Ç —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞

### –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
- [ ] 100% —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ –Ω–æ–≤–æ–º –∫–æ–¥–µ
- [ ] –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–µ—Ç–∫–∞—Ö
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏—è
- [ ] –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –∫–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- [ ] –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ –ø—Ä–∞–≤–∏–ª–∞

### –ò—Å—Ç–æ—á–Ω–∏–∫
–°–æ–∑–¥–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: `https://raw.githubusercontent.com/pengutronix/genimage/refs/heads/master/README.rst`