# METABEGIN
# X-Env-Layer-Name: ${extension_name}
# X-Env-Layer-Category: extension
# X-Env-Layer-Description: ${description}
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential,net-misc
# X-Env-VarPrefix: app
#
# X-Env-Var-app_name: ${app_name}
# X-Env-Var-app_name-Description: –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
# X-Env-Var-app_name-Required: true
# X-Env-Var-app_name-Valid: regex:^[a-zA-Z0-9_-]+$
#
# X-Env-Var-service_port: 8080
# X-Env-Var-service_port-Description: –ü–æ—Ä—Ç –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# X-Env-Var-service_port-Required: false
# X-Env-Var-service_port-Valid: int:1024-65535
#
# X-Env-Var-install_path: /opt/${app_name}
# X-Env-Var-install_path-Description: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# X-Env-Var-install_path-Required: false
# X-Env-Var-install_path-Valid: regex:^/opt/|^/usr/local/
#
# X-Env-Var-auto_start: true
# X-Env-Var-auto_start-Description: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
# X-Env-Var-auto_start-Required: false
# X-Env-Var-auto_start-Valid: true,false
# METAEND
---
mmdebstrap:
  # ============================================================================
  # –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –ò –ü–ê–ö–ï–¢–´
  # ============================================================================

  packages:
    # Python runtime –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    - python3
    - python3-pip
    - python3-venv

    # –í–µ–±-—Å–µ—Ä–≤–µ—Ä –∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
    - nginx

    # –°–µ—Ç–µ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã
    - curl
    - wget

    # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    - git

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    ${app_packages:-}

  # ============================================================================
  # –•–£–ö–ò –£–°–¢–ê–ù–û–í–ö–ò
  # ============================================================================

  setup-hooks:
    - |
      #!/bin/bash
      # Hook: Application Setup - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      set -euo pipefail

      # Function for error handling
      die() {
        echo "ERROR: $*" >&2
        exit 1
      }

      # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
      app_name="${IGconf_app_app_name:?app_name not configured}"
      install_path="${IGconf_app_install_path:-/opt/$app_name}"

      echo "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: $app_name"

      # –°–æ–∑–¥–∞–Ω–∏–µ dedicated –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      if ! id -u "$app_name" >/dev/null 2>&1; then
        useradd --system --shell /bin/false --home "$install_path" --create-home "$app_name" || \
          die "Failed to create application user: $app_name"
      fi

      # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
      mkdir -p "$install_path" || die "Failed to create install directory: $install_path"
      mkdir -p "/var/log/$app_name" || die "Failed to create log directory"
      mkdir -p "/var/lib/$app_name" || die "Failed to create data directory"

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      chown -R "$app_name:$app_name" "$install_path" || die "Failed to set ownership for install path"
      chown -R "$app_name:$app_name" "/var/log/$app_name" || die "Failed to set ownership for log directory"
      chown -R "$app_name:$app_name" "/var/lib/$app_name" || die "Failed to set ownership for data directory"

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–≤ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
      chmod 755 "$install_path" || die "Failed to set permissions for install path"
      chmod 750 "/var/log/$app_name" || die "Failed to set permissions for log directory"
      chmod 750 "/var/lib/$app_name" || die "Failed to set permissions for data directory"

      echo "‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è $app_name –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

  customize-hooks:
    - |
      #!/bin/bash
      # Hook: Application Installation and Configuration
      set -euo pipefail

      # Function for error handling
      die() {
        echo "ERROR: $*" >&2
        exit 1
      }

      # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
      app_name="${IGconf_app_app_name:?app_name not configured}"
      service_port="${IGconf_app_service_port:-8080}"
      install_path="${IGconf_app_install_path:-/opt/$app_name}"
      auto_start="${IGconf_app_auto_start:-true}"

      # –í–∞–ª–∏–¥–∞—Ü–∏—è service_port
      if ! [[ "$service_port" =~ ^[0-9]+$ ]] || [[ "$service_port" -lt 1024 ]] || [[ "$service_port" -gt 65535 ]]; then
        die "service_port must be integer between 1024 and 65535"
      fi

      echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: $app_name"

      # ============================================================================
      # PYTHON ENVIRONMENT SETUP
      # ============================================================================

      echo "üêç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

      # –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      python3 -m venv "$install_path/venv" || die "Failed to create Python virtual environment"
      # shellcheck source=/dev/null
      source "$install_path/venv/bin/activate" || die "Failed to activate virtual environment"

      # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      pip install --upgrade pip setuptools wheel || die "Failed to upgrade pip"
      pip install flask gunicorn psycopg2-binary || die "Failed to install Python dependencies"

      # ============================================================================
      # APPLICATION DEPLOYMENT
      # ============================================================================

      echo "üì¶ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."

      # –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      cat > "$install_path/app.py" << EOF
#!/usr/bin/env python3
"""
$app_name - Web Application
Generated by rpi-image-gen application extension template
"""

from flask import Flask, jsonify, request
import socket
import time
import logging
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

app = Flask(__name__)

@app.route('/')
def hello():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    return jsonify({
        'message': f'Hello from $app_name!',
        'hostname': socket.gethostname(),
        'timestamp': time.time(),
        'app': '$app_name',
        'version': '1.0.0'
    })

@app.route('/health')
def health():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    return jsonify({
        'status': 'healthy',
        'timestamp': time.time(),
        'uptime': time.time() - app.start_time if hasattr(app, 'start_time') else 0
    })

@app.route('/info')
def info():
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ"""
    return jsonify({
        'app': '$app_name',
        'python_version': os.sys.version,
        'platform': os.uname().sysname,
        'hostname': socket.gethostname(),
        'port': $service_port
    })

@app.errorhandler(404)
def not_found(error):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ 404 –æ—à–∏–±–∫–∏"""
    return jsonify({'error': 'Not found', 'status_code': 404}), 404

@app.errorhandler(500)
def internal_error(error):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ 500 –æ—à–∏–±–∫–∏"""
    logger.error(f"Internal server error: {error}")
    return jsonify({'error': 'Internal server error', 'status_code': 500}), 500

if __name__ == '__main__':
    app.start_time = time.time()
    logger.info(f"Starting $app_name on port $service_port")
    app.run(host='0.0.0.0', port=$service_port, debug=False)
EOF

      # –°–æ–∑–¥–∞–Ω–∏–µ production-ready —Å–∫—Ä–∏–ø—Ç–∞ –∑–∞–ø—É—Å–∫–∞
      cat > "$install_path/run.sh" << EOF
#!/bin/bash
# Production startup script for $app_name
# Generated by rpi-image-gen application extension template

set -euo pipefail

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
cd "$install_path"

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source venv/bin/activate

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
export FLASK_ENV=production
export FLASK_APP=app.py

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ gunicorn —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
exec gunicorn \\
  --bind "0.0.0.0:$service_port" \\
  --workers 2 \\
  --worker-class gthread \\
  --threads 4 \\
  --user "$app_name" \\
  --group "$app_name" \\
  --log-level info \\
  --access-logfile "/var/log/$app_name/access.log" \\
  --error-logfile "/var/log/$app_name/error.log" \\
  --capture-output \\
  --pid "/var/run/$app_name.pid" \\
  app:app
EOF
      chmod 755 "$install_path/run.sh" || die "Failed to set permissions on run script"

      # ============================================================================
      # SYSTEMD SERVICE CONFIGURATION
      # ============================================================================

      echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞..."

      # –°–æ–∑–¥–∞–Ω–∏–µ production-ready systemd —Å–µ—Ä–≤–∏—Å–∞
      cat > "/etc/systemd/system/$app_name.service" << EOF
[Unit]
Description=$app_name Web Application Service
After=network.target
Wants=network.target
Documentation=https://github.com/rpi-image-gen/extensions

[Service]
Type=exec
User=$app_name
Group=$app_name
WorkingDirectory=$install_path
ExecStart=$install_path/run.sh
ExecReload=/bin/kill -HUP \$MAINPID
Restart=always
RestartSec=5
TimeoutStartSec=30
TimeoutStopSec=30

# Security hardening
NoNewPrivileges=yes
PrivateTmp=yes
ProtectHome=yes
ProtectSystem=strict
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
ReadWritePaths=$install_path /var/log/$app_name /var/lib/$app_name
ReadOnlyPaths=/usr /etc
InaccessiblePaths=/boot /sys /proc/sys

# Resource limits
MemoryLimit=256M
CPUQuota=50%

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=$app_name

[Install]
WantedBy=multi-user.target
EOF

      # ============================================================================
      # NGINX REVERSE PROXY CONFIGURATION
      # ============================================================================

      echo "üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx reverse proxy..."

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
      if command -v nginx >/dev/null 2>&1 && [[ -d "/etc/nginx" ]]; then
        # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∞–π—Ç–∞
        cat > "/etc/nginx/sites-available/$app_name" << EOF
# $app_name nginx configuration
# Generated by rpi-image-gen application extension template

upstream $app_name {
    server 127.0.0.1:$service_port;
    keepalive 32;
}

server {
    listen 80;
    server_name localhost;
    root $install_path/static;
    index index.html;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # Main application location
    location / {
        proxy_pass http://$app_name;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;

        # Timeout settings
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Health check endpoint
    location /health {
        proxy_pass http://$app_name/health;
        access_log off;

        # Allow from localhost only for security
        allow 127.0.0.1;
        allow ::1;
        deny all;
    }

    # Static files caching
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Deny access to sensitive files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
EOF

        # –í–∫–ª—é—á–µ–Ω–∏–µ —Å–∞–π—Ç–∞
        ln -sf "/etc/nginx/sites-available/$app_name" "/etc/nginx/sites-enabled/" || true
        rm -f "/etc/nginx/sites-enabled/default" 2>/dev/null || true
      fi

      # ============================================================================
      # SERVICE ACTIVATION
      # ============================================================================

      echo "üöÄ –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤..."

      # –í–∫–ª—é—á–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
      if [[ "$auto_start" == "true" ]]; then
        systemctl daemon-reload || die "Failed to reload systemd daemon"

        systemctl enable "$app_name" || die "Failed to enable $app_name service"
        echo "‚úÖ –°–µ—Ä–≤–∏—Å $app_name –≤–∫–ª—é—á–µ–Ω –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞"

        # –í–∫–ª—é—á–µ–Ω–∏–µ nginx –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        if [[ -L "/etc/nginx/sites-enabled/$app_name" ]]; then
          systemctl enable nginx || die "Failed to enable nginx"
          systemctl reload nginx || systemctl start nginx || true
          echo "‚úÖ Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
        fi
      fi

      # –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–ª–∞–≥–∞ —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
      touch "/var/lib/$app_name/.installed" || true

      echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ $app_name —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"
      echo "   üåê –î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞: http://localhost"
      echo "   üîç Health check: http://localhost/health"
      echo "   üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: http://localhost/info"

  # ============================================================================
  # –û–ß–ò–°–¢–ö–ê –ü–û–°–õ–ï –£–°–¢–ê–ù–û–í–ö–ò
  # ============================================================================

  cleanup-hooks:
    - |
      #!/bin/bash
      # Hook: Application Cleanup - –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
      set -euo pipefail

      # Function for error handling
      die() {
        echo "ERROR: $*" >&2
        exit 1
      }

      # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)
      app_name="${IGconf_app_app_name:-unknown-app}"
      install_path="${IGconf_app_install_path:-/opt/$app_name}"

      echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: $app_name"

      # ============================================================================
      # PYTHON CACHE CLEANUP
      # ============================================================================

      echo "üêç –û—á–∏—Å—Ç–∫–∞ Python –∫—ç—à–∞..."

      # –û—á–∏—Å—Ç–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ pip –∫—ç—à–∞
      rm -rf /root/.cache/pip 2>/dev/null || true

      # –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ pip –∫—ç—à–∞
      if [[ -d "/home/$app_name" ]]; then
        rm -rf "/home/$app_name/.cache/pip" 2>/dev/null || true
      fi

      # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      if [[ -d "$install_path/venv" ]]; then
        rm -rf "$install_path/venv/pip-cache" 2>/dev/null || true
        rm -rf "$install_path/venv/share/python-wheels" 2>/dev/null || true
      fi

      # ============================================================================
      # PYTHON BYTECODE CLEANUP
      # ============================================================================

      echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ Python bytecode..."

      # –£–¥–∞–ª–µ–Ω–∏–µ .pyc —Ñ–∞–π–ª–æ–≤
      find "$install_path" -name "*.pyc" -delete 2>/dev/null || true
      find "$install_path" -name "*.pyo" -delete 2>/dev/null || true

      # –£–¥–∞–ª–µ–Ω–∏–µ __pycache__ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
      find "$install_path" -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

      # ============================================================================
      # BUILD ARTIFACTS CLEANUP
      # ============================================================================

      echo "üîß –û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏..."

      # –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏
      rm -f "$install_path/setup.py" 2>/dev/null || true
      rm -f "$install_path/requirements.txt" 2>/dev/null || true
      rm -f "$install_path/MANIFEST.in" 2>/dev/null || true

      # –û—á–∏—Å—Ç–∫–∞ npm/node artifacts –µ—Å–ª–∏ –µ—Å—Ç—å
      if [[ -d "$install_path/node_modules" ]]; then
        rm -rf "$install_path/node_modules/.cache" 2>/dev/null || true
      fi

      # ============================================================================
      # PACKAGE MANAGER CACHE CLEANUP
      # ============================================================================

      echo "üì¶ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–∞–∫–µ—Ç–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤..."

      # –û—á–∏—Å—Ç–∫–∞ apt –∫—ç—à–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞)
      if command -v apt-get >/dev/null 2>&1; then
        apt-get clean 2>/dev/null || true
        rm -rf /var/lib/apt/lists/* 2>/dev/null || true
      fi

      # ============================================================================
      # LOG ROTATION SETUP
      # ============================================================================

      echo "üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤..."

      # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ logrotate –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      if [[ -d "/var/log/$app_name" ]]; then
        cat > "/etc/logrotate.d/$app_name" << EOF 2>/dev/null || true
/var/log/$app_name/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 $app_name $app_name
    postrotate
        systemctl reload $app_name.service || true
    endscript
}
EOF
      fi

      # ============================================================================
      # DISK SPACE OPTIMIZATION
      # ============================================================================

      echo "üíæ –§–∏–Ω–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞..."

      # –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      if [[ -d "$install_path" ]]; then
        find "$install_path" -type f -size +10M -exec ls -lh {} \; 2>/dev/null | head -10 > "$install_path/.large-files.txt" 2>/dev/null || true
      fi

      # ============================================================================
      # FINAL VERIFICATION
      # ============================================================================

      echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è..."

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ
      if [[ -f "$install_path/app.py" ]] && [[ -f "$install_path/run.sh" ]] && [[ -x "$install_path/run.sh" ]]; then
        echo "‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç"
      else
        echo "‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å"
      fi

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
      if [[ -d "$install_path" ]]; then
        app_owner=$(stat -c '%U' "$install_path" 2>/dev/null || echo "unknown")
        if [[ "$app_owner" == "$app_name" ]]; then
          echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
        else
          echo "‚ö†Ô∏è  –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ (owner: $app_owner)"
        fi
      fi

      echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ $app_name –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
