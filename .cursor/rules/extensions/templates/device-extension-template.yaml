# METABEGIN
# X-Env-Layer-Name: ${extension_name}
# X-Env-Layer-Category: device
# X-Env-Layer-Description: ${description}
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential
# X-Env-VarPrefix: device
#
# X-Env-Var-device_type: ${device_type}
# X-Env-Var-device_type-Description: Ð¢Ð¸Ð¿ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Raspberry Pi Ð´Ð»Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸
# X-Env-Var-device_type-Required: true
# X-Env-Var-device_type-Valid: pi4,pi5,cm4,zero2w
#
# X-Env-Var-firmware_version: latest
# X-Env-Var-firmware_version-Description: Ð’ÐµÑ€ÑÐ¸Ñ firmware Raspberry Pi Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
# X-Env-Var-firmware_version-Required: false
# X-Env-Var-firmware_version-Valid: latest,stable,beta
#
# X-Env-Var-hostname: rpi-${device_type}-${HOST_SUFFIX}
# X-Env-Var-hostname-Description: Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð¼Ñ Ñ…Ð¾ÑÑ‚Ð° Ð´Ð»Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°
# X-Env-Var-hostname-Required: false
# X-Env-Var-hostname-Valid: regex:^[a-zA-Z0-9.-]+$
#
# X-Env-Var-enable_overclock: false
# X-Env-Var-enable_overclock-Description: Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ð³Ð¾Ð½ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€Ð° Ð¸ Ð¿Ð°Ð¼ÑÑ‚Ð¸
# X-Env-Var-enable_overclock-Required: false
# X-Env-Var-enable_overclock-Valid: true,false
#
# X-Env-Var-power_management: balanced
# X-Env-Var-power_management-Description: Ð ÐµÐ¶Ð¸Ð¼ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸ÐµÐ¼
# X-Env-Var-power_management-Required: false
# X-Env-Var-power_management-Valid: performance,balanced,powersave
# METAEND
---
mmdebstrap:
  # ============================================================================
  # Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð˜ Ð˜ ÐŸÐÐšÐ•Ð¢Ð«
  # ============================================================================

  packages:
    # Raspberry Pi bootloader Ð¸ firmware
    - raspberrypi-bootloader
    - raspberrypi-kernel
    - linux-firmware-raspi
    - rpi-eeprom

    # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ð¼Ð¸
    - raspi-config
    - rpi-update
    - usbutils
    - pciutils

  # ============================================================================
  # Ð¥Ð£ÐšÐ˜ ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’ÐšÐ˜
  # ============================================================================

  setup-hooks:
    - |
      #!/bin/bash
      # Hook: Device Setup - ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°
      set -euo pipefail

      # Function for error handling
      die() {
        echo "ERROR: $*" >&2
        exit 1
      }

      # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
      device_type="${IGconf_device_device_type:?device_type not configured}"

      echo "ðŸ”§ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Ñ‚Ð¸Ð¿Ð°: $device_type"

      # ============================================================================
      # DIRECTORY STRUCTURE SETUP
      # ============================================================================

      echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."

      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð»Ñ Raspberry Pi
      mkdir -p /boot/firmware || die "Failed to create /boot/firmware directory"
      mkdir -p /var/lib/raspberrypi || die "Failed to create Raspberry Pi lib directory"
      mkdir -p /opt/vc || die "Failed to create VideoCore directory"

      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð² Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¹ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°
      mkdir -p /var/log/rpi || die "Failed to create device log directory"
      mkdir -p /etc/rpi || die "Failed to create device config directory"

      # ============================================================================
      # DEVICE-SPECIFIC PREPARATION
      # ============================================================================

      echo "ðŸ” ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ñ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ð´Ð»Ñ $device_type..."

      # Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ‚Ð¸Ð¿Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°
      case "$device_type" in
        "pi4")
          # Raspberry Pi 4 specific preparation
          echo "ðŸŽ¯ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð´Ð»Ñ Raspberry Pi 4"
          ;;
        "pi5")
          # Raspberry Pi 5 specific preparation
          echo "ðŸŽ¯ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð´Ð»Ñ Raspberry Pi 5"
          ;;
        "cm4")
          # Compute Module 4 specific preparation
          echo "ðŸŽ¯ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð´Ð»Ñ Compute Module 4"
          ;;
        "zero2w")
          # Zero 2 W specific preparation
          echo "ðŸŽ¯ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð´Ð»Ñ Zero 2 W"
          ;;
        *)
          echo "âš ï¸  ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°: $device_type, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¾Ð±Ñ‰Ð°Ñ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°"
          ;;
      esac

      # ============================================================================
      # PERMISSIONS SETUP
      # ============================================================================

      echo "ðŸ”’ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ boot Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
      chmod 755 /boot/firmware || die "Failed to set permissions for /boot/firmware"

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ Raspberry Pi ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
      chmod 755 /var/lib/raspberrypi || die "Failed to set permissions for Raspberry Pi lib"
      chmod 755 /var/log/rpi || die "Failed to set permissions for device logs"
      chmod 755 /etc/rpi || die "Failed to set permissions for device config"

      echo "âœ… ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° $device_type Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
  customize-hooks:
    - |
      #!/bin/bash
      # Hook: Device Configuration - ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Raspberry Pi
      set -euo pipefail

      # Function for error handling
      die() {
        echo "ERROR: $*" >&2
        exit 1
      }

      # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
      device_type="${IGconf_device_device_type:?device_type not configured}"
      firmware_version="${IGconf_device_firmware_version:-latest}"
      hostname="${IGconf_device_hostname:-rpi-$device_type}"
      enable_overclock="${IGconf_device_enable_overclock:-false}"
      power_management="${IGconf_device_power_management:-balanced}"

      # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹
      case "$device_type" in
        pi4|pi5|cm4|zero2w) ;;
        *) die "Unsupported device type: $device_type" ;;
      esac

      case "$firmware_version" in
        latest|stable|beta) ;;
        *) die "Unsupported firmware version: $firmware_version" ;;
      esac

      case "$power_management" in
        performance|balanced|powersave) ;;
        *) die "Unsupported power management mode: $power_management" ;;
      esac

      echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° $device_type (firmware: $firmware_version)"

      # ============================================================================
      # HOSTNAME CONFIGURATION
      # ============================================================================

      echo "ðŸ·ï¸  ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° hostname: $hostname"

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° hostname
      echo "$hostname" > /etc/hostname || die "Failed to set hostname"
      sed -i "s/127.0.1.1.*/127.0.1.1\t$hostname/" /etc/hosts || die "Failed to update hosts file"

      # ============================================================================
      # DEVICE-SPECIFIC CONFIGURATION
      # ============================================================================

      echo "ðŸŽ¯ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ñ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ð´Ð»Ñ $device_type..."

      # Ð¡Ð¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²
      case "$device_type" in
        "pi4")
          configure_pi4_specifics
          ;;
        "pi5")
          configure_pi5_specifics
          ;;
        "cm4")
          configure_cm4_specifics
          ;;
        "zero2w")
          configure_zero2w_specifics
          ;;
        *)
          echo "âš ï¸  ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°: $device_type" >&2
          ;;
      esac

      # ============================================================================
      # FIRMWARE MANAGEMENT
      # ============================================================================

      echo "ðŸ“¡ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ firmware ($firmware_version)..."

      # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ firmware Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ð²ÐµÑ€ÑÐ¸Ð¸
      case "$firmware_version" in
        "latest")
          echo "â¬‡ï¸  Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸ firmware..."
          rpi-eeprom-update -a || echo "âš ï¸  EEPROM update failed, continuing..."
          ;;
        "stable")
          echo "â¬‡ï¸  Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ firmware..."
          rpi-eeprom-update || echo "âš ï¸  EEPROM update failed, continuing..."
          ;;
        "beta")
          echo "â¬‡ï¸  Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° beta Ð²ÐµÑ€ÑÐ¸Ð¸ firmware..."
          rpi-eeprom-update -r || echo "âš ï¸  EEPROM update failed, continuing..."
          ;;
      esac

      # ============================================================================
      # PERFORMANCE AND POWER MANAGEMENT
      # ============================================================================

      echo "âš¡ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸ÐµÐ¼..."

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° overclocking ÐµÑÐ»Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾
      if [[ "$enable_overclock" == "true" ]]; then
        configure_overclock "$device_type"
      fi

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸ÐµÐ¼
      configure_power_management "$power_management"

      # ============================================================================
      # KERNEL PARAMETERS CONFIGURATION
      # ============================================================================

      echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² ÑÐ´Ñ€Ð°..."

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ñ… Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² ÑÐ´Ñ€Ð°
      configure_kernel_parameters

      # ============================================================================
      # HARDWARE OPTIMIZATION
      # ============================================================================

      echo "ðŸš€ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¾Ð±Ð¾Ñ€ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ..."

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° GPU memory split
      configure_gpu_memory "$device_type"

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° USB Ð¸ PCIe (Ð´Ð»Ñ Pi 5)
      if [[ "$device_type" == "pi5" ]]; then
        configure_pcie_usb
      fi

      # ============================================================================
      # SYSTEM TUNING
      # ============================================================================

      echo "ðŸŽ›ï¸  Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ð°Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ..."

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° sysctl Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²
      configure_sysctl_tuning "$device_type"

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° systemd Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ¹ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
      optimize_systemd

      echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° $device_type Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"

  # ============================================================================
  # ÐžÐ§Ð˜Ð¡Ð¢ÐšÐ ÐŸÐžÐ¡Ð›Ð• ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ Ð£Ð¡Ð¢Ð ÐžÐ™Ð¡Ð¢Ð’Ð
  # ============================================================================

  cleanup-hooks:
    - |
      #!/bin/bash
      # Hook: Device Cleanup - ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°
      set -euo pipefail

      # Function for error handling
      die() {
        echo "ERROR: $*" >&2
        exit 1
      }

      # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… (Ð±ÐµÐ· Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ñ ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹)
      device_type="${IGconf_device_device_type:-unknown-device}"

      echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°: $device_type"

      # ============================================================================
      # BACKUP FILE CLEANUP
      # ============================================================================

      echo "ðŸ—‘ï¸  ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¿Ð¸Ð¹..."

      # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ backup Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¸Ð· /boot/firmware
      rm -f /boot/firmware/*.bak 2>/dev/null || true
      rm -f /boot/firmware/*.old 2>/dev/null || true

      # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ hostname backups
      rm -f /etc/hostname.bak 2>/dev/null || true
      rm -f /etc/hosts.bak 2>/dev/null || true

      # ============================================================================
      # TEMPORARY CONFIGURATION CLEANUP
      # ============================================================================

      echo "ðŸ§½ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¹..."

      # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
      rm -f /etc/default/cpufrequtils.tmp 2>/dev/null || true
      rm -f /etc/sysctl.d/99-rpi-optimization.conf.tmp 2>/dev/null || true

      # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… overlay Ñ„Ð°Ð¹Ð»Ð¾Ð²
      find /boot/firmware -name "*.tmp" -delete 2>/dev/null || true

      # ============================================================================
      # PACKAGE CACHE CLEANUP
      # ============================================================================

      echo "ðŸ“¦ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."

      # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° apt cache ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾
      if command -v apt-get >/dev/null 2>&1; then
        apt-get clean 2>/dev/null || true
        rm -rf /var/lib/apt/lists/* 2>/dev/null || true
      fi

      # ============================================================================
      # DEVICE LOGS OPTIMIZATION
      # ============================================================================

      echo "ðŸ“ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð² ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°..."

      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ logrotate Ð´Ð»Ñ device Ð»Ð¾Ð³Ð¾Ð²
      if [[ -d "/var/log/rpi" ]]; then
        cat > "/etc/logrotate.d/rpi-device" << EOF 2>/dev/null || true
/var/log/rpi/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        systemctl reload rsyslog.service || true
    endscript
}
EOF
      fi

      # ============================================================================
      # FIRMWARE UPDATE ARTIFACTS CLEANUP
      # ============================================================================

      echo "ðŸ“¡ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ firmware..."

      # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹ bootloader
      find /boot/firmware -name "kernel*.old" -delete 2>/dev/null || true
      find /boot/firmware -name "start*.old" -delete 2>/dev/null || true

      # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² rpi-update
      rm -rf /boot/.firmware_revision 2>/dev/null || true

      # ============================================================================
      # FINAL VERIFICATION
      # ============================================================================

      echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ..."

      # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð° Ð¼ÐµÑÑ‚Ðµ
      if [[ -f "/etc/hostname" ]] && [[ -f "/boot/firmware/config.txt" ]]; then
        echo "âœ… ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚"
      else
        echo "âš ï¸  ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÑŒ"
      fi

      # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº boot Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
      if [[ -d "/boot/firmware" ]]; then
        boot_perms=$(stat -c '%a' /boot/firmware 2>/dev/null || echo "unknown")
        if [[ "$boot_perms" == "755" ]]; then
          echo "âœ… ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº /boot/firmware ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹"
        else
          echo "âš ï¸  ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº /boot/firmware Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¼Ð¸: $boot_perms"
        fi
      fi

      echo "âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° $device_type Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"

# ============================================================================
# DEVICE-SPECIFIC CONFIGURATION FUNCTIONS
# ============================================================================

configure_pi4_specifics() {
  echo "ðŸŽ¯ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Raspberry Pi 4..."

  # GPU Ð¸ Ð²Ð¸Ð´ÐµÐ¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ Pi 4
  cat >> /boot/firmware/config.txt << 'EOF'

# Raspberry Pi 4 specific configuration
# GPU and video core settings
dtoverlay=vc4-fkms-v3d
max_framebuffers=2
gpu_mem=256
hdmi_enable_4kp60=1

# USB and Ethernet optimizations
usb_max_current_enable=1
dtparam=eth_led0=14
dtparam=eth_led1=14

# PCIe (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ HAT)
dtparam=pciex1_gen=3
EOF

  # CPU governor Ð´Ð»Ñ Pi 4
  cat > /etc/default/cpufrequtils << 'EOF'
GOVERNOR="ondemand"
EOF
}

configure_pi5_specifics() {
  echo "ðŸŽ¯ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Raspberry Pi 5..."

  cat >> /boot/firmware/config.txt << 'EOF'

# Raspberry Pi 5 specific configuration
# Audio and video settings
dtparam=audio=on
dtoverlay=vc4-kms-v3d-pi5

# PCIe Gen 3 support
dtparam=pciex1_gen=3
dtparam=pciex1

# USB 3.0 optimizations
usb_max_current_enable=1
dtoverlay=dwc2,dr_mode=host

# NVMe and high-speed storage
dtparam=pciex1_gen=3
dtoverlay=pciex1-ssd
EOF

  # Performance governor Ð´Ð»Ñ Pi 5
  cat > /etc/default/cpufrequtils << 'EOF'
GOVERNOR="performance"
EOF
}

configure_cm4_specifics() {
  echo "ðŸŽ¯ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Compute Module 4..."

  cat >> /boot/firmware/config.txt << 'EOF'

# Compute Module 4 specific configuration
# Interfaces
dtparam=i2c_arm=on
dtparam=spi=on
dtparam=i2s=on
dtparam=uart0=on
dtparam=uart1=on

# PCIe for NVMe (if available)
dtparam=pciex1_gen=3
dtoverlay=pciex1-ssd

# Disable unused peripherals for power savings
dtoverlay=disable-bt
dtoverlay=disable-wifi
EOF
}

configure_zero2w_specifics() {
  echo "ðŸŽ¯ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Zero 2 W..."

  cat >> /boot/firmware/config.txt << 'EOF'

# Zero 2 W specific configuration
# Wireless and interfaces
dtparam=i2c_arm=on
dtparam=spi=on
dtparam=i2s=on
dtparam=uart0=on

# GPU memory (minimal for headless)
gpu_mem=64

# USB current limit (Zero form factor)
usb_max_current_enable=1
max_usb_current=1

# CPU frequency scaling
arm_freq=1000
arm_freq_min=600
over_voltage=6
EOF
}

# ============================================================================
# PERFORMANCE AND POWER MANAGEMENT FUNCTIONS
# ============================================================================

configure_overclock() {
  local device_type="$1"
  echo "âš¡ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° overclocking Ð´Ð»Ñ $device_type..."

  case "$device_type" in
    "pi4")
      cat >> /boot/firmware/config.txt << 'EOF'

# Raspberry Pi 4 Overclocking
over_voltage=6
arm_freq=2000
gpu_freq=750
EOF
      ;;
    "pi5")
      cat >> /boot/firmware/config.txt << 'EOF'

# Raspberry Pi 5 Overclocking
over_voltage=6
arm_freq=2800
gpu_freq=900
EOF
      ;;
    "zero2w")
      cat >> /boot/firmware/config.txt << 'EOF'

# Zero 2 W Overclocking (conservative)
over_voltage=4
arm_freq=1200
EOF
      ;;
  esac
}

configure_power_management() {
  local mode="$1"
  echo "ðŸ”‹ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸ÐµÐ¼: $mode"

  case "$mode" in
    "performance")
      # ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
      cat > /etc/default/cpufrequtils << 'EOF'
GOVERNOR="performance"
EOF
      ;;
    "balanced")
      # Ð‘Ð°Ð»Ð°Ð½Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð¸ ÑÐ½ÐµÑ€Ð³Ð¾Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ñ
      cat > /etc/default/cpufrequtils << 'EOF'
GOVERNOR="ondemand"
EOF
      ;;
    "powersave")
      # Ð­Ð½ÐµÑ€Ð³Ð¾ÑÐ±ÐµÑ€ÐµÐ¶ÐµÐ½Ð¸Ðµ
      cat > /etc/default/cpufrequtils << 'EOF'
GOVERNOR="powersave"
EOF
      ;;
  esac
}

configure_gpu_memory() {
  local device_type="$1"

  # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° GPU memory Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ‚Ð¸Ð¿Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
  case "$device_type" in
    "pi4")
      # Ð”Ð»Ñ Pi 4 - Ð±Ð°Ð»Ð°Ð½Ñ Ð¼ÐµÐ¶Ð´Ñƒ GPU Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ð¹ Ð¿Ð°Ð¼ÑÑ‚ÑŒÑŽ
      echo "gpu_mem=256" >> /boot/firmware/config.txt
      ;;
    "pi5")
      # Ð”Ð»Ñ Pi 5 - Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ð´Ð»Ñ GPU Ð¸Ð·-Ð·Ð° PCIe Ð¸ USB 3.0
      echo "gpu_mem=384" >> /boot/firmware/config.txt
      ;;
    "zero2w")
      # Ð”Ð»Ñ Zero - Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ð°Ð¼ÑÑ‚ÑŒ Ð´Ð»Ñ headless Ñ€ÐµÐ¶Ð¸Ð¼Ð°
      echo "gpu_mem=64" >> /boot/firmware/config.txt
      ;;
    "cm4")
      # Ð”Ð»Ñ CM4 - Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð·Ð´ÐµÑÑŒ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ)
      echo "gpu_mem=128" >> /boot/firmware/config.txt
      ;;
  esac
}

configure_pcie_usb() {
  echo "ðŸ”Œ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ PCIe Ð¸ USB Ð´Ð»Ñ Pi 5..."

  # PCIe Gen 3 Ð´Ð»Ñ NVMe
  echo "dtparam=pciex1_gen=3" >> /boot/firmware/config.txt
  echo "dtoverlay=pciex1-ssd" >> /boot/firmware/config.txt

  # USB 3.0 optimizations
  echo "dtoverlay=dwc2,dr_mode=host" >> /boot/firmware/config.txt
}

configure_kernel_parameters() {
  echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² ÑÐ´Ñ€Ð°..."

  # ÐžÐ±Ñ‰Ð¸Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ´Ñ€Ð° Ð´Ð»Ñ Ð²ÑÐµÑ… Raspberry Pi ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²
  cat > /etc/sysctl.d/99-rpi-optimization.conf << 'EOF'
# Raspberry Pi kernel optimizations

# Memory management
vm.swappiness=10
vm.vfs_cache_pressure=50
vm.dirty_ratio=20
vm.dirty_background_ratio=5

# Network optimizations
net.core.rmem_max=262144
net.core.wmem_max=262144
net.ipv4.tcp_rmem=4096 87380 262144
net.ipv4.tcp_wmem=4096 87380 262144

# Filesystem optimizations
vm.page-cluster=0
EOF

  # Ð¡Ð¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… ÑÐ´ÐµÑ€
  uname -r | grep -q "raspi" && cat >> /etc/sysctl.d/99-rpi-optimization.conf << 'EOF'

# Raspberry Pi specific parameters
kernel.printk=3 3 3 3
EOF
}

configure_sysctl_tuning() {
  local device_type="$1"

  case "$device_type" in
    "pi5")
      # Ð¡Ð¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Pi 5
      cat >> /etc/sysctl.d/99-rpi-optimization.conf << 'EOF'

# Pi 5 specific optimizations
kernel.sched_min_granularity_ns=10000000
kernel.sched_wakeup_granularity_ns=15000000
EOF
      ;;
    "pi4")
      # ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Pi 4
      cat >> /etc/sysctl.d/99-rpi-optimization.conf << 'EOF'

# Pi 4 specific optimizations
vm.min_free_kbytes=16384
EOF
      ;;
  esac
}

optimize_systemd() {
  echo "âš™ï¸  ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ systemd..."

  # ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½ÐµÐ½ÑƒÐ¶Ð½Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
  systemctl disable bluetooth.service 2>/dev/null || true
  systemctl disable hciuart.service 2>/dev/null || true
  systemctl disable triggerhappy.service 2>/dev/null || true

  # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° journald Ð´Ð»Ñ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ð»Ð¾Ð³Ð¾Ð²
  cat > /etc/systemd/journald.conf << 'EOF'
[Journal]
Storage=volatile
RuntimeMaxUse=64M
RuntimeMaxFileSize=8M
EOF
}
