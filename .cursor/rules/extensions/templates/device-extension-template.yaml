# METABEGIN
# X-Env-Layer-Name: ${extension_name}
# X-Env-Layer-Category: device
# X-Env-Layer-Description: ${description}
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: essential
# X-Env-VarPrefix: device
#
# X-Env-Var-device_type: ${device_type}
# X-Env-Var-device_type-Description: –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ Raspberry Pi –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
# X-Env-Var-device_type-Required: true
# X-Env-Var-device_type-Valid: pi4,pi5,cm4,zero2w
#
# X-Env-Var-firmware_version: latest
# X-Env-Var-firmware_version-Description: –í–µ—Ä—Å–∏—è firmware Raspberry Pi –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
# X-Env-Var-firmware_version-Required: false
# X-Env-Var-firmware_version-Valid: latest,stable,beta
#
# X-Env-Var-hostname: rpi-${device_type}-${HOST_SUFFIX}
# X-Env-Var-hostname-Description: –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ö–æ—Å—Ç–∞ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
# X-Env-Var-hostname-Required: false
# X-Env-Var-hostname-Valid: regex:^[a-zA-Z0-9.-]+$
#
# X-Env-Var-enable_overclock: false
# X-Env-Var-enable_overclock-Description: –í–∫–ª—é—á–∏—Ç—å —Ä–∞–∑–≥–æ–Ω –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –∏ –ø–∞–º—è—Ç–∏
# X-Env-Var-enable_overclock-Required: false
# X-Env-Var-enable_overclock-Valid: true,false
#
# X-Env-Var-power_management: balanced
# X-Env-Var-power_management-Description: –†–µ–∂–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º
# X-Env-Var-power_management-Required: false
# X-Env-Var-power_management-Valid: performance,balanced,powersave
# METAEND
---
mmdebstrap:
  # ============================================================================
  # –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –ò –ü–ê–ö–ï–¢–´
  # ============================================================================

  packages:
    # Raspberry Pi bootloader –∏ firmware
    - raspberrypi-bootloader
    - raspberrypi-kernel
    - linux-firmware-raspi
    - rpi-eeprom

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
    - raspi-config
    - rpi-update
    - usbutils
    - pciutils

  # ============================================================================
  # –•–£–ö–ò –ü–û–î–ì–û–¢–û–í–ö–ò
  # ============================================================================

  setup-hooks:
    - |
      #!/bin/bash
      # Hook: Device Setup - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      set -euo pipefail

      # Function for error handling
      die() {
        echo "ERROR: $*" >&2
        exit 1
      }

      # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
      device_type="${IGconf_device_device_type:?device_type not configured}"

      echo "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Ç–∏–ø–∞: $device_type"

      # ============================================================================
      # DIRECTORY STRUCTURE SETUP
      # ============================================================================

      echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."

      # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è Raspberry Pi
      mkdir -p /boot/firmware || die "Failed to create /boot/firmware directory"
      mkdir -p /var/lib/raspberrypi || die "Failed to create Raspberry Pi lib directory"
      mkdir -p /opt/vc || die "Failed to create VideoCore directory"

      # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –ª–æ–≥–æ–≤ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      mkdir -p /var/log/rpi || die "Failed to create device log directory"
      mkdir -p /etc/rpi || die "Failed to create device config directory"

      # ============================================================================
      # DEVICE-SPECIFIC PREPARATION
      # ============================================================================

      echo "üîç –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è $device_type..."

      # –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      case "$device_type" in
        "pi4")
          # Raspberry Pi 4 specific preparation
          echo "üéØ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è Raspberry Pi 4"
          ;;
        "pi5")
          # Raspberry Pi 5 specific preparation
          echo "üéØ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è Raspberry Pi 5"
          ;;
        "cm4")
          # Compute Module 4 specific preparation
          echo "üéØ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è Compute Module 4"
          ;;
        "zero2w")
          # Zero 2 W specific preparation
          echo "üéØ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è Zero 2 W"
          ;;
        *)
          echo "‚ö†Ô∏è  –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: $device_type, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—â–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞"
          ;;
      esac

      # ============================================================================
      # PERMISSIONS SETUP
      # ============================================================================

      echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–ª—è boot –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
      chmod 755 /boot/firmware || die "Failed to set permissions for /boot/firmware"

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–ª—è Raspberry Pi —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
      chmod 755 /var/lib/raspberrypi || die "Failed to set permissions for Raspberry Pi lib"
      chmod 755 /var/log/rpi || die "Failed to set permissions for device logs"
      chmod 755 /etc/rpi || die "Failed to set permissions for device config"

      echo "‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ $device_type –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
  customize-hooks:
    - |
      #!/bin/bash
      # Hook: Device Configuration - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ Raspberry Pi
      set -euo pipefail

      # Function for error handling
      die() {
        echo "ERROR: $*" >&2
        exit 1
      }

      # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
      device_type="${IGconf_device_device_type:?device_type not configured}"
      firmware_version="${IGconf_device_firmware_version:-latest}"
      hostname="${IGconf_device_hostname:-rpi-$device_type}"
      enable_overclock="${IGconf_device_enable_overclock:-false}"
      power_management="${IGconf_device_power_management:-balanced}"

      # –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
      case "$device_type" in
        pi4|pi5|cm4|zero2w) ;;
        *) die "Unsupported device type: $device_type" ;;
      esac

      case "$firmware_version" in
        latest|stable|beta) ;;
        *) die "Unsupported firmware version: $firmware_version" ;;
      esac

      case "$power_management" in
        performance|balanced|powersave) ;;
        *) die "Unsupported power management mode: $power_management" ;;
      esac

      echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ $device_type (firmware: $firmware_version)"

      # ============================================================================
      # HOSTNAME CONFIGURATION
      # ============================================================================

      echo "üè∑Ô∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ hostname: $hostname"

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ hostname
      echo "$hostname" > /etc/hostname || die "Failed to set hostname"
      sed -i "s/127.0.1.1.*/127.0.1.1\t$hostname/" /etc/hosts || die "Failed to update hosts file"

      # ============================================================================
      # DEVICE-SPECIFIC CONFIGURATION
      # ============================================================================

      echo "üéØ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è $device_type..."

      # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      case "$device_type" in
        "pi4")
          configure_pi4_specifics
          ;;
        "pi5")
          configure_pi5_specifics
          ;;
        "cm4")
          configure_cm4_specifics
          ;;
        "zero2w")
          configure_zero2w_specifics
          ;;
        *)
          echo "‚ö†Ô∏è  –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: $device_type" >&2
          ;;
      esac

      # ============================================================================
      # FIRMWARE MANAGEMENT
      # ============================================================================

      echo "üì° –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ firmware ($firmware_version)..."

      # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ firmware —Å —É—á–µ—Ç–æ–º –≤–µ—Ä—Å–∏–∏
      case "$firmware_version" in
        "latest")
          echo "‚¨áÔ∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ firmware..."
          rpi-eeprom-update -a || echo "‚ö†Ô∏è  EEPROM update failed, continuing..."
          ;;
        "stable")
          echo "‚¨áÔ∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ firmware..."
          rpi-eeprom-update || echo "‚ö†Ô∏è  EEPROM update failed, continuing..."
          ;;
        "beta")
          echo "‚¨áÔ∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ beta –≤–µ—Ä—Å–∏–∏ firmware..."
          rpi-eeprom-update -r || echo "‚ö†Ô∏è  EEPROM update failed, continuing..."
          ;;
      esac

      # ============================================================================
      # PERFORMANCE AND POWER MANAGEMENT
      # ============================================================================

      echo "‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º..."

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ overclocking –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
      if [[ "$enable_overclock" == "true" ]]; then
        configure_overclock "$device_type"
      fi

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º
      configure_power_management "$power_management"

      # ============================================================================
      # KERNEL PARAMETERS CONFIGURATION
      # ============================================================================

      echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —è–¥—Ä–∞..."

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —è–¥—Ä–∞
      configure_kernel_parameters

      # ============================================================================
      # HARDWARE OPTIMIZATION
      # ============================================================================

      echo "üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è..."

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GPU memory split
      configure_gpu_memory "$device_type"

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ USB –∏ PCIe (–¥–ª—è Pi 5)
      if [[ "$device_type" == "pi5" ]]; then
        configure_pcie_usb
      fi

      # ============================================================================
      # SYSTEM TUNING
      # ============================================================================

      echo "üéõÔ∏è  –°–∏—Å—Ç–µ–º–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è..."

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ sysctl –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      configure_sysctl_tuning "$device_type"

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      optimize_systemd

      echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ $device_type –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"

  # ============================================================================
  # –û–ß–ò–°–¢–ö–ê –ü–û–°–õ–ï –ù–ê–°–¢–†–û–ô–ö–ò –£–°–¢–†–û–ô–°–¢–í–ê
  # ============================================================================

  cleanup-hooks:
    - |
      #!/bin/bash
      # Hook: Device Cleanup - –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      set -euo pipefail

      # Function for error handling
      die() {
        echo "ERROR: $*" >&2
        exit 1
      }

      # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)
      device_type="${IGconf_device_device_type:-unknown-device}"

      echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: $device_type"

      # ============================================================================
      # BACKUP FILE CLEANUP
      # ============================================================================

      echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."

      # –£–¥–∞–ª–µ–Ω–∏–µ backup —Ñ–∞–π–ª–æ–≤ –∏–∑ /boot/firmware
      rm -f /boot/firmware/*.bak 2>/dev/null || true
      rm -f /boot/firmware/*.old 2>/dev/null || true

      # –£–¥–∞–ª–µ–Ω–∏–µ hostname backups
      rm -f /etc/hostname.bak 2>/dev/null || true
      rm -f /etc/hosts.bak 2>/dev/null || true

      # ============================================================================
      # TEMPORARY CONFIGURATION CLEANUP
      # ============================================================================

      echo "üßΩ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π..."

      # –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
      rm -f /etc/default/cpufrequtils.tmp 2>/dev/null || true
      rm -f /etc/sysctl.d/99-rpi-optimization.conf.tmp 2>/dev/null || true

      # –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö overlay —Ñ–∞–π–ª–æ–≤
      find /boot/firmware -name "*.tmp" -delete 2>/dev/null || true

      # ============================================================================
      # PACKAGE CACHE CLEANUP
      # ============================================================================

      echo "üì¶ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø–∞–∫–µ—Ç–æ–≤..."

      # –û—á–∏—Å—Ç–∫–∞ apt cache –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
      if command -v apt-get >/dev/null 2>&1; then
        apt-get clean 2>/dev/null || true
        rm -rf /var/lib/apt/lists/* 2>/dev/null || true
      fi

      # ============================================================================
      # DEVICE LOGS OPTIMIZATION
      # ============================================================================

      echo "üìù –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..."

      # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ logrotate –¥–ª—è device –ª–æ–≥–æ–≤
      if [[ -d "/var/log/rpi" ]]; then
        cat > "/etc/logrotate.d/rpi-device" << EOF 2>/dev/null || true
/var/log/rpi/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        systemctl reload rsyslog.service || true
    endscript
}
EOF
      fi

      # ============================================================================
      # FIRMWARE UPDATE ARTIFACTS CLEANUP
      # ============================================================================

      echo "üì° –û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è firmware..."

      # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π bootloader
      find /boot/firmware -name "kernel*.old" -delete 2>/dev/null || true
      find /boot/firmware -name "start*.old" -delete 2>/dev/null || true

      # –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ rpi-update
      rm -rf /boot/.firmware_revision 2>/dev/null || true

      # ============================================================================
      # FINAL VERIFICATION
      # ============================================================================

      echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è..."

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ
      if [[ -f "/etc/hostname" ]] && [[ -f "/boot/firmware/config.txt" ]]; then
        echo "‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç"
      else
        echo "‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å"
      fi

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ boot –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
      if [[ -d "/boot/firmware" ]]; then
        boot_perms=$(stat -c '%a' /boot/firmware 2>/dev/null || echo "unknown")
        if [[ "$boot_perms" == "755" ]]; then
          echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ /boot/firmware –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã"
        else
          echo "‚ö†Ô∏è  –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ /boot/firmware –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏: $boot_perms"
        fi
      fi

      echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ $device_type –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"

# ============================================================================
# DEVICE-SPECIFIC CONFIGURATION FUNCTIONS
# ============================================================================

configure_pi4_specifics() {
  echo "üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Raspberry Pi 4..."

  # GPU –∏ –≤–∏–¥–µ–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Pi 4
  cat >> /boot/firmware/config.txt << 'EOF'

# Raspberry Pi 4 specific configuration
# GPU and video core settings
dtoverlay=vc4-fkms-v3d
max_framebuffers=2
gpu_mem=256
hdmi_enable_4kp60=1

# USB and Ethernet optimizations
usb_max_current_enable=1
dtparam=eth_led0=14
dtparam=eth_led1=14

# PCIe (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HAT)
dtparam=pciex1_gen=3
EOF

  # CPU governor –¥–ª—è Pi 4
  cat > /etc/default/cpufrequtils << 'EOF'
GOVERNOR="ondemand"
EOF
}

configure_pi5_specifics() {
  echo "üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Raspberry Pi 5..."

  cat >> /boot/firmware/config.txt << 'EOF'

# Raspberry Pi 5 specific configuration
# Audio and video settings
dtparam=audio=on
dtoverlay=vc4-kms-v3d-pi5

# PCIe Gen 3 support
dtparam=pciex1_gen=3
dtparam=pciex1

# USB 3.0 optimizations
usb_max_current_enable=1
dtoverlay=dwc2,dr_mode=host

# NVMe and high-speed storage
dtparam=pciex1_gen=3
dtoverlay=pciex1-ssd
EOF

  # Performance governor –¥–ª—è Pi 5
  cat > /etc/default/cpufrequtils << 'EOF'
GOVERNOR="performance"
EOF
}

configure_cm4_specifics() {
  echo "üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Compute Module 4..."

  cat >> /boot/firmware/config.txt << 'EOF'

# Compute Module 4 specific configuration
# Interfaces
dtparam=i2c_arm=on
dtparam=spi=on
dtparam=i2s=on
dtparam=uart0=on
dtparam=uart1=on

# PCIe for NVMe (if available)
dtparam=pciex1_gen=3
dtoverlay=pciex1-ssd

# Disable unused peripherals for power savings
dtoverlay=disable-bt
dtoverlay=disable-wifi
EOF
}

configure_zero2w_specifics() {
  echo "üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Zero 2 W..."

  cat >> /boot/firmware/config.txt << 'EOF'

# Zero 2 W specific configuration
# Wireless and interfaces
dtparam=i2c_arm=on
dtparam=spi=on
dtparam=i2s=on
dtparam=uart0=on

# GPU memory (minimal for headless)
gpu_mem=64

# USB current limit (Zero form factor)
usb_max_current_enable=1
max_usb_current=1

# CPU frequency scaling
arm_freq=1000
arm_freq_min=600
over_voltage=6
EOF
}

# ============================================================================
# PERFORMANCE AND POWER MANAGEMENT FUNCTIONS
# ============================================================================

configure_overclock() {
  local device_type="$1"
  echo "‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ overclocking –¥–ª—è $device_type..."

  case "$device_type" in
    "pi4")
      cat >> /boot/firmware/config.txt << 'EOF'

# Raspberry Pi 4 Overclocking
over_voltage=6
arm_freq=2000
gpu_freq=750
EOF
      ;;
    "pi5")
      cat >> /boot/firmware/config.txt << 'EOF'

# Raspberry Pi 5 Overclocking
over_voltage=6
arm_freq=2800
gpu_freq=900
EOF
      ;;
    "zero2w")
      cat >> /boot/firmware/config.txt << 'EOF'

# Zero 2 W Overclocking (conservative)
over_voltage=4
arm_freq=1200
EOF
      ;;
  esac
}

configure_power_management() {
  local mode="$1"
  echo "üîã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º: $mode"

  case "$mode" in
    "performance")
      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      cat > /etc/default/cpufrequtils << 'EOF'
GOVERNOR="performance"
EOF
      ;;
    "balanced")
      # –ë–∞–ª–∞–Ω—Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
      cat > /etc/default/cpufrequtils << 'EOF'
GOVERNOR="ondemand"
EOF
      ;;
    "powersave")
      # –≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ
      cat > /etc/default/cpufrequtils << 'EOF'
GOVERNOR="powersave"
EOF
      ;;
  esac
}

configure_gpu_memory() {
  local device_type="$1"

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GPU memory –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  case "$device_type" in
    "pi4")
      # –î–ª—è Pi 4 - –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É GPU –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π –ø–∞–º—è—Ç—å—é
      echo "gpu_mem=256" >> /boot/firmware/config.txt
      ;;
    "pi5")
      # –î–ª—è Pi 5 - –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏ –¥–ª—è GPU –∏–∑-–∑–∞ PCIe –∏ USB 3.0
      echo "gpu_mem=384" >> /boot/firmware/config.txt
      ;;
    "zero2w")
      # –î–ª—è Zero - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –¥–ª—è headless —Ä–µ–∂–∏–º–∞
      echo "gpu_mem=64" >> /boot/firmware/config.txt
      ;;
    "cm4")
      # –î–ª—è CM4 - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–∑–¥–µ—Å—å –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è)
      echo "gpu_mem=128" >> /boot/firmware/config.txt
      ;;
  esac
}

configure_pcie_usb() {
  echo "üîå –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è PCIe –∏ USB –¥–ª—è Pi 5..."

  # PCIe Gen 3 –¥–ª—è NVMe
  echo "dtparam=pciex1_gen=3" >> /boot/firmware/config.txt
  echo "dtoverlay=pciex1-ssd" >> /boot/firmware/config.txt

  # USB 3.0 optimizations
  echo "dtoverlay=dwc2,dr_mode=host" >> /boot/firmware/config.txt
}

configure_kernel_parameters() {
  echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —è–¥—Ä–∞..."

  # –û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —è–¥—Ä–∞ –¥–ª—è –≤—Å–µ—Ö Raspberry Pi —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  cat > /etc/sysctl.d/99-rpi-optimization.conf << 'EOF'
# Raspberry Pi kernel optimizations

# Memory management
vm.swappiness=10
vm.vfs_cache_pressure=50
vm.dirty_ratio=20
vm.dirty_background_ratio=5

# Network optimizations
net.core.rmem_max=262144
net.core.wmem_max=262144
net.ipv4.tcp_rmem=4096 87380 262144
net.ipv4.tcp_wmem=4096 87380 262144

# Filesystem optimizations
vm.page-cluster=0
EOF

  # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–¥–µ—Ä
  uname -r | grep -q "raspi" && cat >> /etc/sysctl.d/99-rpi-optimization.conf << 'EOF'

# Raspberry Pi specific parameters
kernel.printk=3 3 3 3
EOF
}

configure_sysctl_tuning() {
  local device_type="$1"

  case "$device_type" in
    "pi5")
      # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è Pi 5
      cat >> /etc/sysctl.d/99-rpi-optimization.conf << 'EOF'

# Pi 5 specific optimizations
kernel.sched_min_granularity_ns=10000000
kernel.sched_wakeup_granularity_ns=15000000
EOF
      ;;
    "pi4")
      # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è Pi 4
      cat >> /etc/sysctl.d/99-rpi-optimization.conf << 'EOF'

# Pi 4 specific optimizations
vm.min_free_kbytes=16384
EOF
      ;;
  esac
}

optimize_systemd() {
  echo "‚öôÔ∏è  –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è systemd..."

  # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  systemctl disable bluetooth.service 2>/dev/null || true
  systemctl disable hciuart.service 2>/dev/null || true
  systemctl disable triggerhappy.service 2>/dev/null || true

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ journald –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥–æ–≤
  cat > /etc/systemd/journald.conf << 'EOF'
[Journal]
Storage=volatile
RuntimeMaxUse=64M
RuntimeMaxFileSize=8M
EOF
}
