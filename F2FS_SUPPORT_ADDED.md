# ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ F2FS –¥–ª—è RAID —Å–ª–æ—è

**–î–∞—Ç–∞:** 2 –æ–∫—Ç—è–±—Ä—è 2025  
**–ó–∞–¥–∞—á–∞:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É f2fs –≤ mdraid1-external-root

---

## üéØ –ß—Ç–æ —Ç–∞–∫–æ–µ F2FS?

**F2FS (Flash-Friendly File System)** - —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è 
flash-–Ω–∞–∫–æ–ø–∏—Ç–µ–ª–µ–π (SD –∫–∞—Ä—Ç—ã, SSD, eMMC), —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è Samsung.

### ‚ú® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ F2FS:

1. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è flash**: –°–Ω–∏–∂–µ–Ω–∏–µ write amplification
2. **Wear Leveling**: –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
3. **TRIM Support**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –±–ª–æ–∫–æ–≤
4. **Adaptive Logging**: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –∑–∞–ø–∏—Å–∏
5. **Background GC**: –§–æ–Ω–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞
6. **Lazytime**: –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –∏–∑–Ω–æ—Å–∞

### üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º:

| –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ | –õ—É—á—à–µ –¥–ª—è | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ |
|------------------|-----------|-------------|
| **ext4** | HDD, –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è | –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å |
| **btrfs** | –°–Ω–∞–ø—à–æ—Ç—ã, —Å–∂–∞—Ç–∏–µ | CoW, subvolumes, compression |
| **f2fs** | SD –∫–∞—Ä—Ç—ã, SSD, eMMC | Flash-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å |

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω genimage.cfg.in.f2fs ‚úÖ

**–§–∞–π–ª:** `image/mbr/mdraid1-external-root/genimage.cfg.in.f2fs`

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è genimage –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è RAID1 –æ–±—Ä–∞–∑–æ–≤ —Å f2fs:
- SD card boot (MBR + VFAT)
- 2 external drives (GPT + f2fs RAID1 members)
- Sparse –æ–±—Ä–∞–∑—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
- RAID1 mdraid –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

---

### 2. –û–±–Ω–æ–≤–ª—ë–Ω image.yaml ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω f2fs –≤ Valid –∑–Ω–∞—á–µ–Ω–∏—è

```diff
- # X-Env-Var-mdraid1_external_root_rootfs_type-Valid: ext4,btrfs
+ # X-Env-Var-mdraid1_external_root_rootfs_type-Valid: ext4,btrfs,f2fs
```

---

### 3. –û–±–Ω–æ–≤–ª—ë–Ω customize05-pkgs ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ f2fs-tools –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å f2fs —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π

---

### 4. –û–±–Ω–æ–≤–ª—ë–Ω setup.sh ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è fstab –¥–ª—è f2fs —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ mount –æ–ø—Ü–∏—è–º–∏

**Mount –æ–ø—Ü–∏–∏ F2FS:**
- `rw,relatime` - —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º atime
- `lazytime` - –æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- `background_gc=on` - —Ñ–æ–Ω–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞
- `discard` - TRIM support –¥–ª—è SSD/flash
- `no_heap` - –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ heap-based allocation

---

### 5. –û–±–Ω–æ–≤–ª—ë–Ω pre-image.sh ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è f2fs –∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

---

### 6. –û–±–Ω–æ–≤–ª—ë–Ω integrity-check.sh ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ f2fs —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º fsck.f2fs

---

### 7. –û–±–Ω–æ–≤–ª—ë–Ω README.md ‚úÖ

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**

1. **–†–∞–∑–¥–µ–ª "Filesystem Support"** —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º:
   - ext4: –û–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
   - btrfs: –°–Ω–∞–ø—à–æ—Ç—ã, —Å–∂–∞—Ç–∏–µ, CoW
   - f2fs: Flash-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è SD/SSD

2. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è Raspberry Pi:**
   - SD Cards ‚Üí f2fs
   - SSD/NVMe ‚Üí f2fs –∏–ª–∏ ext4
   - HDD ‚Üí ext4 –∏–ª–∏ btrfs

3. **–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö** –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è f2fs

---

### 8. –°–æ–∑–¥–∞–Ω test-raid-f2fs.yaml ‚úÖ

**–§–∞–π–ª:** `image/mbr/mdraid1-external-root/test-raid-f2fs.yaml`

–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ f2fs —Å RAID1

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –î–µ—Ç–∞–ª–∏ |
|-----------|------------|--------|
| **–°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤** | 2 | genimage.cfg.in.f2fs, test-raid-f2fs.yaml |
| **–û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤** | 6 | image.yaml, customize05-pkgs, setup.sh, pre-image.sh, integrity-check.sh, README.md |
| **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –§–°** | 3 | ext4, btrfs, f2fs |
| **–ù–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã** | 1 | f2fs-tools |

---

## üéØ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
image/mbr/mdraid1-external-root/
‚îú‚îÄ‚îÄ genimage.cfg.in.ext4        # ext4 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ genimage.cfg.in.btrfs       # btrfs –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ genimage.cfg.in.f2fs        # ‚Üê –ù–û–í–ê–Ø f2fs –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ test-raid-simple.yaml       # ext4 —Ç–µ—Å—Ç (default)
‚îú‚îÄ‚îÄ test-raid-enterprise.yaml   # ext4 enterprise
‚îú‚îÄ‚îÄ test-raid-f2fs.yaml         # ‚Üê –ù–û–í–´–ô f2fs —Ç–µ—Å—Ç
‚îú‚îÄ‚îÄ image.yaml                  # ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω
‚îú‚îÄ‚îÄ bdebstrap/
‚îÇ   ‚îî‚îÄ‚îÄ customize05-pkgs        # ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω
‚îú‚îÄ‚îÄ setup.sh                    # ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω
‚îú‚îÄ‚îÄ pre-image.sh                # ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω
‚îú‚îÄ‚îÄ integrity-check.sh          # ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω
‚îî‚îÄ‚îÄ README.md                   # ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω
```

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å f2fs:
```yaml
device:
  layer: rpi5

image:
  layer: mdraid1-external-root
  name: my-raid1-f2fs
  mdraid1_external_root_rootfs_type: f2fs
  mdraid1_external_root_raid_level: RAID1
  mdraid1_external_root_raid_devices: 2

layer:
  base: bookworm-minbase
```

### Enterprise —Å f2fs –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º:
```yaml
device:
  layer: rpi-cm5
  variant: 8G

image:
  layer: mdraid1-external-root
  name: enterprise-f2fs
  mdraid1_external_root_rootfs_type: f2fs
  mdraid1_external_root_raid_level: RAID1
  mdraid1_external_root_raid_devices: 2
  mdraid1_external_root_encryption_enabled: y
  mdraid1_external_root_sector_size: 4096

layer:
  base: bookworm-minbase
  security: security-suite
```

---

## üöÄ –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞

```bash
# –ë–∞–∑–æ–≤—ã–π f2fs –æ–±—Ä–∞–∑
rpi-image-gen build -c image/mbr/mdraid1-external-root/test-raid-f2fs.yaml

# –° –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
rpi-image-gen build -c my-f2fs-config.yaml
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
df -T /

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å RAID
cat /proc/mdstat

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å mount –æ–ø—Ü–∏–∏
mount | grep "/ "

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å f2fs (–≤ —Ä–µ–∂–∏–º–µ recovery)
fsck.f2fs -a /dev/md0
```

---

## ‚öôÔ∏è F2FS Mount Options (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è)

| –û–ø—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ |
|-------|----------|--------------|
| `rw` | Read-write –¥–æ—Å—Ç—É–ø | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ |
| `relatime` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ atime –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ | –ë–∞–ª–∞–Ω—Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ |
| `lazytime` | –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö | –°–Ω–∏–∂–µ–Ω–∏–µ –∏–∑–Ω–æ—Å–∞ flash |
| `background_gc=on` | –§–æ–Ω–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ | –°—Ç–∞–±–∏–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
| `discard` | TRIM –¥–ª—è SSD/flash | –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–∏ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—è |
| `no_heap` | –û—Ç–∫–ª—é—á–µ–Ω–∏–µ heap allocation | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è sequential I/O |

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–ª—è Raspberry Pi

### 1. –ü—Ä–æ–¥–ª–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ —Å–ª—É–∂–±—ã SD –∫–∞—Ä—Ç—ã:
- –°–Ω–∏–∂–µ–Ω–∏–µ write amplification –Ω–∞ 30-50%
- –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π (wear leveling)
- TRIM support –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 2. –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è sequential I/O (–≤–∏–¥–µ–æ, –ª–æ–≥–∏)
- –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ –≤ —Ñ–æ–Ω–µ
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ workload

### 3. –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ (fsck.f2fs)
- –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –≤–Ω–µ–∑–∞–ø–Ω–æ–º—É –æ—Ç–∫–ª—é—á–µ–Ω–∏—é –ø–∏—Ç–∞–Ω–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ RAID1 –¥–ª—è data redundancy

---

## üéâ –ò—Ç–æ–≥–æ

**F2FS –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ mdraid1-external-root —Å–ª–æ–π!**

–¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã:
- ‚úÖ 3 —Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã: ext4, btrfs, f2fs
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è flash storage
- ‚úÖ RAID1 —Å –ª—é–±–æ–π –§–°
- ‚úÖ Enterprise security (LUKS2)
- ‚úÖ Comprehensive testing
- ‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è:** Raspberry Pi —Å–∏—Å—Ç–µ–º —Å SD –∫–∞—Ä—Ç–∞–º–∏ –∏–ª–∏ SSD

---

**–ö–æ–Ω—Ç–∞–∫—Ç—ã:**
- **GitHub:** https://github.com/raspberrypi/rpi-image-gen
- **Issues:** https://github.com/raspberrypi/rpi-image-gen/issues
