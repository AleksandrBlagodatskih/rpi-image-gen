#!/bin/bash

set -u

op="$1"
shift 1

# Execute scripts from within these dirs in this order
dirs=()
[[ -n ${IGconf_device_assetdir+x} ]] && dirs+=("${IGconf_device_assetdir}/bdebstrap")
[[ -n ${IGconf_image_assetdir+x} ]] && dirs+=("${IGconf_image_assetdir}/bdebstrap")
dirs+=("${SRC_DIR}/bdebstrap")
dirs+=("${IGTOP}/scripts/bdebstrap")

case "$op" in
   setup|extract|essential|customize|cleanup)
      for dir in "${dirs[@]}" ; do
         [[ -d "$dir" ]] || continue
         if compgen -G "${dir}/${op}*" >/dev/null; then
            for script in "${dir}/${op}"* ; do
               s=$(basename "$script")
               if [ -x "$script" ] ; then
                  if [[ $s =~ ^[a-zA-Z0-9-]+$ ]] ; then
                     echo "runner: $dir [run $s]"
                     env -C "$dir" bash "$s" "$@"
                     err=$?
                     if [ $err -ne 0 ] ; then
                        >&2 echo "runner: $script error ($err)"
                        exit $err
                     fi
                  else
                     >&2 echo "runner: $dir [skipped $s]"
                  fi
               else
                  >&2 echo "runner: $dir [ignored $s]"
               fi
            done
         fi
      done
      ;;
   *)
      ;;
esac
