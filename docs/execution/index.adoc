= rpi-image-gen - Execution Flow
:toc: left
:toclevels: 3
:sectlinks:
:sectanchors:

link:../index.adoc[‚Üê Back to Main Documentation]

== Overview

The rpi-image-gen build process consists of five main stages executed sequentially:

. **Parameter Assembly** - Input validation and configuration parsing
. **Layer Processing** - Layer collection, validation, and dependency resolution
. **Build Preparation** - Environment setup and bdebstrap configuration
. **Filesystem Generation** - Filesystem creation followed by hooks and overlays
. **Image Generation** - Disk image creation

== Stage 1: Parameter Assembly

=== Purpose
Validate input arguments, parse configuration files, and establish the initial environment for subsequent stages.

=== Activities

* **Input Validation and Override Processing**: CLI processing
* **Config Parsing**: Configuration file parsing
* **Environment Injection**: Path setup, initial internal setup
* **Sanity Checks**: Validate input sources

== Stage 2: Layer Processing

=== Purpose
Discover, validate, and order all layers specified in the configuration, and expand all configuration variables to their final values.

=== Activities

* **Layer Collection**: Extract layer references from config
* **Layer Validation**: Generate layer configuration variables
* **Dependency Resolution**: Resolve layer build order to determine the build sequence
* **Variable Expansion**: Resolves configuration variables with defined policy handling

== Stage 3: Build Preparation

=== Purpose
Set up the build environment and assemble bdebstrap parameters with the necessary configuration.

=== Activities

* **Path Configuration**: Paths updated to allow location of host binaries and tools
* **APT Configuration**: Configure apt settings including:
  ** Key directories
  ** Cache settings
  ** Proxy settings
  ** Package options
* **Command Assembly**: Constructs the initial bdebstrap command including:
  ** Environment variables
  ** Target settings
  ** All compatible YAML layer files
  ** Installing core hook runners for setup, essential, customize, and cleanup phases

== Stage 4: Filesystem Generation

=== Purpose
Create the filesystem and generate the Software Bill of Materials.

=== Activities

* *Hook*`[pre-build.sh]`: Execute from within image and device directories.
  ** _Example Use_ - Custom validation of pre-build settings
* *Filesystem Generation*: Execute bdebstrap
* *Overlays*: Apply static filesystem overlays from image and device `rootfs-overlay/` directories.
* *Hook*`[post-build.sh]`: Execute from within image and device directories.
  ** _Example Use_ - Custom installation of image or device specific assets, eg boot configuration files.
* *SBOM*: Execute the Software Bill of Materials provider to create the SBOM file.

== Stage 5: Image Generation

=== Purpose

Create disk images from the prepared filesystem using the provider.

=== Activities

* *Hook*`[pre-image.sh]`: Execute from within device and image directories.
  ** _Example Use_ - Creating genimage templates, setting up image creation resources.
* *Image Generation*: Execute the image provider to create images.
* *Hook*`[post-image.sh]`: Execute from within device and image directories, or default fallback.
  ** _Example Use_ - Artefact compression and packaging, deployment

== Hooks

[IMPORTANT]
====
Hooks are optional but if a hook is to be executed, it must have executable permissions for the user performing the build.
====

== Interactive Mode

A CLI option allows execution to pause between major operations for user confirmation. This may be useful for inspecting log output prior to building.
