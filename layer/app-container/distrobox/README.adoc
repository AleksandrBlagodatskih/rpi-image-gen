= Distrobox Layer

== Обзор

Этот слой устанавливает **Distrobox** - инструмент для создания контейнеров с различными дистрибутивами Linux внутри терминала. Distrobox по умолчанию использует Docker как backend и обеспечивает тесную интеграцию с хост-системой.

== Container Manager

По умолчанию слой настроен для использования **Docker**. Также поддерживаются:

* `docker` - Docker (по умолчанию)
* `podman` - Podman
* `lilipod` - Lilipod
* `auto` - Автоматическое определение (Docker → Podman → Lilipod)

Автоматическая настройка происходит при первом входе пользователя в систему.

== Зависимости

* Docker (любой из docker слоев: `docker-debian-bookworm`, `docker-debian-trixie`)
* rpi-user-credentials (для настройки пользователей)
* sys-build-base (системные утилиты сборки)

== Совместимость

Слой работает с любыми базовыми образами Debian:

* `bookworm-minbase` - Debian Bookworm
* `trixie-minbase` - Debian Trixie
* `rpi-debian-bookworm` - Raspberry Pi Debian Bookworm
* `rpi-debian-trixie` - Raspberry Pi Debian Trixie

Container manager может быть установлен отдельно или автоматически определен:

== Переменные конфигурации

* `distrobox_container_manager`: Менеджер контейнеров (auto/docker/podman/lilipod) [по умолчанию: docker]
* `distrobox_default_image`: Образ по умолчанию для новых контейнеров [по умолчанию: debian:bookworm]
* `distrobox_generate_entry`: Генерировать записи в меню приложений [по умолчанию: y]
* `distrobox_non_interactive`: Пропускать интерактивные запросы [по умолчанию: n]

== Примеры использования

=== Базовое использование с автоматическим определением

[source,bash]
----
# Создать контейнер с Ubuntu
distrobox create --name ubuntu-dev --image ubuntu:22.04

# Войти в контейнер
distrobox enter ubuntu-dev

# Установить инструменты разработки
sudo apt update && sudo apt install -y build-essential git vim

# Экспортировать приложение на хост
distrobox-export --app code
----

=== Использование с Docker (явно)

[source,bash]
----
# Создать контейнер с явным указанием Docker
distrobox create --name fedora-dev --image fedora:38 --additional-flags "--runtime docker"

# Или через переменную окружения
CONTAINER_MANAGER=docker distrobox create --name fedora-dev --image fedora:38
----

=== Использование с assemble файлами

[source,ini]
----
# /usr/local/share/doc/distrobox/examples/debian-dev.ini
[debian-dev]
image=debian:bookworm
additional_packages=build-essential git vim curl wget
init_hooks=~/.config/distrobox/init-hooks/debian-dev.sh
nvidia=false
----

[source,bash]
----
# Создать контейнер из конфигурации
distrobox assemble create --file /usr/local/share/doc/distrobox/examples/debian-dev.ini
----

=== Автоматическое создание контейнеров

[source,bash]
----
# Создать временный контейнер (удалится при выходе)
distrobox ephemeral --image ubuntu:22.04

# Клонировать существующий контейнер
distrobox create --name dev2 --clone dev1
----

== Интеграция с хост-системой

Distrobox обеспечивает полную интеграцию с хостом:

* **Домашняя директория**: Полный доступ к ~/ пользователя
* **Графические приложения**: Поддержка X11/Wayland
* **Аудио**: PulseAudio интеграция
* **USB устройства**: Доступ к внешним устройствам
* **Сеть**: Полный сетевой доступ

== Производительность

* **Быстрый вход**: Оптимизированный для минимальной задержки
* **Совместное использование**: Переиспользование хост-ресурсов
* **Кеширование**: Docker layers для быстрого запуска

== Безопасность

* **Изоляция**: Контейнеры изолированы от хоста
* **Привилегии**: Нет автоматического root доступа
* **Сеть**: Полный сетевой доступ (требует внимания)

== Советы по использованию

=== Настройка init hooks

[source,bash]
----
# Создать персональный init hook
mkdir -p ~/.config/distrobox/init-hooks
cat > ~/.config/distrobox/init-hooks/my-setup.sh << 'EOF'
#!/bin/bash
# Персональная настройка контейнера

# Установить любимые инструменты
apt update && apt install -y htop neofetch tmux

# Настроить shell
echo 'export EDITOR=vim' >> ~/.bashrc
EOF

chmod +x ~/.config/distrobox/init-hooks/my-setup.sh
----

=== Экспорт приложений

[source,bash]
----
# Экспортировать приложение в меню хоста
distrobox-export --app firefox

# Экспортировать бинарный файл
distrobox-export --bin /usr/bin/vim --export-path ~/.local/bin

# Экспортировать сервис
distrobox-export --service ssh
----

=== Управление ресурсами

[source,bash]
----
# Ограничить ресурсы контейнера
distrobox create --name limited --memory 2GB --cpus 2

# Проверить использование ресурсов
distrobox enter limited -- podman stats
----

== Устранение неисправностей

=== Проблемы с доступом к дисплею

[source,bash]
----
# Проверить переменные окружения
distrobox enter container -- env | grep DISPLAY

# Вручную установить DISPLAY
distrobox enter container -- export DISPLAY=:0
----

=== Проблемы с Docker

[source,bash]
----
# Проверить статус Docker
systemctl status docker

# Перезапустить Docker
sudo systemctl restart docker

# Проверить права пользователя
groups $USER | grep docker
----

=== Очистка

[source,bash]
----
# Остановить все контейнеры
distrobox stop --all

# Удалить контейнер
distrobox rm container-name

# Очистить неиспользуемые образы
docker image prune -f
----

== Ссылки

* https://distrobox.it/[Официальная документация Distrobox]
* https://docs.docker.com/[Документация Docker]
* https://github.com/89luca89/distrobox[Исходный код на GitHub]
