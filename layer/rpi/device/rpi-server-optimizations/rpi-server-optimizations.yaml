# METABEGIN
# X-Env-Layer-Name: rpi-server-optimizations
# X-Env-Layer-Category: device
# X-Env-Layer-Desc: Raspberry Pi server optimizations.txt for server usage - disables HDMI, optimizes PCIe/USB, reduces power consumption
# X-Env-Layer-Version: 2.0.0
# X-Env-Layer-Requires: rpi-boot-firmware
#
# X-Env-VarPrefix: rpi_server
#
# X-Env-Var-disable_hdmi: y
# X-Env-Var-disable_hdmi-Desc: Disable HDMI output for power savings in headless server operation
# X-Env-Var-disable_hdmi-Required: n
# X-Env-Var-disable_hdmi-Valid: bool
# X-Env-Var-disable_hdmi-Set: immediate
#
# X-Env-Var-disable_wifi: y
# X-Env-Var-disable_wifi-Desc: Disable WiFi interface for security and power savings
# X-Env-Var-disable_wifi-Required: n
# X-Env-Var-disable_wifi-Valid: bool
# X-Env-Var-disable_wifi-Set: immediate
#
# X-Env-Var-disable_bluetooth: y
# X-Env-Var-disable_bluetooth-Desc: Disable Bluetooth interface for security and power savings
# X-Env-Var-disable_bluetooth-Required: n
# X-Env-Var-disable_bluetooth-Valid: bool
# X-Env-Var-disable_bluetooth-Set: immediate
#
# X-Env-Var-disable_audio: y
# X-Env-Var-disable_audio-Desc: Disable audio interfaces for server operation
# X-Env-Var-disable_audio-Required: n
# X-Env-Var-disable_audio-Valid: bool
# X-Env-Var-disable_audio-Set: immediate
#
# X-Env-Var-pcie_max_speed: y
# X-Env-Var-pcie_max_speed-Desc: Enable PCIe Gen 3.0 for maximum NVMe SSD performance
# X-Env-Var-pcie_max_speed-Required: n
# X-Env-Var-pcie_max_speed-Valid: bool
# X-Env-Var-pcie_max_speed-Set: immediate
#
# X-Env-Var-usb_max_performance: y
# X-Env-Var-usb_max_performance-Desc: Enable USB 3.0 high-performance mode
# X-Env-Var-usb_max_performance-Required: n
# X-Env-Var-usb_max_performance-Valid: bool
# X-Env-Var-usb_max_performance-Set: immediate
#
# METAEND
---
mmdebstrap:
  customize-hooks:
    # Raspberry Pi 5 Server Configuration with idempotency and error handling
    - |
      set -euo pipefail
      CONFIG_FILE="$1/boot/firmware/config.txt"

      # Validate environment
      if [ ! -f "$CONFIG_FILE" ]; then
        echo "ERROR: config.txt not found at $CONFIG_FILE" >&2
        exit 1
      fi

      # Add server optimizations header if not present (idempotent)
      if ! grep -q "# Raspberry Pi 5 Server Optimized Configuration" "$CONFIG_FILE" 2>/dev/null; then
        echo "# Raspberry Pi 5 Server Optimized Configuration" >> "$CONFIG_FILE"
        echo "# Generated by rpi-server-optimizations layer v2.0.0" >> "$CONFIG_FILE"
        echo "# Timestamp: $(date)" >> "$CONFIG_FILE"
        echo "" >> "$CONFIG_FILE"
      fi

      # Helper function for safe config addition (idempotent)
      add_config_if_not_exists() {
        local param="$1"
        local comment="$2"

        if ! grep -q "^${param%%=*}" "$CONFIG_FILE" 2>/dev/null; then
          echo "$comment" >> "$CONFIG_FILE"
          echo "$param" >> "$CONFIG_FILE"
          echo "" >> "$CONFIG_FILE"
          echo "✅ Added: $param"
        else
          echo "⚪ Already configured: $param"
        fi
      }

      # Disable HDMI for power savings (idempotent)
      if [ "${IGconf_rpi_server_disable_hdmi:-y}" = "y" ]; then
        add_config_if_not_exists "hdmi_blanking=1" "# Disable HDMI for power savings in headless operation"
        add_config_if_not_exists "hdmi_ignore_hotplug=1" ""
        add_config_if_not_exists "hdmi_ignore_composite=1" ""
        add_config_if_not_exists "hdmi_ignore_cec=1" ""
      fi

      # Disable unused interfaces for server operation (idempotent)
      if ! grep -q "#dtparam=i2c_arm=off" "$CONFIG_FILE" 2>/dev/null; then
        echo "# Disable unused interfaces for server operation" >> "$CONFIG_FILE"
        echo "#dtparam=i2c_arm=off" >> "$CONFIG_FILE"
        echo "#dtparam=i2s=off" >> "$CONFIG_FILE"
        echo "#dtparam=spi=off" >> "$CONFIG_FILE"
        echo "" >> "$CONFIG_FILE"
        echo "✅ Added: unused interfaces disabled"
      fi

      # Disable WiFi interface (idempotent)
      if [ "${IGconf_rpi_server_disable_wifi:-y}" = "y" ]; then
        add_config_if_not_exists "dtoverlay=disable-wifi" "# Disable WiFi interface"
      fi

      # Disable Bluetooth interface (idempotent)
      if [ "${IGconf_rpi_server_disable_bluetooth:-y}" = "y" ]; then
        add_config_if_not_exists "dtoverlay=disable-bt" "# Disable Bluetooth interface"
      fi

      # Disable audio interfaces (idempotent)
      if [ "${IGconf_rpi_server_disable_audio:-y}" = "y" ]; then
        add_config_if_not_exists "dtparam=audio=off" "# Disable audio interfaces"
      fi

      # Server performance optimizations (idempotent)
      add_config_if_not_exists "arm_boost=1" "# Server performance optimizations"
      add_config_if_not_exists "gpu_mem=16" ""

      # Disable unnecessary services for memory savings (idempotent)
      add_config_if_not_exists "disable_camera_led=1" "# Disable unnecessary services for memory savings"
      add_config_if_not_exists "disable_splash=1" ""

      echo "✅ Raspberry Pi 5 server configuration completed (idempotent)"
