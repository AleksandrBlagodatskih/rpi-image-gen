= apparmor

Mandatory Access Control (MAC) с AppArmor для систем на базе Debian, оптимизированный для Raspberry Pi.

== Описание

Этот слой предоставляет полную интеграцию AppArmor - системы Mandatory Access Control (MAC) для Linux. AppArmor ограничивает возможности программ согласно набору правил, указывающих, какие файлы данная программа может использовать.

Особенности:
* Автоматическая настройка параметров ядра для AppArmor
* Поддержка initramfs с AppArmor для ранней защиты
* Гарантированное монтирование securityfs

* **Базовые профили безопасности**:
  - Профиль для системных служб с ограниченным доступом
  - Профиль для мониторинговых служб с доступом к системным метрикам
  - Профиль для контейнерных рантаймов с базовыми разрешениями
  - Профиль для пользовательских приложений с ограниченными правами

* **Интеграция**:
  - Совместимость с любыми Linux дистрибутивами
  - Автоматическая настройка для EFI и initramfs
  - Поддержка контейнеров разработки
  - Интеграция с системами мониторинга
  - Интеграция с auditd для аудита безопасности

== Использование

[source,yaml]
----
device:
  layer: rpi5  # или rpi4, rpi-cm4 и т.д.

image:
  layer: image-rpios
  name: secure-rpi-system

layer:
  base: bookworm-minbase
  security: apparmor  # Добавление AppArmor

# Настройки AppArmor
apparmor:
  enable: y           # Включить AppArmor (по умолчанию y)
  mode: enforce       # Режим: enforce (блокировать) или complain (только логировать)
  system_monitoring: y    # Системные оптимизации (по умолчанию y)
----

== Переменные конфигурации

|===
| Переменная | Описание | Значения | По умолчанию

| `enable`
| Включить AppArmor
| `y` / `n`
| `y`

| `mode`
| Режим работы AppArmor
| `enforce` (блокировать нарушения) / `complain` (только логировать)
| `enforce`


| `system_monitoring`
| Системные оптимизации мониторинга доступа
| `y` / `n`
| `y`


| `audit_integration`
| Интеграция с auditd для аудита безопасности
| `y` / `n`
| `n`
|===

== Что делает слой

=== Установка пакетов

* `apparmor` - основная система AppArmor
* `apparmor-utils` - утилиты для управления профилями
* `apparmor-profiles-extra` - дополнительные профили безопасности

=== Системная конфигурация

* Настройка initramfs для bootloader
* Добавление параметров ядра в cmdline.txt
* Настройка securityfs через fstab
* Установка режима работы (enforce/complain)

=== Системные оптимизации

Настройки включают:

* **Профиль для системных служб** (`/etc/apparmor.d/sbin.init`):
  - Ограниченный доступ к системным ресурсам
  - Контроль над критическими операциями

* **Профиль для мониторинга** (`/etc/apparmor.d/usr.sbin.monitoring`):
  - Доступ к системным метрикам
  - Контроль сетевой активности

* **Профиль для контейнеров** (`/etc/apparmor.d/usr.bin.containerd`):
  - Базовые разрешения для контейнерных рантаймов
  - Ограниченный доступ к системным ресурсам

== Совместимость

=== Поддерживаемые устройства

* Raspberry Pi 5
* Raspberry Pi 4
* Raspberry Pi Compute Module 4
* Raspberry Pi 3 (с ограниченной поддержкой GPU)
* Raspberry Pi Zero (без GPU оптимизаций)

=== Требования

* Debian Bookworm или Trixie
* Ядро Linux с поддержкой AppArmor (включено в Raspberry Pi OS)
* Минимум 256MB RAM для комфортной работы

=== Зависимости

* `debian-base` - любой слой на базе Debian
* Рекомендуется использовать с `sbom-base` для аудита

== Диагностика

=== Проверка статуса

[source,bash]
----
# После загрузки системы
sudo apparmor_status

# Просмотр загруженных профилей
sudo aa-status

# Просмотр нарушений (в complain режиме)
sudo cat /var/log/kern.log | grep apparmor
----

=== Управление профилями

[source,bash]
----
# Переключение в complain режим для отладки
sudo aa-complain /etc/apparmor.d/profile

# Переключение в enforce режим
sudo aa-enforce /etc/apparmor.d/profile

# Перезагрузка профилей
sudo systemctl reload apparmor
----

=== Устранение проблем

. **AppArmor не загружается**: Проверьте параметры ядра в `/boot/firmware/cmdline.txt` (должны содержать `apparmor=1 security=apparmor`)
. **Securityfs не смонтирован**: Проверьте `mount | grep securityfs` и `/etc/fstab`
. **Профили не применяются**: Проверьте синтаксис `sudo apparmor_parser -d /etc/apparmor.d/profile`
. **Нарушения в логах**: Используйте `aa-logprof` для генерации профилей на основе логов

== Примеры использования

=== Базовая настройка безопасности

[source,yaml]
----
layer:
  base: bookworm-minbase
  security: apparmor

apparmor:
  enable: y
  mode: enforce
  system_monitoring: y
----

=== Разработка с логированием

[source,yaml]
----
apparmor:
  enable: y
  mode: complain  # Только логировать, не блокировать
  system_monitoring: y
----

=== Минимальная установка

[source,yaml]
----
apparmor:
  enable: y
  mode: enforce
  system_monitoring: n   # Без системных оптимизаций
----

=== Полная настройка для production

[source,yaml]
----
device:
  layer: rpi5
  class: pi5

image:
  layer: image-rpios
  name: production-secure
  compression: zstd

layer:
  base: bookworm-minbase
  security: apparmor
  monitoring: system-monitoring
  container: docker-runtime

# Полная конфигурация AppArmor для production
apparmor:
  enable: y
  mode: enforce
  system_monitoring: y
  profiles_enable: y
  initramfs_integration: y
  logging_enable: y
  container_support: y
  monitoring_support: y

monitoring:
  prometheus: y
  grafana: y
  node_exporter: y

container:
  docker: y
  podman: y
----

=== Настройка для IoT устройства

[source,yaml]
----
device:
  layer: rpi-cm4
  class: cm4
  variant: iot

image:
  layer: image-base
  name: iot-secure-device
  compression: zstd

layer:
  base: bookworm-minbase
  security: apparmor
  monitoring: system-monitoring

# Общая безопасность
apparmor:
  enable: y
  mode: enforce
  profiles_enable: y
  initramfs_integration: y
  logging_enable: y
  monitoring_support: y

monitoring:
  prometheus: y
  grafana: y
  node_exporter: y
----

== Безопасность и лучшие практики

* **Начинайте с complain режима** для тестирования приложений
* **Регулярно проверяйте логи** на нарушения AppArmor
* **Используйте aa-logprof** для создания профилей на основе реального использования
* **Тестируйте профили** перед переводом в enforce режим
* **Мониторьте производительность** - AppArmor добавляет небольшую нагрузку

== Ссылки

* https://wiki.debian.org/AppArmor[Debian AppArmor Wiki]
* https://apparmor.net/[Официальный сайт AppArmor]
* https://ubuntu.com/server/docs/security-apparmor[Ubuntu документация по AppArmor]
