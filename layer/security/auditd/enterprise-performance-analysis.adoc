= Анализ Производительности Auditd в Enterprise Окружении

== Обзор Производительности

Auditd представляет собой высокопроизводительную систему аудита, но неправильная конфигурация может значительно влиять на производительность системы. В enterprise окружениях критически важно балансировать между полнотой аудита и системной производительностью.

== Метрики Производительности

=== Ключевые Метрики

[cols="1,2,3",options="header"]
|===
| Метрика | Описание | Рекомендуемое Значение

| backlog
| Количество событий в очереди ожидания
| < 100

| lost
| Количество потерянных событий аудита
| 0

| events_per_second
| Скорость обработки событий аудита
| Зависит от нагрузки системы

| memory_usage
| Использование памяти auditd процессом
| < 50MB для типичных систем

| cpu_usage
| Загрузка процессора auditd
| < 5% в нормальных условиях

| log_file_size
| Размер файлов аудита
| < 1GB перед ротацией

| disk_io
| Ввод/вывод на диск для аудита
| Минимизировать для критичных систем
|===

== Факторы Влияния на Производительность

=== Конфигурационные Параметры

==== Режим Сброса (flush)

[source,bash]
----
# Различные режимы сброса и их влияние
# incremental_async - асинхронный, минимальное влияние
# incremental - синхронный инкрементальный
# data - синхронный по данным
# sync - полностью синхронный, максимальное влияние

# Рекомендация: incremental_async для production
flush = incremental_async
----

==== Частота Аудита (freq)

[source,bash]
----
# Частота записи событий в лог
# 50 - баланс между производительностью и детализацией
# 20 - высокая детализация, больше нагрузки
# 100 - низкая детализация, меньше нагрузки

# Рекомендация: 50-100 для enterprise систем
freq = 50
----

==== Размер Буфера (backlog_limit)

[source,bash]
----
# Размер внутреннего буфера событий
# По умолчанию 8192 события
# Увеличение снижает потерю событий при пиковых нагрузках

# Проверка текущего размера
sudo auditctl -s | grep backlog

# Увеличение при необходимости
sudo auditctl -b 16384
----

=== Системные Факторы

==== Аппаратные Ресурсы

[source,bash]
----
# Мониторинг использования ресурсов auditd
ps aux | grep auditd

# Проверка памяти
cat /proc/$(pgrep auditd)/status | grep -E "(VmRSS|VmSize)"

# Мониторинг CPU
top -p $(pgrep auditd) -b -n 1

# Мониторинг дискового ввода-вывода
iostat -x 1 | grep -A 5 "$(df /var/log/audit | tail -1 | awk '{print $1}' | sed 's|/dev/||')"
----

==== Загрузка Системы

[source,bash]
----
# Анализ общей нагрузки системы
uptime
vmstat 1 5

# Мониторинг процессов
ps aux --sort=-%cpu | head -10
ps aux --sort=-%mem | head -10

# Мониторинг дискового пространства
df -h /var/log/audit
du -sh /var/log/audit/*
----

== Бенчмаркинг и Тестирование

=== Тестирование Производительности

==== Синтетический Тест

[source,bash]
----
#!/bin/bash
# audit_performance_test.sh

echo "=== AUDITD PERFORMANCE TEST ==="
echo "Начало теста: $(date)"

# Очистка предыдущих логов
sudo truncate -s 0 /var/log/audit/audit.log

# Запуск интенсивной активности
for i in {1..1000}; do
    echo "test $i" > /tmp/test_file_$i
    rm /tmp/test_file_$i
    sudo useradd testuser$i 2>/dev/null || true
    sudo userdel testuser$i 2>/dev/null || true
done

# Ожидание обработки событий
sleep 10

# Анализ результатов
echo "=== РЕЗУЛЬТАТЫ ТЕСТА ==="
sudo auditctl -s
echo "Размер лога: $(du -sh /var/log/audit/audit.log | cut -f1)"
echo "Количество событий: $(sudo aureport | grep "Number of" | tail -1)"

# Очистка
rm -f /tmp/test_file_*
----

==== Анализ Реальной Нагрузки

[source,bash]
----
# Мониторинг производительности в реальном времени
#!/bin/bash
while true; do
    echo "$(date) - Backlog: $(sudo auditctl -s | grep backlog | cut -d'=' -f2) - Events/sec: $(sudo aureport -s | grep "events per second" | tail -1 | awk '{print $NF}')"
    sleep 5
done
----

=== Бенчмарки Enterprise Систем

==== Малый Бизнес Сервер

[source,text]
----
Характеристики:
- CPU: 4 ядра
- RAM: 8GB
- Storage: SSD 256GB
- Нагрузка: 50-100 событий/сек

Рекомендуемая конфигурация:
- flush: incremental_async
- freq: 50
- backlog_limit: 8192
- max_log_file: 8

Производительность:
- CPU: < 2%
- Memory: < 30MB
- Backlog: < 50
- Lost events: 0
----

==== Средний Бизнес Сервер

[source,text]
----
Характеристики:
- CPU: 8 ядер
- RAM: 16GB
- Storage: SSD 512GB
- Нагрузка: 200-500 событий/сек

Рекомендуемая конфигурация:
- flush: incremental_async
- freq: 50
- backlog_limit: 16384
- max_log_file: 10

Производительность:
- CPU: < 5%
- Memory: < 50MB
- Backlog: < 100
- Lost events: 0
----

==== Enterprise Сервер

[source,text]
----
Характеристики:
- CPU: 16+ ядер
- RAM: 32GB+
- Storage: NVMe SSD 1TB+
- Нагрузка: 1000+ событий/сек

Рекомендуемая конфигурация:
- flush: incremental_async
- freq: 100
- backlog_limit: 32768
- max_log_file: 15

Производительность:
- CPU: < 8%
- Memory: < 100MB
- Backlog: < 200
- Lost events: 0
----

== Оптимизация Производительности

=== Минимизация Количества Правил

==== Анализ Текущих Правил

[source,bash]
----
# Анализ количества активных правил
sudo auditctl -l | wc -l

# Анализ по типам правил
sudo auditctl -l | grep "^-w" | wc -l  # Файловые правила
sudo auditctl -l | grep "^-a" | wc -l  # Системные вызовы

# Поиск наиболее активных правил
sudo aureport -r | head -10
----

==== Оптимизация Фильтров

[source,bash]
----
# Использование фильтров для снижения нагрузки
# Вместо мониторинга всех execve только успешные
-a exit,always -F arch=b64 -S execve -F success=1 -k exec_success

# Фильтр по UID для исключения системных процессов
-a exit,always -F arch=b64 -S execve -F uid>=1000 -k user_exec

# Фильтр по путям для исключения шумных директорий
-a exit,always -F arch=b64 -S execve -F path!=/usr/bin -F path!=/bin -k system_exec
----

=== Оптимизация Хранения

==== Размещение Логов

[source,bash]
----
# Рекомендуемые точки монтирования для логов аудита
# SSD для максимальной производительности
# Отдельный раздел для изоляции
# RAID для критичных систем

# Проверка производительности диска
sudo hdparm -tT /dev/sda  # SSD
sudo hdparm -tT /dev/md0  # RAID

# Мониторинг I/O характеристик
iostat -x 1 | grep "$(df /var/log/audit | tail -1 | awk '{print $1}' | sed 's|/dev/||')"
----

==== Компрессия Логов

[source,bash]
----
# Автоматическая компрессия старых логов
# В auditd.conf
compress_logs = yes

# Ручная компрессия
gzip /var/log/audit/audit.log.1

# Мониторинг размера сжатых логов
du -sh /var/log/audit/audit.log*
----

=== Масштабирование для Высокой Нагрузки

==== Горизонтальное Масштабирование

[source,mermaid]
----
graph TB
    A1[App Server 1] --> C[Load Balancer]
    A2[App Server 2] --> C
    A3[App Server 3] --> C

    C --> S1[SIEM Node 1]
    C --> S2[SIEM Node 2]
    C --> S3[SIEM Node 3]

    S1 --> DB[(Shared Audit DB)]
    S2 --> DB
    S3 --> DB
----

==== Вертикальное Масштабирование

[source,bash]
----
# Увеличение ресурсов auditd процесса
# В /etc/systemd/system/auditd.service.d/override.conf

[Service]
MemoryLimit=256M
CPUSchedulingPriority=10
IOSchedulingClass=realtime
IOSchedulingPriority=7
----

=== Мониторинг в Реальном Времени

==== Prometheus Метрики

[source,yaml]
----
# prometheus.yml для аудита
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'auditd'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'auditd-detailed'
    static_configs:
      - targets: ['localhost:9091']
    scrape_interval: 30s
----

==== Grafana Дашборд

[source,json]
----
{
  "dashboard": {
    "title": "Auditd Enterprise Performance",
    "panels": [
      {
        "title": "Audit Events Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(audit_events_total[5m])",
            "legendFormat": "{{instance}}"
          }
        ]
      },
      {
        "title": "Audit Backlog",
        "type": "singlestat",
        "targets": [
          {
            "expr": "audit_backlog_current",
            "thresholds": "100,500,1000"
          }
        ]
      },
      {
        "title": "Auditd Memory Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "auditd_memory_bytes",
            "legendFormat": "Memory Used"
          }
        ]
      },
      {
        "title": "Lost Events",
        "type": "stat",
        "targets": [
          {
            "expr": "audit_lost_events_total",
            "valueName": "current"
          }
        ]
      }
    ]
  }
}
----

== Troubleshooting Производительности

=== Диагностика Проблем

==== Высокий Backlog

[source,bash]
----
# Проверка причины высокого backlog
sudo auditctl -s

# Анализ наиболее активных правил
sudo aureport -r | sort -nr -k3 | head -10

# Поиск узких мест в системе
vmstat 1 5
iostat -x 1 5

# Проверка размера буфера
sudo auditctl -b  # Текущий размер
sudo auditctl -b 32768  # Увеличение
----

==== Высокое Потребление CPU

[source,bash]
----
# Анализ потребления CPU auditd
top -p $(pgrep auditd)

# Поиск ресурсоемких правил
sudo aureport -s | sort -nr -k4 | head -10

# Оптимизация правил
sudo auditctl -a exit,never -F arch=b64 -S getpid  # Исключение шумных системных вызовов
----

==== Проблемы с Дисковым Пространством

[source,bash]
----
# Мониторинг использования диска
df -h /var/log/audit

# Анализ размера логов
du -sh /var/log/audit/*

# Настройка более агрессивной ротации
sudo sed -i 's/num_logs = 5/num_logs = 3/' /etc/audit/auditd.conf
sudo sed -i 's/max_log_file = 8/max_log_file = 5/' /etc/audit/auditd.conf
----

=== Автоматическая Оптимизация

==== Адаптивная Конфигурация

[source,bash]
----
#!/bin/bash
# adaptive_audit_config.sh

# Мониторинг нагрузки системы
CPU_LOAD=$(uptime | awk -F'load average:' '{print $2}' | cut -d, -f1 | tr -d ' ')
MEMORY_USAGE=$(free | awk 'NR==2{printf "%.2f", $3*100/$2 }')

# Адаптация конфигурации на основе нагрузки
if (( $(echo "$CPU_LOAD > 2.0" | bc -l) )); then
    echo "Высокая нагрузка CPU, уменьшаю частоту аудита"
    sudo auditctl -e 0  # Временное отключение
    # ... постепенное включение критичных правил
fi

if (( $(echo "$MEMORY_USAGE > 80" | bc -l) )); then
    echo "Высокое использование памяти, оптимизирую правила"
    sudo auditctl -D
    # ... загрузка только критичных правил
fi
----

==== Автоматическое Масштабирование

[source,bash]
----
#!/bin/bash
# auto_scale_audit.sh

# Мониторинг backlog и автоматическая корректировка
BACKLOG=$(sudo auditctl -s | grep backlog | cut -d'=' -f2)

if [ "$BACKLOG" -gt 1000 ]; then
    echo "Высокий backlog, увеличиваю буфер"
    sudo auditctl -b $((BACKLOG * 2))
elif [ "$BACKLOG" -lt 50 ] && [ $(sudo auditctl -b) -gt 8192 ]; then
    echo "Низкий backlog, уменьшаю буфер"
    sudo auditctl -b 8192
fi
----

== Enterprise Мониторинг

=== Централизованный Мониторинг

==== Агрегация Метрик

[source,telegraf]
----
# Telegraf конфигурация для аудита
[[inputs.auditd]]
  ## Путь к файлу аудита
  audit_log_path = "/var/log/audit/audit.log"

  ## Интервал сбора метрик
  interval = "10s"

  ## Метрики для сбора
  metrics_include = ["backlog", "lost", "events_per_second", "log_file_size"]
----

==== Централизованные Алерты

[source,prometheus]
----
# Prometheus правила алертинга для аудита
groups:
  - name: auditd
    rules:
      - alert: HighAuditBacklog
        expr: audit_backlog_current > 500
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High audit backlog on {{ $labels.instance }}"
          description: "Audit backlog is {{ $value }} on {{ $labels.instance }}"

      - alert: AuditdDown
        expr: up{job="auditd"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Auditd is down on {{ $labels.instance }}"
          description: "Audit daemon is not running on {{ $labels.instance }}"
----

=== Отчетность Производительности

==== Еженедельные Отчеты

[source,bash]
----
#!/bin/bash
# weekly_audit_performance_report.sh

REPORT_DATE=$(date +%Y-%m-%d)
REPORT_FILE="/var/reports/audit-performance-$REPORT_DATE.txt"

cat > "$REPORT_FILE" << EOF
ОТЧЕТ ПРОИЗВОДИТЕЛЬНОСТИ АУДИТА
===============================
Дата: $(date)
Период: Последние 7 дней

СТАТИСТИКА ПРОИЗВОДИТЕЛЬНОСТИ:
$(sudo aureport -s | tail -10)

РАЗМЕР ЛОГОВ:
$(du -sh /var/log/audit/*)

BACKLOG СТАТИСТИКА:
Максимальный: $(sudo auditctl -s | grep backlog | cut -d'=' -f2)
Средний: $(sudo grep backlog /var/log/audit/audit.log | awk '{sum+=$3} END {print sum/NR}')

ПОТЕРЯННЫЕ СОБЫТИЯ:
$(sudo auditctl -s | grep lost)

РЕКОМЕНДАЦИИ:
$([ $(sudo auditctl -s | grep backlog | cut -d'=' -f2) -gt 100 ] && echo "- Рассмотреть увеличение backlog_limit")
$([ $(du -sh /var/log/audit/audit.log | cut -d$'\t' -f1) \> "500M" ] && echo "- Увеличить частоту ротации логов")
$([ $(sudo auditctl -s | grep lost | cut -d'=' -f2) -gt 0 ] && echo "- Критично: обнаружены потерянные события аудита")

EOF

echo "Отчет сохранен: $REPORT_FILE"
----

==== Мониторинг Трендов

[source,bash]
----
#!/bin/bash
# audit_performance_trends.sh

# Сбор исторических данных
mkdir -p /var/audit-metrics

# Ежедневные метрики
echo "$(date +%Y-%m-%d),$(sudo auditctl -s | grep -E 'backlog|lost' | cut -d'=' -f2 | tr '\n' ',' | sed 's/,$//')" >> /var/audit-metrics/daily.csv

# Еженедельный анализ трендов
tail -7 /var/audit-metrics/daily.csv | awk -F',' '
BEGIN {print "Тренд Backlog (7 дней):"}
{sum+=$2; max=$2>max?$2:max} END {
    avg=sum/7;
    print "Средний: " avg;
    print "Максимальный: " max;
    print "Статус: " (max>100?"ТРЕБУЕТ ВНИМАНИЯ":"НОРМАЛЬНЫЙ")
}'
----

== Лучшие Практики Enterprise

=== Производительность

1. **Регулярный мониторинг** backlog и lost событий
2. **Адаптивная настройка** в зависимости от нагрузки системы
3. **Оптимизированные правила** с использованием фильтров
4. **Правильное размещение** логов на быстрых дисках

=== Масштабируемость

1. **Горизонтальное масштабирование** агентов аудита
2. **Централизованная агрегация** для множества узлов
3. **Автоматическое балансирование** нагрузки аудита
4. **Эффективное партиционирование** данных аудита

=== Надежность

1. **Резервное копирование** конфигурации аудита
2. **Автоматическое восстановление** после сбоев
3. **Мониторинг целостности** логов аудита
4. **Регулярное тестирование** производительности

=== Безопасность

1. **Шифрование логов** аудита в enterprise окружениях
2. **Контроль доступа** к агрегированным данным аудита
3. **Целостность цепочки** аудита от источника до хранилища
4. **Регулярный аудит** конфигурации безопасности аудита

== Сценарии Оптимизации

=== Минимизация Влияния на Критичные Системы

[source,bash]
----
# Минимальный набор правил для критичных систем
sudo auditctl -D  # Очистка всех правил

# Только критичные события
sudo auditctl -w /etc/passwd -p wa -k critical_files
sudo auditctl -w /etc/shadow -p wa -k critical_files
sudo auditctl -w /var/log/auth.log -p wa -k authentication

# Сниженная частота для минимальной нагрузки
sudo sed -i 's/freq = 50/freq = 100/' /etc/audit/auditd.conf
----

=== Максимальная Детализация для Аудита Безопасности

[source,bash]
----
# Полный аудит для систем безопасности
sudo auditctl -D

# Загрузка всех стандартных правил
sudo auditctl -R /usr/share/doc/auditd/examples/audit.rules

# Дополнительные кастомные правила
sudo auditctl -w /etc/security/ -p wa -k security_config
sudo auditctl -w /etc/apparmor/ -p wa -k apparmor_config
sudo auditctl -w /etc/selinux/ -p wa -k selinux_config

# Увеличенная частота для детального мониторинга
sudo sed -i 's/freq = 50/freq = 20/' /etc/audit/auditd.conf
----

=== Баланс Между Безопасностью и Производительностью

[source,bash]
----
# Рекомендуемая конфигурация для большинства enterprise систем

# Стандартные правила аудита
sudo auditctl -R /usr/share/doc/auditd/examples/audit.rules

# Кастомные правила для бизнес-логики
sudo auditctl -w /opt/business-apps/ -p rwa -k business_data
sudo auditctl -w /var/business-logs/ -p wa -k business_logs

# Оптимизированная конфигурация
sudo sed -i 's/freq = 50/freq = 50/' /etc/audit/auditd.conf
sudo sed -i 's/flush = incremental_async/flush = incremental_async/' /etc/audit/auditd.conf
sudo auditctl -b 16384  # Увеличенный буфер
----

== Заключение

Производительность auditd в enterprise окружениях требует тщательного баланса между:

- **Полнотой аудита** для обеспечения безопасности и compliance
- **Минимальным влиянием** на производительность критичных систем
- **Масштабируемостью** для поддержки множества узлов
- **Надежностью** для предотвращения потери критичных событий

Регулярный мониторинг, тестирование и оптимизация обеспечивают эффективную работу аудита без негативного влияния на бизнес-процессы.

Рекомендуется начинать с базовой конфигурации и постепенно настраивать правила в соответствии с конкретными требованиями безопасности и производительности вашей организации.
