# METABEGIN
# X-Env-Layer-Name: auditd-rules
# X-Env-Layer-Category: extension
# X-Env-Layer-Desc: Auditd security monitoring rules
# X-Env-Layer-Version: 2.0.0
# X-Env-Layer-Requires: auditd-core
# X-Env-Layer-Provides: auditd-rules
# X-Env-VarPrefix: auditd_rules
# X-Env-Var-enable: y
# X-Env-Var-enable-Desc: Enable auditd security monitoring rules
# X-Env-Var-enable-Required: false
# X-Env-Var-enable-Valid: bool
# METAEND
---
mmdebstrap:
  customize-hooks:
    - |
      # Embedded common functions for self-contained layer

      validate_component_enabled() {
        local component="$1"
        local enable_var="IGconf_${component}_enable"
        if [ "${!enable_var:-n}" != "y" ]; then
          echo "‚ÑπÔ∏è  $component disabled (set $enable_var=y to enable)"
          exit 0
        fi
      }

      # Validate component enablement
      validate_component_enabled "auditd_rules"

      echo "üìã Installing auditd security monitoring rules..."

      # Install comprehensive audit rules
      install -m 644 "templates/security/auditd/security-monitoring.rules" "$1/etc/audit/rules.d/security-monitoring.rules"

      # Validate and load rules
      if [ -f "$1/sbin/auditctl" ]; then
        echo "üîç Validating audit rules syntax..."
        if chroot "$1" auditctl -R /etc/audit/rules.d/security-monitoring.rules >/dev/null 2>&1; then
          echo "‚úÖ Audit rules loaded successfully"
        else
          echo "‚ö†Ô∏è Warning: Could not load audit rules (may be normal during build)"
        fi
      fi

      echo "‚úÖ Auditd security monitoring rules installed (35 comprehensive rules)"
