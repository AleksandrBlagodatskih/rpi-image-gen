# METABEGIN
# X-Env-Layer-Name: fail2ban-mail
# X-Env-Layer-Category: extension
# X-Env-Layer-Desc: Mail server protection with Fail2Ban
# X-Env-Layer-Version: 2.0.0
# X-Env-Layer-Requires: fail2ban-core
# X-Env-Layer-Provides: fail2ban-mail
# X-Env-VarPrefix: fail2ban_mail
# X-Env-Var-enable: y
# X-Env-Var-enable-Desc: Enable mail service jails protection
# X-Env-Var-enable-Required: false
# X-Env-Var-enable-Valid: bool
# X-Env-Var-maxretry: 3
# X-Env-Var-maxretry-Desc: Maximum retry attempts for mail violations
# X-Env-Var-maxretry-Required: false
# X-Env-Var-maxretry-Valid: int:2-10
# X-Env-Var-maxretry-Set: lazy
# X-Env-Var-bantime: 3600
# X-Env-Var-bantime-Desc: Ban time in seconds for mail violations
# X-Env-Var-bantime-Required: false
# X-Env-Var-bantime-Valid: int:300-86400
# X-Env-Var-bantime-Set: lazy
# METAEND
---
mmdebstrap:
  customize-hooks:
    - |
      # Embedded common functions for self-contained layer

      # Validate component enablement
      validate_component_enabled "fail2ban_mail"

      echo "ðŸ“§ Configuring mail server protection with Fail2Ban..."

      MAXRETRY=${IGconf_fail2ban_mail_maxretry:-3}
      BANTIME=${IGconf_fail2ban_mail_bantime:-3600}

      # Configure mail jails
      cat >> "$1/etc/fail2ban/jail.local" << EOF

[postfix]
enabled = true
port = smtp,ssmtp,submission
filter = postfix
logpath = /var/log/mail.log
maxretry = $MAXRETRY
bantime = $BANTIME

[dovecot]
enabled = true
port = pop3,pop3s,imap,imaps,submission,465,smtp
filter = dovecot
logpath = /var/log/mail.log
maxretry = $MAXRETRY
bantime = $BANTIME

[sasl]
enabled = true
port = smtp,ssmtp,submission,imap2,imap3,imaps,pop3,pop3s
filter = postfix-sasl
logpath = /var/log/mail.log
maxretry = $MAXRETRY
bantime = $BANTIME
EOF

      # Reload fail2ban configuration
      chroot "$1" fail2ban-client reload >/dev/null 2>&1 || true

      echo "âœ… Mail server protection configured (maxretry: $MAXRETRY, bantime: ${BANTIME}s)"
