# METABEGIN
# X-Env-Layer-Name: fail2ban-ssh
# X-Env-Layer-Category: extension
# X-Env-Layer-Desc: SSH protection with Fail2Ban
# X-Env-Layer-Version: 2.0.0
# X-Env-Layer-Requires: fail2ban-core, openssh-server
# X-Env-Layer-Provides: fail2ban-ssh
# X-Env-VarPrefix: fail2ban_ssh
# X-Env-Var-enable: y
# X-Env-Var-enable-Desc: Enable SSH jail protection
# X-Env-Var-enable-Required: false
# X-Env-Var-enable-Valid: bool
# X-Env-Var-maxretry: 3
# X-Env-Var-maxretry-Desc: Maximum retry attempts for SSH before ban
# X-Env-Var-maxretry-Required: false
# X-Env-Var-maxretry-Valid: int:2-10
# X-Env-Var-maxretry-Set: lazy
# X-Env-Var-bantime: 3600
# X-Env-Var-bantime-Desc: Ban time in seconds for SSH violations
# X-Env-Var-bantime-Required: false
# X-Env-Var-bantime-Valid: int:300-86400
# X-Env-Var-bantime-Set: lazy
# METAEND
---
mmdebstrap:
  customize-hooks:
    - |
      # Embedded common functions for self-contained layer

      # Validate component enablement
      validate_component_enabled "fail2ban_ssh"

      echo "ðŸ”‘ Configuring SSH protection with Fail2Ban..."

      # Apply SSH jail configuration
      MAXRETRY=${IGconf_fail2ban_ssh_maxretry:-3}
      BANTIME=${IGconf_fail2ban_ssh_bantime:-3600}

      # Add SSH jail to jail.local
      cat >> "$1/etc/fail2ban/jail.local" << EOF

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = $MAXRETRY
bantime = $BANTIME
EOF

      # Reload fail2ban configuration
      chroot "$1" fail2ban-client reload >/dev/null 2>&1 || true

      echo "âœ… SSH protection configured (maxretry: $MAXRETRY, bantime: ${BANTIME}s)"
