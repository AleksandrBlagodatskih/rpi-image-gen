# METABEGIN
# X-Env-Layer-Name: fail2ban-web
# X-Env-Layer-Category: extension
# X-Env-Layer-Desc: Web server protection with Fail2Ban
# X-Env-Layer-Version: 2.0.0
# X-Env-Layer-Requires: fail2ban-core
# X-Env-Layer-Provides: fail2ban-web
# X-Env-VarPrefix: fail2ban_web
# X-Env-Var-enable: y
# X-Env-Var-enable-Desc: Enable web server jails protection
# X-Env-Var-enable-Required: false
# X-Env-Var-enable-Valid: bool
# X-Env-Var-apache_enable: n
# X-Env-Var-apache_enable-Desc: Enable Apache jails protection
# X-Env-Var-apache_enable-Required: false
# X-Env-Var-apache_enable-Valid: bool
# X-Env-Var-apache_enable-Set: lazy
# X-Env-Var-nginx_enable: n
# X-Env-Var-nginx_enable-Desc: Enable Nginx jails protection
# X-Env-Var-nginx_enable-Required: false
# X-Env-Var-nginx_enable-Valid: bool
# X-Env-Var-nginx_enable-Set: lazy
# X-Env-Var-maxretry: 6
# X-Env-Var-maxretry-Desc: Maximum retry attempts for web violations
# X-Env-Var-maxretry-Required: false
# X-Env-Var-maxretry-Valid: int:2-20
# X-Env-Var-maxretry-Set: lazy
# X-Env-Var-bantime: 3600
# X-Env-Var-bantime-Desc: Ban time in seconds for web violations
# X-Env-Var-bantime-Required: false
# X-Env-Var-bantime-Valid: int:300-86400
# X-Env-Var-bantime-Set: lazy
# METAEND
---
mmdebstrap:
  customize-hooks:
    - |
      # Embedded common functions for self-contained layer

      # Validate component enablement
      validate_component_enabled "fail2ban_web"

      echo "🌐 Configuring web server protection with Fail2Ban..."

      MAXRETRY=${IGconf_fail2ban_web_maxretry:-6}
      BANTIME=${IGconf_fail2ban_web_bantime:-3600}

      # Configure Apache jails if enabled
      if igconf isy IGconf_fail2ban_web_apache_enable; then
        cat >> "$1/etc/fail2ban/jail.local" << EOF

[apache-auth]
enabled = true
port = http,https
filter = apache-auth
logpath = /var/log/apache2/*error.log
maxretry = $MAXRETRY
bantime = $BANTIME

[apache-noscript]
enabled = true
port = http,https
filter = apache-noscript
logpath = /var/log/apache2/*error.log
maxretry = $MAXRETRY
bantime = $BANTIME
EOF
        echo "✅ Apache protection configured"
      fi

      # Configure Nginx jails if enabled
      if igconf isy IGconf_fail2ban_web_nginx_enable; then
        cat >> "$1/etc/fail2ban/jail.local" << EOF

[nginx-http-auth]
enabled = true
port = http,https
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = $MAXRETRY
bantime = $BANTIME

[nginx-noscript]
enabled = true
port = http,https
filter = nginx-noscript
logpath = /var/log/nginx/error.log
maxretry = $MAXRETRY
bantime = $BANTIME
EOF
        echo "✅ Nginx protection configured"
      fi

      # Reload fail2ban configuration
      chroot "$1" fail2ban-client reload >/dev/null 2>&1 || true

      echo "✅ Web server protection configured (maxretry: $MAXRETRY, bantime: ${BANTIME}s)"
