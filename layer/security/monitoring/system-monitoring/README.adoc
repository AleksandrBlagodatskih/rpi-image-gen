= System Access Monitoring Layer

== Описание

Единый слой мониторинга доступа к системе, объединяющий AppArmor, auditd и Fail2Ban для комплексного мониторинга безопасности. Предоставляет enterprise-grade мониторинг аутентификации, доступа к файлам, эскалации привилегий и сетевой активности.

== Основные возможности

* **Комплексный мониторинг**: Интеграция трех систем безопасности в единое решение
* **Мониторинг аутентификации**: Отслеживание всех попыток входа и аутентификации
* **Мониторинг доступа к файлам**: Контроль доступа к критическим системным файлам
* **Мониторинг эскалации привилегий**: Обнаружение попыток получения повышенных прав
* **Мониторинг сетевой активности**: Отслеживание подозрительных сетевых подключений
* **Алертинг и отчетность**: Автоматическое оповещение о подозрительной активности
* **Compliance готовность**: Соответствие стандартам CIS, PCI-DSS, HIPAA, GDPR

== Конфигурация

=== Базовая настройка

[source,yaml]
----
layer:
  base: bookworm-minbase
  security: system-monitoring

system_monitoring:
  enable: y
  apparmor_enable: y
  auditd_enable: y
  fail2ban_enable: y
----

=== Расширенная конфигурация

[source,yaml]
----
system_monitoring:
  enable: y

  # Компоненты безопасности
  apparmor_enable: y
  auditd_enable: y
  fail2ban_enable: y

  # Области мониторинга
  authentication_monitoring: y
  file_access_monitoring: y
  privilege_monitoring: y
  network_monitoring: y
  compliance_monitoring: n

  # Алертинг
  alerting_enabled: y
  log_retention_days: 90
----

== Что делает слой

=== Установка компонентов

* **AppArmor**: Mandatory Access Control с профилями мониторинга
* **auditd**: Системное логирование для аудита безопасности
* **Fail2Ban**: Предотвращение вторжений через анализ логов
* **Интеграционные скрипты**: Единые инструменты мониторинга и отчетности

=== Конфигурация мониторинга

* **Правила аудита**: 18+ базовых правил мониторинга системных событий
* **AppArmor профили**: Специализированные профили для мониторинга системных команд
* **Fail2Ban jail**: Кастомные jail для мониторинга аутентификации и доступа к файлам
* **Интеграция**: Единая конфигурация и скрипты для всех компонентов

=== Автоматизация

* **Ежедневные отчеты**: Автоматическая генерация отчетов безопасности
* **Мониторинг статуса**: Регулярная проверка работоспособности всех компонентов
* **Алертинг**: Оповещения о подозрительной активности
* **Ротация логов**: Автоматическое управление хранением логов

== Использование

=== Проверка статуса

[source,bash]
----
# Проверка статуса всех компонентов мониторинга
sudo system-monitoring-status

# Просмотр недавних событий безопасности
sudo ausearch -ts recent -k authentication

# Проверка заблокированных IP
sudo fail2ban-client status

# Статус AppArmor профилей
sudo aa-status
----

=== Генерация отчетов

[source,bash]
----
# Ежедневный отчет мониторинга
sudo generate-security-report

# Просмотр сгенерированных отчетов
ls -la /var/reports/security-monitoring-*.txt

# Детальный анализ событий
sudo ausearch -k critical_file_access -ts today
sudo ausearch -k privilege_changes -ts today
----

=== Мониторинг в реальном времени

[source,bash]
----
# Мониторинг событий аутентификации
sudo tail -f /var/log/auth.log | grep -E "(Failed|Accepted)"

# Мониторинг sudo активности
sudo tail -f /var/log/sudo.log

# Мониторинг системных команд
sudo tail -f /var/log/audit/audit.log | grep -E "(systemctl|service|useradd)"
----

== Интеграция с Enterprise системами

=== SIEM интеграция

Слой готов к интеграции с:

* **ELK Stack**: Elasticsearch, Logstash, Kibana
* **Splunk**: Enterprise SIEM решение
* **Graylog**: Open source SIEM
* **IBM QRadar**: Enterprise security platform
* **Microsoft Sentinel**: Cloud-native SIEM

=== Prometheus метрики

[source,yaml]
----
# Метрики для мониторинга производительности
- name: system_security_events_total
  type: counter
  help: Total number of security events detected

- name: apparmor_profiles_loaded
  type: gauge
  help: Number of loaded AppArmor profiles

- name: auditd_backlog_current
  type: gauge
  help: Current audit backlog

- name: fail2ban_banned_ips
  type: gauge
  help: Number of currently banned IPs
----

=== Compliance отчетность

Автоматическая генерация отчетов для:

* **CIS Benchmarks**: Center for Internet Security
* **PCI DSS**: Payment Card Industry Data Security Standard
* **HIPAA**: Health Insurance Portability and Accountability Act
* **GDPR**: General Data Protection Regulation
* **SOX**: Sarbanes-Oxley Act

== Безопасность

=== Защита компонентов

* **AppArmor**: Ограничение доступа к файлам мониторинга
* **auditd**: Защищенные логи с контролем целостности
* **Fail2Ban**: Автоматическая защита от brute force атак
* **Интеграция**: Единая политика безопасности для всех компонентов

=== Аудит и compliance

* **Детальный аудит**: Все действия пользователей и системы
* **Цепочка доверия**: Проверка целостности от источника до хранилища
* **Регуляторное соответствие**: Готовность к аудитам и инспекциям
* **Долгосрочное хранение**: Безопасное хранение логов аудита

== Производительность

=== Оптимизация

* **Асинхронный режим**: Минимальное влияние на производительность
* **Интеллектуальная буферизация**: Предотвращение потери событий
* **Эффективная фильтрация**: Только необходимые события аудита
* **Автоматическая настройка**: Адаптация под нагрузку системы

=== Мониторинг производительности

[source,bash]
----
# Мониторинг влияния на систему
htop | grep -E "(auditd|fail2ban|apparmor)"

# Проверка backlog аудита
sudo auditctl -s | grep backlog

# Мониторинг использования диска
df -h /var/log/audit /var/log/fail2ban

# Анализ производительности компонентов
sudo aureport -s | head -10
----

== Troubleshooting

=== Диагностика проблем

[source,bash]
----
# Проверка статуса всех компонентов
sudo system-monitoring-status

# Диагностика AppArmor
sudo aa-status
sudo journalctl -u apparmor --no-pager

# Диагностика auditd
sudo systemctl status auditd
sudo auditctl -s

# Диагностика Fail2Ban
sudo fail2ban-client status
sudo journalctl -u fail2ban --no-pager
----

=== Решение распространенных проблем

* **Высокий backlog аудита**: Увеличить размер буфера или оптимизировать правила
* **Fail2Ban не блокирует**: Проверить фильтры и jail конфигурацию
* **AppArmor не загружает профили**: Проверить синтаксис профилей
* **Логи не генерируются**: Проверить права доступа и конфигурацию

== Примеры использования

=== Минимальная настройка

[source,yaml]
----
layer:
  base: bookworm-minbase
  security: system-monitoring

system_monitoring:
  enable: y
  authentication_monitoring: y
  file_access_monitoring: y
----

=== Максимальная безопасность

[source,yaml]
----
system_monitoring:
  enable: y
  apparmor_enable: y
  auditd_enable: y
  fail2ban_enable: y
  authentication_monitoring: y
  file_access_monitoring: y
  privilege_monitoring: y
  network_monitoring: y
  compliance_monitoring: y
  alerting_enabled: y
  log_retention_days: 180
----

=== Production окружение

[source,yaml]
----
device:
  layer: rpi5
  storage_type: nvme

image:
  layer: image-rpios
  name: production-monitoring
  compression: zstd

layer:
  base: bookworm-minbase
  security: system-monitoring
  monitoring: system-monitoring

system_monitoring:
  enable: y
  apparmor_enable: y
  auditd_enable: y
  fail2ban_enable: y
  compliance_monitoring: y
  alerting_enabled: y

monitoring:
  prometheus: y
  grafana: y
  alertmanager: y
----

== Заключение

System Access Monitoring Layer предоставляет **enterprise-grade** решение для комплексного мониторинга безопасности Raspberry Pi систем. Интеграция AppArmor, auditd и Fail2Ban обеспечивает:

- ✅ Комплексный мониторинг всех аспектов доступа к системе
- ✅ Автоматическое обнаружение и предотвращение угроз
- ✅ Соответствие регуляторным требованиям
- ✅ Минимальное влияние на производительность
- ✅ Готовность к enterprise интеграции

Рекомендуется для production систем, требующих высокого уровня безопасности и compliance.
