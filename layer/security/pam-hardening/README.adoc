= PAM Hardening Layer

== Описание

PAM (Pluggable Authentication Modules) hardening слой настраивает политики аутентификации в соответствии с CIS benchmarks для повышения безопасности учетных записей и аутентификации.

== Модули PAM

=== pam_pwquality
*Проверка силы паролей*

[source,ini]
----
minlen = 14              # Минимальная длина пароля
dcredit = -1             # Минимум 1 цифра
ucredit = -1             # Минимум 1 заглавная буква
lcredit = -1             # Минимум 1 строчная буква
ocredit = -1             # Минимум 1 специальный символ
retry = 3                # Количество попыток ввода
----

=== pam_faillock
*Блокировка аккаунтов при неудачных попытках*

[source,ini]
----
deny = 5                 # Количество неудачных попыток
unlock_time = 900        # Время блокировки (секунды)
----

=== pam_limits
*Ограничения ресурсов*

[source,ini]
----
* soft core 0           # Ограничение core dumps
* hard core 0
* soft nofile 65536     # Максимум открытых файлов
* hard nofile 65536
----

=== pam_tally2
*Отслеживание неудачных попыток входа*

[source,ini]
----
file = /var/log/tallylog  # Файл для хранения данных
deny = 3                 # Количество неудачных попыток
unlock_time = 600        # Время разблокировки
----

== Настройка

=== Базовая конфигурация

[source,yaml]
----
layer:
  base: bookworm-minbase
  security: pam-hardening
----

=== Полная конфигурация

[source,yaml]
----
layer:
  base: bookworm-minbase
  security: pam-hardening

pam_hardening:
  enable: y                      # Включить PAM hardening
  pwquality_enable: y            # Включить проверку силы паролей
  pwquality_minlen: 14           # Минимальная длина пароля
  pwquality_dcredit: -1          # Минимум цифр
  pwquality_ucredit: -1          # Минимум заглавных
  pwquality_lcredit: -1          # Минимум строчных
  pwquality_ocredit: -1          # Минимум специальных символов
  pwquality_retry: 3             # Количество попыток
  faillock_enable: y             # Включить блокировку аккаунтов
  faillock_deny: 5               # Количество неудачных попыток
  faillock_unlock_time: 900      # Время блокировки (секунды)
  limits_enable: y               # Включить ограничения ресурсов
  tally2_enable: y               # Включить tally2
  unix_auth_enable: y            # Включить Unix аутентификацию
  shadow_auth: y                 # Использовать shadow пароли
----

== Использование

=== Проверка конфигурации PAM

[source,bash]
----
# Проверка синтаксиса PAM
sudo pam_tally2 --help
sudo faillock --help

# Проверка tally2
sudo pam_tally2 --user root

# Проверка блокировок аккаунтов
sudo faillock --user admin

# Сброс блокировок
sudo faillock --user admin --reset
----

=== Тестирование политик паролей

[source,bash]
----
# Тестирование силы пароля
echo "weak" | pam_pwquality

# Проверка ограничений
ulimit -a

# Тестирование блокировок (осторожно!)
faillock --user testuser
----

=== Мониторинг

[source,bash]
----
# Просмотр логов аутентификации
sudo tail -f /var/log/auth.log | grep -E "(authentication failure|session opened|session closed)"

# Проверка tally2
sudo pam_tally2

# Мониторинг блокировок
sudo journalctl -u systemd-logind | grep -i fail
----

== Производительность

* **Минимальное влияние**: PAM модули работают асинхронно
* **Кеширование**: Результаты проверок кешируются
* **Оптимизация**: Настройки оптимизированы для Raspberry Pi
* **Асинхронность**: Блокировка аккаунтов не влияет на производительность

== Безопасность

=== Защита от атак

* **Brute force**: Блокировка аккаунтов при множественных неудачных попытках
* **Слабые пароли**: Принудительная проверка силы паролей
* **Dictionary attacks**: Защита от словарных атак
* **Session hijacking**: Мониторинг сессий

=== Compliance

* **CIS Level 2**: Соответствует требованиям CIS benchmarks
* **PCI DSS**: Удовлетворяет требованиям PCI DSS 8.2
* **ISO 27001**: Поддержка стандартов информационной безопасности
* **NIST**: Соответствует рекомендациям NIST SP 800-53

== Устранение неисправностей

=== Проблемы с аутентификацией

[source,bash]
----
# Проверка PAM конфигурации
sudo pam_tally2 --user $USER

# Сброс блокировок
sudo faillock --user $USER --reset

# Проверка логов
sudo journalctl -u systemd-logind --since today
----

=== Проблемы с паролями

[source,bash]
----
# Тестирование политики паролей
echo "testpass123!" | pam_pwquality

# Проверка модулей PAM
pam_exec -c "echo test" -- /bin/echo "PAM working"
----

=== Проблемы с ресурсами

[source,bash]
----
# Проверка ограничений
ulimit -a

# Проверка лимитов для пользователя
prlimit --pid=$(pgrep -u $USER) --core=unlimited
----

== Примеры конфигурации

=== Минимальная безопасность

[source,yaml]
----
pam_hardening:
  enable: y
  pwquality_enable: y
  pwquality_minlen: 8
  pwquality_dcredit: 0
  pwquality_ucredit: 0
  pwquality_lcredit: 0
  pwquality_ocredit: 0
  faillock_enable: y
  faillock_deny: 3
----

=== Максимальная безопасность

[source,yaml]
----
pam_hardening:
  enable: y
  pwquality_enable: y
  pwquality_minlen: 16
  pwquality_dcredit: -1
  pwquality_ucredit: -1
  pwquality_lcredit: -1
  pwquality_ocredit: -1
  pwquality_retry: 3
  faillock_enable: y
  faillock_deny: 5
  faillock_unlock_time: 900
  limits_enable: y
  tally2_enable: y
  unix_auth_enable: y
  shadow_auth: y
----

== Ссылки

* https://linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html[Linux-PAM System Administrator's Guide]
* https://www.cisecurity.org/benchmark/debian_linux[CIS Debian Benchmarks]
* https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring-authentication-and-authorization-in-rhel/configuring-pam-in-authselect_configuring-authentication-and-authorization-in-rhel[Red Hat PAM Configuration]
* https://wiki.archlinux.org/title/PAM[Arch Linux PAM Wiki]
