# METABEGIN
# X-Env-Layer-Name: password-policies-aging
# X-Env-Layer-Category: security
# X-Env-Layer-Description: Password aging and expiration policies
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: password-policies-core
# X-Env-Layer-Provides: password-policies-aging
# X-Env-VarPrefix: password_policies_aging
# X-Env-Var-enable: y
# X-Env-Var-enable-Description: Enable password aging policies
# X-Env-Var-enable-Required: false
# X-Env-Var-enable-Valid: bool
# X-Env-Var-max_days: 90
# X-Env-Var-max_days-Description: Maximum password age in days
# X-Env-Var-max_days-Required: false
# X-Env-Var-max_days-Valid: int:30-365
# X-Env-Var-max_days-Set: lazy
# X-Env-Var-min_days: 1
# X-Env-Var-min_days-Description: Minimum days between password changes
# X-Env-Var-min_days-Required: false
# X-Env-Var-min_days-Valid: int:0-30
# X-Env-Var-min_days-Set: lazy
# X-Env-Var-warn_days: 7
# X-Env-Var-warn_days-Description: Days before password expires to warn user
# X-Env-Var-warn_days-Required: false
# X-Env-Var-warn_days-Valid: int:1-30
# X-Env-Var-warn_days-Set: lazy
# X-Env-Var-inactive_days: 30
# X-Env-Var-inactive_days-Description: Days after password expires until account is disabled
# X-Env-Var-inactive_days-Required: false
# X-Env-Var-inactive_days-Valid: int:1-90
# X-Env-Var-inactive_days-Set: lazy
# X-Env-Var-remember: 5
# X-Env-Var-remember-Description: Number of previous passwords to remember
# X-Env-Var-remember-Required: false
# X-Env-Var-remember-Valid: int:3-20
# X-Env-Var-remember-Set: lazy
# METAEND
---
mmdebstrap:
  customize-hooks:
    - |
      # Source common functions
      . "templates/security/common.sh"

      # Validate component enablement
      validate_component_enabled "password_policies_aging"

      echo "⏰ Installing password aging policies..."

      # Configure login.defs for password aging
      PASS_MAX_DAYS=${IGconf_password_policies_aging_max_days:-90}
      PASS_MIN_DAYS=${IGconf_password_policies_aging_min_days:-1}
      PASS_WARN_AGE=${IGconf_password_policies_aging_warn_days:-7}

      # Update login.defs
      sed -i "s|^PASS_MAX_DAYS.*|PASS_MAX_DAYS   $PASS_MAX_DAYS|" "$1/etc/login.defs" || echo "PASS_MAX_DAYS   $PASS_MAX_DAYS" >> "$1/etc/login.defs"
      sed -i "s|^PASS_MIN_DAYS.*|PASS_MIN_DAYS   $PASS_MIN_DAYS|" "$1/etc/login.defs" || echo "PASS_MIN_DAYS   $PASS_MIN_DAYS" >> "$1/etc/login.defs"
      sed -i "s|^PASS_WARN_AGE.*|PASS_WARN_AGE   $PASS_WARN_AGE|" "$1/etc/login.defs" || echo "PASS_WARN_AGE   $PASS_WARN_AGE" >> "$1/etc/login.defs"

      # Configure password history
      PASS_REMEMBER=${IGconf_password_policies_aging_remember:-5}

      echo "✅ Password aging configured:"
      echo "   Max days: $PASS_MAX_DAYS"
      echo "   Min days: $PASS_MIN_DAYS"
      echo "   Warn days: $PASS_WARN_AGE"
      echo "   Remember last: $PASS_REMEMBER passwords"
