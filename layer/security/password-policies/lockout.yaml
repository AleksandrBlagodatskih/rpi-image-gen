# METABEGIN
# X-Env-Layer-Name: password-policies-lockout
# X-Env-Layer-Category: security
# X-Env-Layer-Description: Account lockout policies after failed login attempts
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: password-policies-core
# X-Env-Layer-Provides: password-policies-lockout
# X-Env-VarPrefix: password_policies_lockout
# X-Env-Var-enable: y
# X-Env-Var-enable-Description: Enable account lockout after failed login attempts
# X-Env-Var-enable-Required: false
# X-Env-Var-enable-Valid: bool
# X-Env-Var-attempts: 5
# X-Env-Var-attempts-Description: Number of failed attempts before lockout
# X-Env-Var-attempts-Required: false
# X-Env-Var-attempts-Valid: int:3-10
# X-Env-Var-attempts-Set: lazy
# X-Env-Var-unlock_time: 600
# X-Env-Var-unlock_time-Description: Time in seconds to unlock account after lockout
# X-Env-Var-unlock_time-Required: false
# X-Env-Var-unlock_time-Valid: int:60-3600
# X-Env-Var-unlock_time-Set: lazy
# X-Env-Var-retry: 3
# X-Env-Var-retry-Description: Number of retries for password change
# X-Env-Var-retry-Required: false
# X-Env-Var-retry-Valid: int:1-5
# X-Env-Var-retry-Set: lazy
# METAEND
---
mmdebstrap:
  customize-hooks:
    - |
      # Source common functions
      . "templates/security/common.sh"

      # Validate component enablement
      validate_component_enabled "password_policies_lockout"

      echo "ðŸ”’ Installing account lockout policies..."

      # Configure PAM for account lockout
      ATTEMPTS=${IGconf_password_policies_lockout_attempts:-5}
      UNLOCK_TIME=${IGconf_password_policies_lockout_unlock_time:-600}

      # Configure common-auth for lockout
      install -m 644 "templates/security/password-policies/common-auth" "$1/etc/pam.d/common-auth"

      # Configure common-account for password expiration
      install -m 644 "templates/security/password-policies/common-account" "$1/etc/pam.d/common-account"

      # Configure common-password with retry limit
      RETRY=${IGconf_password_policies_lockout_retry:-3}
      install -m 644 "templates/security/password-policies/common-password" "$1/etc/pam.d/common-password"

      # Update retry count
      sed -i "s/retry=3/retry=$RETRY/" "$1/etc/pam.d/common-password"

      echo "âœ… Account lockout configured:"
      echo "   Failed attempts before lockout: $ATTEMPTS"
      echo "   Unlock time: ${UNLOCK_TIME}s"
      echo "   Password change retries: $RETRY"
