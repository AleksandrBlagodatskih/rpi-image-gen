# METABEGIN
# X-Env-Layer-Name: sysctl-performance
# X-Env-Layer-Category: security
# X-Env-Layer-Description: Performance optimization parameters
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: locale-base
# X-Env-Layer-Provides: sysctl-performance
# X-Env-VarPrefix: sysctl_performance
# X-Env-Var-tcp_optimizations: y
# X-Env-Var-tcp_optimizations-Description: Enable TCP performance optimizations
# X-Env-Var-tcp_optimizations-Required: false
# X-Env-Var-tcp_optimizations-Valid: bool
# X-Env-Var-tcp_optimizations-Set: lazy
# X-Env-Var-memory_optimizations: y
# X-Env-Var-memory_optimizations-Description: Enable memory management optimizations
# X-Env-Var-memory_optimizations-Required: false
# X-Env-Var-memory_optimizations-Valid: bool
# X-Env-Var-memory_optimizations-Set: lazy
# X-Env-Var-docker_compatibility: y
# X-Env-Var-docker_compatibility-Description: Enable Docker-compatible network settings
# X-Env-Var-docker_compatibility-Required: false
# X-Env-Var-docker_compatibility-Valid: bool
# X-Env-Var-docker_compatibility-Set: lazy
# METAEND
---
mmdebstrap:
  customize-hooks:
    - |
      SYSCTL_CONF="/etc/sysctl.d/40-performance-optimizations.conf"

      echo "⚡ Applying performance optimizations..."

      # TCP optimizations
      if igconf isy IGconf_sysctl_performance_tcp_optimizations; then
        echo "net.ipv4.tcp_tw_reuse = 1" >> "$1$SYSCTL_CONF"
        echo "net.ipv4.ip_local_port_range = 1024 65535" >> "$1$SYSCTL_CONF"
        echo "net.core.somaxconn = 1024" >> "$1$SYSCTL_CONF"
        echo "net.core.netdev_max_backlog = 5000" >> "$1$SYSCTL_CONF"
        echo "net.ipv4.tcp_max_syn_backlog = 1024" >> "$1$SYSCTL_CONF"
        echo "✅ TCP optimizations applied"
      fi

      # Memory optimizations
      if igconf isy IGconf_sysctl_performance_memory_optimizations; then
        echo "vm.swappiness = 10" >> "$1$SYSCTL_CONF"
        echo "vm.vfs_cache_pressure = 50" >> "$1$SYSCTL_CONF"
        echo "✅ Memory optimizations applied"
      fi

      # Docker compatibility (optional)
      if igconf isy IGconf_sysctl_performance_docker_compatibility; then
        echo "net.ipv4.ip_forward = 1" >> "$1$SYSCTL_CONF"
        echo "net.ipv6.conf.all.forwarding = 1" >> "$1$SYSCTL_CONF"
        echo "net.bridge.bridge-nf-call-iptables = 1" >> "$1$SYSCTL_CONF"
        echo "net.bridge.bridge-nf-call-ip6tables = 1" >> "$1$SYSCTL_CONF"
        echo "✅ Docker compatibility settings applied"
      fi

      # Apply settings
      chroot "$1" sysctl -p "$SYSCTL_CONF" >/dev/null 2>&1 || true

      echo "✅ Performance optimizations applied"
