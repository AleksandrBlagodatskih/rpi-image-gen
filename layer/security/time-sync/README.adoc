= Time Sync Layer

== Описание

Time Sync слой настраивает синхронизацию времени в соответствии с CIS benchmarks для обеспечения точного системного времени и корректных timestamps в логах.

== Провайдеры синхронизации

=== systemd-timesyncd (рекомендуемый)
* **Легковесный**: Минимальное потребление ресурсов
* **Встроенный**: Часть systemd
* **Простой**: Минимальная конфигурация
* **Надежный**: Автоматическое восстановление

=== Chrony
* **Точный**: Высокая точность синхронизации
* **Гибкий**: Поддержка множественных серверов
* **RTC**: Синхронизация аппаратных часов
* **Enterprise**: Подходит для дата-центров

=== NTP (legacy)
* **Стандарт**: Классический NTP протокол
* **Совместимость**: Работает с любыми NTP серверами
* **Контроль**: Полный контроль над конфигурацией

== Настройка

=== Базовая конфигурация

[source,yaml]
----
layer:
  base: bookworm-minbase
  security: time-sync
----

=== systemd-timesyncd

[source,yaml]
----
layer:
  base: bookworm-minbase
  security: time-sync

time_sync:
  enable: y                           # Включить синхронизацию времени
  provider: systemd-timesyncd         # Использовать systemd-timesyncd
  servers: "0.debian.pool.ntp.org 1.debian.pool.ntp.org 2.debian.pool.ntp.org 3.debian.pool.ntp.org"
  fallback_servers: "ntp.ubuntu.com"  # Fallback серверы
  timesyncd_root_distance_max: 5      # Максимальное расстояние до root
  timesyncd_poll_interval_min: 32     # Минимальный интервал опроса (сек)
  timesyncd_poll_interval_max: 2048   # Максимальный интервал опроса (сек)
----

=== Chrony

[source,yaml]
----
time_sync:
  enable: y
  provider: chrony                    # Использовать Chrony
  chrony_pool: "0.debian.pool.ntp.org 1.debian.pool.ntp.org 2.debian.pool.ntp.org 3.debian.pool.ntp.org"
  chrony_makestep: "1 3"             # Makestep порог
  chrony_rtcsync: y                  # Синхронизировать RTC
  chrony_options: ""                 # Дополнительные опции
----

=== NTP (legacy)

[source,yaml]
----
time_sync:
  enable: y
  provider: ntp                      # Использовать NTP
  servers: "0.debian.pool.ntp.org 1.debian.pool.ntp.org 2.debian.pool.ntp.org 3.debian.pool.ntp.org"
  ntp_restrict: "default kod nomodify notrap nopeer noquery"
  ntp_options: "-g"                  # Дополнительные опции NTP
----

== Использование

=== Проверка статуса

[source,bash]
----
# Статус синхронизации
timedatectl status

# Проверка systemd-timesyncd
timedatectl timesync-status

# Проверка Chrony
chronyc tracking
chronyc sources

# Проверка NTP
ntpq -p
----

=== Мониторинг

[source,bash]
----
# Мониторинг синхронизации
timedatectl show-timesync

# Логи синхронизации
journalctl -u systemd-timesyncd
journalctl -u chrony
journalctl -u ntp

# Проверка точности
chronyc makestep
----

=== Диагностика

[source,bash]
----
# Проверка доступности серверов
chronyc activity

# Тестирование серверов
chronyc add server 0.debian.pool.ntp.org

# Проверка конфигурации
timedatectl show
----

== Производительность

* **Минимальное потребление**: Оптимизированные интервалы опроса
* **Адаптивность**: Автоматическая подстройка под сетевые условия
* **Кеширование**: Локальное кеширование времени
* **Эффективность**: Минимальное влияние на системные ресурсы

== Безопасность

=== Защита от атак

* **NTP amplification**: Ограничение доступа к NTP сервисам
* **Time spoofing**: Проверка подлинности источников времени
* **DDoS**: Ограничение трафика синхронизации
* **Man-in-the-middle**: Использование защищенных протоколов

=== Compliance

* **CIS Level 2**: Соответствует требованиям CIS benchmarks 2.2.1.1-2.2.1.3
* **PCI DSS**: Удовлетворяет требованиям PCI DSS 10.4.1
* **ISO 27001**: Поддержка стандартов информационной безопасности
* **NIST**: Соответствует рекомендациям NIST SP 800-53

== Устранение неисправностей

=== Синхронизация не работает

[source,bash]
----
# Проверка доступности серверов
ping -c 3 0.debian.pool.ntp.org

# Проверка firewall
ufw status | grep 123

# Проверка сервиса
systemctl status systemd-timesyncd

# Ручная синхронизация
timedatectl set-ntp true
----

=== Проблемы с точностью

[source,bash]
----
# Проверка качества источников
chronyc sourcestats

# Увеличение частоты опроса
chronyc burst 4/10

# Проверка аппаратных часов
hwclock --show
----

=== Конфликты сервисов

[source,bash]
----
# Отключение конфликтующих сервисов
systemctl disable ntp
systemctl disable chrony

# Проверка портов
ss -tuln | grep :123

# Остановка всех time сервисов
systemctl stop systemd-timesyncd chrony ntp
----

== Примеры конфигурации

=== Минимальная настройка

[source,yaml]
----
time_sync:
  enable: y
  provider: systemd-timesyncd
  servers: "0.debian.pool.ntp.org 1.debian.pool.ntp.org"
----

=== Enterprise настройка

[source,yaml]
----
time_sync:
  enable: y
  provider: chrony
  servers: "ntp1.company.com ntp2.company.com"
  chrony_pool: "ntp1.company.com ntp2.company.com"
  chrony_makestep: "0.5 3"
  chrony_rtcsync: y
----

=== High-security настройка

[source,yaml]
----
time_sync:
  enable: y
  provider: chrony
  servers: "secure-ntp1.domain.com secure-ntp2.domain.com"
  chrony_makestep: "0.1 1"
  chrony_rtcsync: n  # Не синхронизировать RTC для безопасности
----

== Ссылки

* https://wiki.archlinux.org/title/Systemd-timesyncd[systemd-timesyncd Arch Wiki]
* https://chrony.tuxfamily.org/[Chrony Project]
* https://www.ntp.org/[NTP Project]
* https://www.cisecurity.org/benchmark/debian_linux[CIS Debian Benchmarks]
* https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring-basic-system-settings/configuring-ntp-using-chrony_configuring-basic-system-settings[Red Hat Chrony Configuration]
