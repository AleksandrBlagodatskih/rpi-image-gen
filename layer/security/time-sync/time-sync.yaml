# METABEGIN
# X-Env-Layer-Name: time-sync
# X-Env-Layer-Category: security
# X-Env-Layer-Desc: Time synchronization configuration (assumes packages are pre-installed)
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: locale-base
#
# X-Env-VarPrefix: time_sync
#
# X-Env-Var-enable: y
# X-Env-Var-enable-Desc: Enable time synchronization
# X-Env-Var-enable-Required: n
# X-Env-Var-enable-Valid: bool
# X-Env-Var-enable-Set: y
#
# X-Env-Var-provider: systemd-timesyncd
# X-Env-Var-provider-Desc: Time sync provider (systemd-timesyncd, chrony)
# X-Env-Var-provider-Required: n
# X-Env-Var-provider-Valid: keywords:systemd-timesyncd,chrony
# X-Env-Var-provider-Set: lazy
#
# X-Env-Var-servers: "0.debian.pool.ntp.org 1.debian.pool.ntp.org 2.debian.pool.ntp.org 3.debian.pool.ntp.org"
# X-Env-Var-servers-Desc: NTP servers (space-separated)
# X-Env-Var-servers-Required: n
# X-Env-Var-servers-Valid: string
# X-Env-Var-servers-Set: lazy
# METAEND
---
mmdebstrap:
  includes: []
  customize-hooks:
    # Simple time synchronization setup
    - |
      igconf isy IGconf_time_sync_enable || exit 0

      echo "Setting up time synchronization..."

      # Get configuration
      PROVIDER=$(igconf getval IGconf_time_sync_provider)
      SERVERS=$(igconf getval IGconf_time_sync_servers)

      case "$PROVIDER" in
        "systemd-timesyncd")
          echo "Configuring systemd-timesyncd..."
          mkdir -p "$1/etc/systemd/timesyncd.conf.d"

          # Create timesyncd config
          printf '[Time]\nNTP=%s\n' "${SERVERS:-0.debian.pool.ntp.org 1.debian.pool.ntp.org 2.debian.pool.ntp.org 3.debian.pool.ntp.org}" > "$1/etc/systemd/timesyncd.conf.d/rpi-image-gen.conf"

          chroot "$1" systemctl enable systemd-timesyncd
          echo "systemd-timesyncd configured"
          ;;

        "chrony")
          echo "Configuring Chrony..."
          # Stop and disable systemd-timesyncd
          chroot "$1" systemctl disable systemd-timesyncd
          chroot "$1" systemctl stop systemd-timesyncd

          # Backup original config
          chroot "$1" cp /etc/chrony/chrony.conf /etc/chrony/chrony.conf.backup

          # Create new config
          printf '# Chrony configuration for rpi-image-gen\n\n# Security: Only allow localhost\nbindcmdaddress 127.0.0.1\nbindcmdaddress ::1\n\n# NTP servers\n' > "$1/etc/chrony/chrony.conf"
          echo "pool ${SERVERS:-0.debian.pool.ntp.org 1.debian.pool.ntp.org 2.debian.pool.ntp.org 3.debian.pool.ntp.org} iburst" >> "$1/etc/chrony/chrony.conf"
          echo "makestep 1 3" >> "$1/etc/chrony/chrony.conf"
          echo "rtcsync" >> "$1/etc/chrony/chrony.conf"

          chroot "$1" systemctl enable chrony
          echo "Chrony configured"
          ;;

        *)
          echo "Unknown time sync provider: $PROVIDER"
          echo "Defaulting to systemd-timesyncd"
          chroot "$1" systemctl enable systemd-timesyncd
          ;;
      esac

      # Show status
      echo "Time synchronization setup complete"
      chroot "$1" timedatectl status | head -5 || echo "timedatectl not available"
