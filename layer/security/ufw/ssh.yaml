# METABEGIN
# X-Env-Layer-Name: ufw-ssh
# X-Env-Layer-Category: extension
# X-Env-Layer-Desc: Automatic SSH allowance when OpenSSH server is detected
# X-Env-Layer-Version: 2.0.0
# X-Env-Layer-Requires: ufw-core-basic
# X-Env-Layer-Provides: firewall-ssh-auto-allow
# X-Env-VarPrefix: ufw
# X-Env-Var-openssh_allow: y
# X-Env-Var-openssh_allow-Desc: Automatically allow OpenSSH connections when SSH server is detected
# X-Env-Var-openssh_allow-Required: false
# X-Env-Var-openssh_allow-Valid: bool
# X-Env-Var-openssh_allow-Set: lazy
# METAEND
---
mmdebstrap:
  customize-hooks:
    - |
      # PHASE 0: Enable check
      igconf isy IGconf_ufw_openssh_allow || exit 0

      echo "üîë Installing UFW SSH auto-allow..."

      # Check if SSH is available
      if [ ! -f "$1/usr/sbin/sshd" ]; then
        echo "‚ö†Ô∏è OpenSSH server not detected, skipping auto-allow"
        exit 0
      fi

      # OpenSSH integration
      echo "üîë Configuring automatic SSH allowance..."
      # Create SSH detection and allowance script
      install -m 644 "templates/security/ufw/ufw-ssh-auto-allow" "$1/usr/local/bin/ufw-ssh-auto-allow"
      chmod +x "$1/usr/local/bin/ufw-ssh-auto-allow"

      # Create systemd service to auto-allow SSH
      install -m 644 "templates/security/ufw/ufw-ssh-auto-allow.service" "$1/etc/systemd/system/ufw-ssh-auto-allow.service"

      chroot "$1" systemctl enable ufw-ssh-auto-allow
      echo "‚úÖ OpenSSH integration configured"
