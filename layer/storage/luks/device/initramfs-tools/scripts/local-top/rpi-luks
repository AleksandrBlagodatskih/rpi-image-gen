#!/bin/bash
set -euo pipefail

# Function for error handling
die() {
    echo "ERROR: $*" >&2
    exit 1
}

# Use injected CRYPT UUID from template (replaced at build time)
CRYPT_UUID="<CRYPT_UUID>"

if [ -z "$CRYPT_UUID" ] || [ "$CRYPT_UUID" = "<CRYPT_UUID>" ]; then
    echo "WARNING: No crypt UUID found, skipping LUKS unlock" >&2
    exit 0
fi

# Unlock LUKS container
echo "Unlocking LUKS container UUID=$CRYPT_UUID..."
if [ -x /usr/bin/rpi-raid ]; then
    # Use custom keyscript if available
    if cryptsetup luksOpen --keyscript /usr/bin/rpi-raid UUID="$CRYPT_UUID" cryptroot; then
        echo "Successfully unlocked LUKS container"
    else
        echo "ERROR: Failed to unlock LUKS container with keyscript" >&2
        exit 1
    fi
else
    # Fallback: try with key file if available
    if [ -f /key ]; then
        if cryptsetup luksOpen --key-file /key UUID="$CRYPT_UUID" cryptroot; then
            echo "Successfully unlocked LUKS container with key file"
        else
            echo "ERROR: Failed to unlock LUKS container with key file" >&2
            exit 1
        fi
    else
        echo "ERROR: No keyscript or key file available for LUKS unlock" >&2
        exit 1
    fi
fi

echo "LUKS initialization complete"
exit 0
