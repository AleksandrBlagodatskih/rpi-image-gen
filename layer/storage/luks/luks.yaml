# METABEGIN
# X-Env-Layer-Name: luks
# X-Env-Layer-Desc: LUKS2 encryption support for storage devices
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Provides: luks,encryption
# X-Env-Layer-Category: extension
# METAEND
---
mmdebstrap:
  packages:
    - cryptsetup
    - initramfs-tools

  customize-hooks:
    # LUKS configuration with idempotency and error handling
    - |
      set -eu
      echo "🔐 Configuring LUKS2 encryption"

      # Ensure cryptsetup target is enabled
      systemctl enable cryptsetup.target 2>/dev/null || true

      # Create LUKS key directory if it doesn't exist
      mkdir -p /etc/luks
      chmod 700 /etc/luks

      echo "✅ LUKS2 encryption configured"

    # Copy initramfs hooks and scripts for LUKS
    - |
      mkdir -p $1/etc/initramfs-tools/hooks
      mkdir -p $1/etc/initramfs-tools/scripts/local-top
      cp /home/admin/rpi-image-gen/layer/storage/luks/device/initramfs-tools/hooks/rpi-luks $1/etc/initramfs-tools/hooks/
      chmod +x $1/etc/initramfs-tools/hooks/rpi-luks
      cp /home/admin/rpi-image-gen/layer/storage/luks/device/initramfs-tools/scripts/local-top/rpi-luks $1/etc/initramfs-tools/scripts/local-top/
      chmod +x $1/etc/initramfs-tools/scripts/local-top/rpi-luks
      cp /home/admin/rpi-image-gen/layer/storage/luks/device/initramfs-tools/modules $1/etc/initramfs-tools/
