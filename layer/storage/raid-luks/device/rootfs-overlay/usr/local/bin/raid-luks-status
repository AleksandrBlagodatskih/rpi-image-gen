#!/bin/bash
# RAID/LUKS Status Script
# Provides comprehensive status information about RAID/LUKS hybrid storage

echo "=== RAID/LUKS Hybrid Storage Status ==="
echo

# Check RAID status
echo "1. RAID Status:"
if [ -b /dev/md0 ]; then
  echo "   ✅ RAID array /dev/md0 active"
  mdadm --detail /dev/md0 | grep -E "(State|Active|Failed)" | sed 's/^/   /'
else
  echo "   ❌ RAID array /dev/md0 not found"
fi
echo

# Check LUKS status
echo "2. LUKS Encryption Status:"
if [ -b /dev/mapper/cryptroot ]; then
  echo "   ✅ LUKS container cryptroot active"
  cryptsetup status cryptroot | grep -E "(type|cipher|keysize)" | sed 's/^/   /'
else
  echo "   ❌ LUKS container cryptroot not active"
fi
echo

# Check filesystem
echo "3. Filesystem Status:"
ROOT_MOUNT=$(findmnt -n -o TARGET / 2>/dev/null || echo "unknown")
FS_TYPE=$(findmnt -n -o FSTYPE / 2>/dev/null || echo "unknown")
echo "   Mount point: \"$ROOT_MOUNT\""
echo "   Filesystem: \"$FS_TYPE\""

# Check disk expansion
if [ -f /var/lib/disk-expansion.done ]; then
  echo "   ✅ Disk expansion completed"
else
  echo "   ⏳ Disk expansion pending"
fi
echo

# Check services
echo "4. Services Status:"
for service in mdadm cryptsetup disk-expansion; do
  if systemctl is-active --quiet "$service" 2>/dev/null; then
    echo "   ✅ $service: active"
  elif systemctl is-enabled --quiet "$service" 2>/dev/null; then
    echo "   ⚠️  $service: enabled but inactive"
  else
    echo "   ❌ $service: not configured"
  fi
done
