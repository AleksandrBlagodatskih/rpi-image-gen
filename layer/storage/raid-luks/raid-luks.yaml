# METABEGIN
# X-Env-Layer-Name: raid-luks
# X-Env-Layer-Desc: RAID1 + LUKS encryption support with automatic disk expansion
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Provides: raid,luks,disk-expansion
# X-Env-Layer-Category: extension
# METAEND
---
mmdebstrap:
  packages:
    - mdadm
    - cryptsetup
    - initramfs-tools
    - parted
    - e2fsprogs  # for resize2fs
    - btrfs-progs  # for btrfs filesystem resize
    - f2fs-tools  # for resize.f2fs

  customize-hooks:
    # RAID/LUKS configuration with idempotency and error handling
    - |
      set -eu
      echo "ðŸ”§ Configuring RAID/LUKS hybrid storage"

      # Ensure services are enabled with automatic recovery
      systemctl enable mdadm.service 2>/dev/null || true
      systemctl enable cryptsetup.target 2>/dev/null || true

      # Configure mdadm for automatic RAID assembly
      if [ ! -f /etc/mdadm/mdadm.conf.backup ]; then
        cp /etc/mdadm/mdadm.conf /etc/mdadm/mdadm.conf.backup 2>/dev/null || true
      fi

      echo "âœ… RAID/LUKS hybrid storage configured"

    # Copy initramfs hooks and scripts
    - |
      mkdir -p $1/etc/initramfs-tools/hooks
      mkdir -p $1/etc/initramfs-tools/scripts/local-top
      cp /home/admin/rpi-image-gen/layer/storage/raid-luks/device/initramfs-tools/hooks/rpi-raid-luks $1/etc/initramfs-tools/hooks/
      chmod +x $1/etc/initramfs-tools/hooks/rpi-raid-luks
      cp /home/admin/rpi-image-gen/layer/storage/raid-luks/device/initramfs-tools/scripts/local-top/rpi-raid-luks $1/etc/initramfs-tools/scripts/local-top/
      chmod +x $1/etc/initramfs-tools/scripts/local-top/rpi-raid-luks
      cp /home/admin/rpi-image-gen/layer/storage/raid-luks/device/initramfs-tools/modules $1/etc/initramfs-tools/

    # Enable disk expansion service
    - chroot $1 systemctl enable disk-expansion.service

