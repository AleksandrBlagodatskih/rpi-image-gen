#!/bin/bash
set -euo pipefail

# Function for error handling
die() {
    echo "ERROR: $*" >&2
    exit 1
}

# Wait for devices to settle
echo "Waiting for devices to settle..."
sleep 2

# Use injected RAID UUID from template (replaced at build time)
RAID_UUID="<RAID_UUID>"

if [ -z "$RAID_UUID" ] || [ "$RAID_UUID" = "<RAID_UUID>" ]; then
    echo "WARNING: No RAID UUID found, skipping RAID assembly" >&2
    exit 0
fi

echo "Assembling RAID array UUID=$RAID_UUID..."
if ! mdadm --assemble --uuid="$RAID_UUID" /dev/md0 2>/dev/null; then
    echo "ERROR: RAID assembly failed" >&2
    exit 1
fi

echo "RAID initialization complete"
exit 0
