#!/bin/bash
set -euo pipefail

# Function for error handling
die() {
    echo "ERROR: $*" >&2
    exit 1
}

# Wait for devices to settle
echo "Waiting for devices to settle..."
sleep 2

# Get RAID UUID from cmdline if available
RAID_UUID=""
for param in $(cat /proc/cmdline); do
    case "$param" in
        raiduuid=*)
            RAID_UUID="${param#raiduuid=}"
            ;;
        root=UUID=*)
            # If root=UUID= is specified, it might be the RAID UUID for direct mounting
            RAID_UUID="${param#root=UUID=}"
            ;;
    esac
done

if [ -n "$RAID_UUID" ]; then
    echo "Assembling RAID array UUID=$RAID_UUID..."
    if ! mdadm --assemble --uuid="$RAID_UUID" /dev/md0 2>/dev/null; then
        echo "WARNING: RAID assembly with UUID failed, trying scan..." >&2
        mdadm --assemble --scan /dev/md0 2>/dev/null || echo "WARNING: RAID assembly failed" >&2
    fi
else
    # Last resort: try to scan for any available RAID arrays
    echo "No RAID UUID specified, trying to scan for arrays..."
    mdadm --assemble --scan 2>/dev/null || echo "WARNING: No RAID arrays found" >&2
fi

echo "RAID initialization complete"
exit 0
