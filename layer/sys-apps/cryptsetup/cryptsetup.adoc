= Cryptsetup - Linux Unified Key Setup

== Описание

Cryptsetup - это утилита для настройки прозрачного шифрования дисковых устройств с использованием dm-crypt ядра Linux. Поддерживает формат LUKS (Linux Unified Key Setup) для безопасного хранения ключей шифрования.

== Основные возможности

* Создание и управление LUKS контейнерами
* Поддержка различных алгоритмов шифрования (AES, Twofish, Serpent)
* Управление ключами и passphrase
* Интеграция с initramfs для загрузки с зашифрованных дисков
* Поддержка TRIM для SSD дисков

== Поддерживаемые алгоритмы

* **AES** - Advanced Encryption Standard (рекомендуемый)
* **Twofish** - Feistel network cipher
* **Serpent** - Block cipher
* **CAST5/6** - Carlisle Adams and Stafford Tavares ciphers

== Настройка

=== Минимальная конфигурация

[source,yaml]
----
layer:
  sys-apps: cryptsetup
----

=== Полная конфигурация с настройками

[source,yaml]
----
layer:
  sys-apps: cryptsetup

# Настройки cryptsetup
cryptsetup:
  enable: y                      # Включить поддержку LUKS
  initramfs_integration: y       # Интеграция с initramfs для загрузки
  keyscript_support: n          # Поддержка keyscript для автоматического разблокирования
  secure_key_storage: y         # Включить безопасное хранение ключей
  encryption_algorithm: aes-xts-plain64  # Алгоритм шифрования по умолчанию
  key_size: 512                 # Размер ключа в битах
----

=== Расширенная конфигурация

[source,yaml]
----
layer:
  sys-apps: cryptsetup

# Настройки cryptsetup
cryptsetup:
  enable: y    # Включить cryptsetup с полной настройкой
----

== Initramfs интеграция

При включении `cryptsetup_enable`, слой автоматически:

* Добавляет необходимые модули ядра в initramfs (`dm_crypt`, `dm_mod`)
* Настраивает cryptsetup-initramfs hooks
* Перегенерирует initramfs для поддержки загрузки с LUKS

== Использование

=== Создание LUKS контейнера

[source,bash]
----
# Создание LUKS контейнера на устройстве
cryptsetup luksFormat /dev/sdX

# Открытие LUKS контейнера
cryptsetup luksOpen /dev/sdX cryptroot

# Форматирование открытого контейнера
mkfs.btrfs /dev/mapper/cryptroot
----

=== Автоматическое монтирование

[source,bash]
----
# /etc/crypttab
cryptroot UUID=12345678-1234-1234-1234-123456789012 none luks,discard

# /etc/fstab
/dev/mapper/cryptroot /               btrfs defaults 0 0
----

== Совместимость

* **ОС**: Debian Bookworm, Trixie
* **Архитектуры**: amd64, arm64
* **Ядро**: Linux 4.4+ (рекомендуется 5.0+)
* **Файловые системы**: ext4, btrfs, xfs (с соответствующими пакетами)

== Зависимости

* `essential` - Базовые системные компоненты
* `initramfs-tools` - Для интеграции с initramfs (рекомендуется)

== Примеры использования

=== Зашифрованная корневая файловая система

[source,yaml]
----
device:
  layer: rpi5
  hostname: secure-server

layer:
  base: bookworm-minbase
  sys-apps: cryptsetup
  # другие слои

cryptsetup:
  enable: y
----

=== Enterprise шифрование с RAID и мониторингом

[source,yaml]
----
layer:
  base: bookworm-minbase
  sys-apps: cryptsetup
  sys-apps: mdadm
  device: radxa-sata-penta-hat
  monitoring: enterprise-monitoring

cryptsetup:
  enable: y
  initramfs_integration: y
  keyscript_support: y
  secure_key_storage: y
  encryption_algorithm: aes-xts-plain64
  key_size: 512

mdadm:
  enable: y

monitoring:
  metrics_collection: y
  health_reporting: y
  alerting: y
----

=== Минимальная конфигурация для тестирования

[source,yaml]
----
layer:
  base: bookworm-minbase
  sys-apps: cryptsetup

cryptsetup:
  enable: y
  initramfs_integration: n  # Отключено для простоты тестирования
  keyscript_support: n
----

=== Безопасный сервер с полнодисковым шифрованием

[source,yaml]
----
device:
  layer: rpi5
  hostname: secure-server
  storage_type: nvme

image:
  layer: image-base
  name: secure-server-image
  compression: zstd

layer:
  base: bookworm-minbase
  sys-apps: cryptsetup
  security: maximum-security
  monitoring: system-monitoring

cryptsetup:
  enable: y
  initramfs_integration: y
  keyscript_support: y          # Автоматическое разблокирование
  secure_key_storage: y         # Безопасное хранение ключей
  encryption_algorithm: aes-xts-plain64
  key_size: 512

security:
  enable_encryption: y
  secure_boot: y
----

=== Корпоративный сервер с TPM и secure boot

[source,yaml]
----
device:
  layer: rpi5
  hostname: enterprise-server
  tpm_required: y

image:
  layer: image-base
  name: enterprise-image
  compression: zstd

layer:
  base: bookworm-minbase
  sys-apps: cryptsetup
  security: maximum-security
  enterprise: compliance-tools
  monitoring: enterprise-monitoring

cryptsetup:
  enable: y
  initramfs_integration: y
  keyscript_support: y
  secure_key_storage: y
  encryption_algorithm: aes-xts-plain64
  key_size: 512

security:
  enable_encryption: y
  secure_boot: y
  tpm_enforcement: y
  audit_comprehensive: y

enterprise:
  compliance_reporting: y
  audit_trail: y
  security_policies: strict
----

== Диагностика

=== Проверка статуса LUKS

[source,bash]
----
# Информация о LUKS контейнере
cryptsetup luksDump /dev/sdX

# Проверка открытого контейнера
dmsetup info cryptroot

# Логи cryptsetup
journalctl -u cryptsetup
----

=== Проблемы с загрузкой

[source,bash]
----
# Проверка initramfs
lsinitramfs /boot/initrd.img | grep crypt

# Регенерация initramfs
update-initramfs -u -k all

# Проверка crypttab
cryptsetup isLuks /dev/sdX
----

== Безопасность

* Используйте сильные passphrase или keyfiles
* Храните keyfiles на защищенных разделах
* Регулярно делайте backup LUKS headers
* Рассмотрите использование TPM для хранения ключей

== Новые возможности

=== Автоматическое тестирование конфигурации

Слой теперь включает скрипт `test-luks-setup`, который позволяет:

* Проверить доступность cryptsetup
* Проконтролировать загрузку необходимых модулей ядра
* Убедиться в корректной интеграции с initramfs
* Проверить наличие примеров конфигурации

[source,bash]
----
# Запуск теста после сборки образа
test-luks-setup
----

=== Новые возможности безопасности

==== Безопасное хранение ключей (`secure_key_storage`)

При включении этой опции слой автоматически:

* Создает примеры скриптов для безопасного создания ключей
* Добавляет предупреждения о необходимости backup
* Показывает команды для резервного копирования LUKS заголовков и ключей
* Предоставляет рекомендации по безопасному хранению

==== Улучшенный keyscript

Обновленный keyscript теперь включает:

* Проверку прав доступа к ключевым файлам
* Таймаут для ввода пароля (30 секунд)
* Подробное логирование ошибок
* Безопасный отказ в доступе для неизвестных устройств

==== Настраиваемые алгоритмы шифрования

* **aes-xts-plain64** - Рекомендуемый алгоритм для современных систем
* Поддержка различных размеров ключей (256, 512, 1024 бит)
* Аппаратное ускорение AES (aesni_intel) при наличии

=== Рекомендации по безопасности

1. **Используйте сильные ключи**: Минимум 512 бит для ключей шифрования
2. **Регулярные backup**: Делайте резервные копии LUKS заголовков и ключевых файлов
3. **Мониторинг доступа**: Включите аудит доступа к зашифрованным устройствам
4. **Физическая безопасность**: Обеспечьте физическую защиту устройств с зашифрованными данными

== Ссылки

* https://gitlab.com/cryptsetup/cryptsetup[Официальный репозиторий cryptsetup]
* https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/dm-crypt.html[DM-Crypt documentation]
* https://github.com/tmkerr/cryptsetup-initramfs[Debian cryptsetup-initramfs]
