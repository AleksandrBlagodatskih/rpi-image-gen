= MDADM - Linux Software RAID

== Описание

MDADM (Multiple Device Administration) - это утилита для управления Linux Software RAID массивами. MDADM поддерживает все основные уровни RAID и предоставляет полный набор инструментов для создания, управления и мониторинга RAID массивов.

== Поддерживаемые уровни RAID

* **LINEAR** - Конкатенация устройств (не настоящий RAID)
* **RAID0** - Striping (чередование) без redundancy
* **RAID1** - Mirroring (зеркалирование)
* **RAID4** - Dedicated parity disk
* **RAID5** - Distributed parity
* **RAID6** - Double distributed parity
* **RAID10** - Mirroring + striping
* **MULTIPATH** - Многопутевой доступ (deprecated)
* **FAULTY** - Тестирование отказов (deprecated)
* **CONTAINER** - Контейнер для множественных массивов

== Основные возможности

* Создание и сборка RAID массивов
* Мониторинг состояния массивов
* Управление горячей заменой дисков
* Поддержка различных типов метаданных
* Интеграция с initramfs для загрузки с RAID
* Автоматическое обнаружение массивов

== Настройка

=== Базовая конфигурация

[source,yaml]
----
layer:
  sys-apps: mdadm
----

=== Расширенная конфигурация

[source,yaml]
----
layer:
  sys-apps: mdadm

# Настройки MDADM
mdadm:
  enable: y    # Включить MDADM с полной настройкой
----

== Переменные конфигурации

* **`mdadm_enable`** - Включить полную настройку MDADM
** Тип: `bool`
** Значение по умолчанию: `y`
** Описание: Включает настройку initramfs для RAID поддержки и создание базового mdadm.conf

== Использование

=== Создание RAID массива

[source,bash]
----
# Создание RAID1 массива
mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sda1 /dev/sdb1

# Создание RAID5 массива
mdadm --create /dev/md1 --level=5 --raid-devices=3 /dev/sdc1 /dev/sdd1 /dev/sde1

# Создание RAID10 массива
mdadm --create /dev/md2 --level=10 --raid-devices=4 /dev/sdf1 /dev/sdg1 /dev/sdh1 /dev/sdi1
----

=== Сборка существующего массива

[source,bash]
----
# Автоматическая сборка всех массивов
mdadm --assemble --scan

# Сборка конкретного массива
mdadm --assemble /dev/md0 /dev/sda1 /dev/sdb1
----

=== Мониторинг массивов

[source,bash]
----
# Проверка состояния всех массивов
mdadm --detail --scan

# Детальная информация о массиве
mdadm --detail /dev/md0

# Мониторинг в фоне
mdadm --monitor --scan --daemonise
----

=== Управление дисками

[source,bash]
----
# Отметить диск как отказавший
mdadm /dev/md0 --fail /dev/sda1

# Удалить отказавший диск
mdadm /dev/md0 --remove /dev/sda1

# Добавить spare диск
mdadm /dev/md0 --add /dev/sdc1
----

== Файлы конфигурации

* **`/etc/mdadm/mdadm.conf`** - Основной файл конфигурации
* **`/proc/mdstat`** - Информация о активных массивах
* **`/run/mdadm/map`** - Карта массивов для incremental assembly

== Initramfs интеграция

При включении `mdadm_enable`, слой автоматически:

* Добавляет необходимые модули ядра в initramfs (`md_mod`, `raid0`, `raid1`, `raid10`, `raid456`)
* Создает базовый `/etc/mdadm/mdadm.conf`
* Перегенерирует initramfs для поддержки загрузки с RAID

== Совместимость

* **ОС**: Debian Bookworm, Trixie
* **Архитектуры**: amd64, arm64
* **Ядро**: Linux 4.4+ (рекомендуется 5.0+)

== Зависимости

* `essential` - Базовые системные компоненты
* `initramfs-tools` - Для интеграции с initramfs (рекомендуется)

== Примеры использования

=== Сервер с RAID1 для системного диска

[source,yaml]
----
device:
  layer: rpi5
  hostname: raid-server

image:
  layer: image-rpios
  name: raid-server

layer:
  base: bookworm-minbase
  sys-apps: mdadm
  # ... другие слои

mdadm:
  enable: y
----

=== NAS с RAID5

[source,yaml]
----
device:
  layer: rpi5
  hostname: nas-server

image:
  layer: image-rpios
  name: nas-server

layer:
  base: bookworm-minbase
  sys-apps: mdadm
  network: samba-server
  # ... другие слои

mdadm:
  enable: y
----

== Диагностика

=== Проверка состояния массивов

[source,bash]
----
# Общая информация
cat /proc/mdstat

# Детальная информация
mdadm --detail /dev/md0

# Проверка на ошибки
mdadm --query /dev/sda1
----

=== Восстановление после сбоев

[source,bash]
----
# Остановка массива
mdadm --stop /dev/md0

# Принудительная сборка
mdadm --assemble --force /dev/md0 /dev/sda1 /dev/sdb1

# Ресинхронизация
mdadm --readwrite /dev/md0
----

== Дополнительные ресурсы

* **Man страница**: `man mdadm`
* **Документация ядра**: https://raid.wiki.kernel.org/
* **Официальный сайт**: https://www.kernel.org/pub/linux/utils/raid/mdadm/

== Версии

* **mdadm**: 4.4+ (Debian Bookworm), 4.4+ (Debian Trixie)
* **Linux kernel**: 4.4+ с поддержкой MD
