= rpi-image-gen - Детальная схема конвейера построения
:author: rpi-image-gen scheme analysis
:toc: left
:toclevels: 4
:sectlinks:
:sectanchors:

link:README.md[← К схеме проекта]

== Обзор конвейера

rpi-image-gen использует 6-этапный конвейер построения образов ОС Raspberry Pi. Каждый этап имеет четко определенные входные данные, процессы и выходные артефакты.

[blockdiag]
----
blockdiag {
   // Этапы конвейера
   User -> "1. Инициализация" -> "2. Параметры" -> "3. Слои" -> "4. Подготовка" -> "5. Файловая система" -> "6. Образы" -> "7. Развертывание" -> Image;

   "1. Инициализация" [label = "1. Init\n(1-2 сек)"];
   "2. Параметры" [label = "2. Config\n(2-5 сек)"];
   "3. Слои" [label = "3. Layers\n(3-10 сек)"];
   "4. Подготовка" [label = "4. Prepare\n(5-15 сек)"];
   "5. Файловая система" [label = "5. Filesystem\n(30 сек-10 мин)"];
   "6. Образы" [label = "6. Images\n(1-5 мин)"];
   "7. Развертывание" [label = "7. Deploy\n(1-2 сек)"];

   // Основные инструменты
   group {
      label = "Инструменты";
      color = "#LightBlue";

      "mmdebstrap" [label = "mmdebstrap\n(файловая система)"];
      "genimage" [label = "genimage\n(дисковые образы)"];
      "podman" [label = "podman\n(изоляция)"];
      "runner" [label = "runner\n(хуки)"];
   }

   "5. Файловая система" -> "mmdebstrap";
   "6. Образы" -> "genimage";
   "mmdebstrap" -> "podman";
   "genimage" -> "podman";
   "layer-hooks" -> "runner";
}
----

== Этап 1: Инициализация (Initialization)

=== Цель этапа
Подготовка окружения и проверка зависимостей перед запуском конвейера.

=== Входные данные
- CLI параметры
- Системные переменные окружения
- Файл зависимостей `depends`

=== Процессы
1. **Инициализация Python модулей** (`bin/ig`)
2. **Разбор командной строки** (`lib/cli.sh`)
3. **Инициализация контекста** (`lib/common.sh`)
4. **Проверка зависимостей** (`lib/dependencies.sh`)
5. **Установка путей поиска** (`rpi-image-gen`)

=== Выходные данные
- Контекст выполнения (ctx)
- Переменные окружения
- Временные каталоги

=== Время выполнения
1-2 секунды

=== Используемые файлы
- `bin/ig` - основной Python движок
- `lib/cli.sh` - обработка CLI
- `lib/common.sh` - общие функции
- `lib/dependencies.sh` - проверка зависимостей
- `rpi-image-gen` - главный скрипт

== Этап 2: Сборка параметров (Parameter Assembly)

=== Цель этапа
Обработка конфигурационных файлов и установление параметров сборки.

=== Входные данные
- Конфигурационный файл YAML
- Переменные окружения IGconf_*
- CLI переопределения

=== Процессы
1. **Чтение конфигурации** (`config/*.yaml`)
2. **Обработка конфигурации** (`bin/ig config`)
3. **Python обработка** (`site/config_loader.py`)
4. **Создание overrides** (`rpi-image-gen`)

=== Выходные данные
- Обработанная конфигурация (`${ctx[IGENVF]}`)
- Переменные overrides (`${ctx[OVRF]}`)
- Санитизированные параметры

=== Время выполнения
2-5 секунд

=== Используемые файлы
- `config/*.yaml` - конфигурационные файлы
- `bin/ig` - Python движок
- `site/config_loader.py` - загрузчик конфигурации
- `rpi-image-gen` - обработка параметров

== Этап 3: Обработка слоев (Layer Processing)

=== Цель этапа
Сбор, валидация и упорядочивание всех слоев для сборки.

=== Входные данные
- Конфигурация с указанием слоев
- Каталоги слоев (LAYER_PATH)
- Переменные окружения

=== Процессы
1. **Сбор слоев из конфига** (`layer/*/*.yaml`)
2. **Загрузка device слоев** (`device/*/*.yaml`)
3. **Валидация слоев** (`bin/ig layer`)
4. **Построение графа зависимостей** (`site/layer_manager.py`)
5. **Расширение переменных** (`rpi-image-gen`)

=== Выходные данные
- Список слоев (`${ctx[LAYER_ORDER]}`)
- Финальные переменные (`${ctx[FINALENV]}`)
- Граф зависимостей

=== Время выполнения
3-10 секунд

=== Используемые файлы
- `layer/*/*.yaml` - определения слоев
- `device/*/*.yaml` - конфигурации устройств
- `bin/ig` - Python движок
- `site/layer_manager.py` - менеджер слоев
- `rpi-image-gen` - обработка слоев

== Этап 4: Подготовка сборки (Build Preparation)

=== Цель этапа
Настройка окружения сборки и подготовка команд bdebstrap.

=== Входные данные
- Список слоев
- Финальные переменные
- Системные пути

=== Процессы
1. **Подготовка окружения** (`scripts/*.sh`)
2. **Сбор mmdebstrap конфигов** (`layer/*/*.yaml`)
3. **Сборка команд bdebstrap** (`site/config_loader.py`)
4. **Создание директорий** (`rpi-image-gen`)
5. **Настройка APT** (`keydir/*`)

=== Выходные данные
- Конфигурация bdebstrap (`${ctx[ENV_BDEBSTRAP]}`)
- Рабочие директории
- Настроенное окружение

=== Время выполнения
5-15 секунд

=== Используемые файлы
- `scripts/*.sh` - функциональные хуки
- `layer/*/*.yaml` - конфигурации слоев
- `site/config_loader.py` - загрузчик конфигурации
- `rpi-image-gen` - подготовка сборки
- `keydir/*` - криптографические ключи

== Этап 5: Генерация файловой системы (Filesystem Generation)

=== Цель этапа
Создание корневой файловой системы с помощью bdebstrap.

=== Входные данные
- Конфигурация bdebstrap
- Слои и их зависимости
- Хуки для выполнения

=== Процессы
1. **Pre-build хуки** (`layer-hooks/pre-build.sh`)
2. **Выполнение bdebstrap** (`bin/runner`)
3. **Этапы сборки** (`scripts/*.sh`)
4. **bdebstrap хуки** (`layer-hooks/bdebstrap/*.sh`)
5. **Применение overlays** (`rpi-image-gen`)
6. **Post-build хуки** (`layer-hooks/post-build.sh`)
7. **SBOM генерация** (`site/sbom_generator.py`)

=== Выходные данные
- Корневая файловая система
- Software Bill of Materials
- Логи сборки

=== Время выполнения
30 секунд - 10 минут

=== Используемые файлы
- `layer-hooks/pre-build.sh` - pre-build хуки
- `bin/runner` - исполнитель скриптов
- `scripts/*.sh` - этапы сборки
- `layer-hooks/bdebstrap/*.sh` - хуки этапов
- `rpi-image-gen` - применение overlays
- `layer-hooks/post-build.sh` - post-build хуки
- `site/sbom_generator.py` - генератор SBOM

== Этап 6: Генерация образов (Image Generation)

=== Цель этапа
Создание дисковых образов из файловой системы.

=== Входные данные
- Корневая файловая система
- Конфигурация образов
- Хуки для обработки

=== Процессы
1. **Pre-image хуки** (`layer-hooks/pre-image.sh`)
2. **Конфигурация genimage** (`image/*/*.cfg`)
3. **Выполнение genimage** (`rpi-image-gen`)
4. **Post-image хуки** (`layer-hooks/post-image.sh`)

=== Выходные данные
- Дисковые образы (.img)
- Файлы метаданных (.json)
- Логи создания образов

=== Время выполнения
1-5 минут

=== Используемые файлы
- `layer-hooks/pre-image.sh` - pre-image хуки
- `image/*/*.cfg` - конфигурация genimage
- `rpi-image-gen` - выполнение genimage
- `layer-hooks/post-image.sh` - post-image хуки

== Этап 7: Развертывание (Deployment)

=== Цель этапа
Установка готовых артефактов для распространения.

=== Входные данные
- Дисковые образы
- Файлы метаданных
- SBOM файлы

=== Процессы
1. **Deploy хуки** (`scripts/deploy.sh`)
2. **Установка файлов** (`rpi-image-gen`)

=== Выходные данные
- Сжатые образы
- Установленные файлы
- Манифесты развертывания

=== Время выполнения
1-2 секунды

=== Используемые файлы
- `scripts/deploy.sh` - deploy хуки
- `rpi-image-gen` - установка файлов

== Дополнительные команды

=== Команда `config`
**Конвейер**: parameter_assembly → CLI обработка

=== Команда `layer`
**Конвейер**: parameter_assembly → collect_layers → CLI команды

=== Команда `metadata`
**Конвейер**: parameter_assembly → CLI обработка

=== Команда `clean`
**Конвейер**: parameter_assembly → collect_layers → Очистка

== Временные характеристики

[cols="1,1,1,1,1,1", options="header"]
|===
| Этап | Время | CPU | RAM | Disk | Network
| Инициализация | 1-2 сек | Низкий | Низкий | Низкий | Средний
| Параметры | 2-5 сек | Средний | Средний | Средний | Низкий
| Слои | 3-10 сек | Средний | Средний | Средний | Низкий
| Подготовка | 5-15 сек | Средний | Средний | Средний | Средний
| ФС | 30 сек-10 мин | Высокий | Высокий | Высокий | Высокий
| Образы | 1-5 мин | Высокий | Средний | Высокий | Низкий
| Deploy | 1-2 сек | Низкий | Низкий | Средний | Низкий
|===

== Параллельная обработка

=== Одновременное выполнение
- **templates/**: Генерация файлов параллельно с основным конвейером
- **test/**: Валидация на каждом этапе параллельно
- **layer-hooks/**: Несколько хуков могут выполняться параллельно
- **scripts/**: Некоторые скрипты могут работать асинхронно

=== Зависимости между этапами
1. **Последовательные**: 1 → 2 → 3 → 4 → 5 → 6 → 7
2. **Условные**: Этапы 5-7 могут пропускаться по флагам
3. **Итеративные**: Валидация может требовать повторного выполнения

== Критические пути

=== Быстрый путь
Инициализация → Параметры → Слои → Подготовка → (Пропуск ФС) → Образы → Развертывание

=== Полный путь
Инициализация → Параметры → Слои → Подготовка → Файловая система → Образы → Развертывание

=== Отладочный путь
Каждый этап с интерактивным режимом (INTERACTIVE=y)

== Мониторинг и логи

=== Ключевые метрики
- Время выполнения каждого этапа
- Объем данных на каждом этапе
- Количество ошибок в логах
- Использование ресурсов

=== Логи
- `/tmp/ig.log` - основной лог
- `/tmp/ig.env` - переменные окружения
- `/tmp/layers.order` - порядок слоев
- `/tmp/final.env` - финальные переменные

=== Мониторинг ресурсов
```bash
# Мониторинг CPU и памяти
watch -n 1 'ps aux | grep -E "(bdebstrap|mmdebstrap|genimage)" | grep -v grep'

# Мониторинг дискового пространства
watch -n 5 'df -h; echo; du -sh work/'

# Мониторинг сети
watch -n 5 'ss -tuln | grep LISTEN'
```

== Заключение

Детальная схема конвейера показывает, что rpi-image-gen использует модульную архитектуру с четким разделением ответственности. Каждый этап имеет определенные входы, процессы и выходы, что обеспечивает предсказуемость и надежность сборки.
