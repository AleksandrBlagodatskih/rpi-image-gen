#!/bin/bash
# AppArmor Status Script
# Provides comprehensive status information about AppArmor

echo "=== AppArmor Security Status ==="
echo

# Check if AppArmor is enabled in kernel
echo "1. Kernel AppArmor Support:"
if grep -q "apparmor=1" /proc/cmdline 2>/dev/null; then
    echo "   ✅ AppArmor enabled in kernel boot parameters"
else
    echo "   ❌ AppArmor not enabled in kernel (apparmor=1 missing from cmdline)"
fi

# Check if apparmor service is running
echo
echo "2. AppArmor Service:"
if systemctl is-active --quiet apparmor 2>/dev/null; then
    echo "   ✅ apparmor service is active"
else
    echo "   ⚠️  apparmor service is not active"
fi

# Check apparmor-utils availability
echo
echo "3. AppArmor Utilities:"
for util in aa-status aa-enforce aa-complain; do
    if command -v "$util" >/dev/null 2>&1; then
        echo "   ✅ $util available"
    else
        echo "   ❌ $util not available"
    fi
done

# Show loaded profiles
echo
echo "4. Loaded AppArmor Profiles:"
if command -v aa-status >/dev/null 2>&1; then
    aa-status 2>/dev/null || echo "   Unable to get profile status"
else
    echo "   aa-status not available"
fi

# Check configuration files
echo
echo "5. Configuration Files:"
config_files=(
    "/etc/apparmor.d/"
    "/etc/apparmor/"
)

for config in "${config_files[@]}"; do
    if [ -e "$config" ]; then
        echo "   ✅ $config exists"
    else
        echo "   ❌ $config not found"
    fi
done

# Check recent audit logs
echo
echo "6. Recent AppArmor Events:"
if [ -f /var/log/audit/audit.log ]; then
    recent_events=$(grep -c "apparmor" /var/log/audit/audit.log 2>/dev/null || echo "0")
    echo "   📊 Recent audit events: $recent_events"

    if [ "$recent_events" -gt 0 ]; then
        echo "   📋 Last 3 events:"
        grep "apparmor" /var/log/audit/audit.log 2>/dev/null | tail -3 | sed 's/^/      /'
    fi
elif [ -f /var/log/kern.log ]; then
    recent_events=$(grep -c "apparmor" /var/log/kern.log 2>/dev/null || echo "0")
    echo "   📊 Recent kernel events: $recent_events"
else
    echo "   📭 No audit logs available"
fi

echo
echo "=== Recommendations ==="
echo "• Run 'aa-enforce /etc/apparmor.d/*' to set all profiles to enforce mode"
echo "• Run 'aa-complain /etc/apparmor.d/*' to set all profiles to complain mode"
echo "• Check logs: tail -f /var/log/audit/audit.log | grep apparmor"
echo "• Monitor violations: aa-notify -p"
